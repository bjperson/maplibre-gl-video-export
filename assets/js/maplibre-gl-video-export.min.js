var VideoExportControl=function(){"use strict";var e="undefined"!=typeof document?document.currentScript:null;function t(e,t,o,i){const n=(o-e)*Math.PI/180,r=t*Math.PI/180,a=i*Math.PI/180,s=Math.sin(n)*Math.cos(a),l=Math.cos(r)*Math.sin(a)-Math.sin(r)*Math.cos(a)*Math.cos(n);return(180*Math.atan2(s,l)/Math.PI+360)%360}function o(e,t,o,i){const n=(i-t)*Math.PI/180,r=(o-e)*Math.PI/180,a=t*Math.PI/180,s=i*Math.PI/180,l=Math.sin(n/2)*Math.sin(n/2)+Math.cos(a)*Math.cos(s)*Math.sin(r/2)*Math.sin(r/2);return 6371*(2*Math.atan2(Math.sqrt(l),Math.sqrt(1-l)))}function i(e,t,o,i,n,r=.5){const a=n*n,s=a*n,l=(o[0]-e[0])*r,c=(i[0]-t[0])*r,d=(2*t[0]-2*o[0]+l+c)*s+(-3*t[0]+3*o[0]-2*l-c)*a+l*n+t[0],p=(o[1]-e[1])*r,h=(i[1]-t[1])*r;return[d,(2*t[1]-2*o[1]+p+h)*s+(-3*t[1]+3*o[1]-2*p-h)*a+p*n+t[1]]}function n(e,t=.01){if(!e||e.length<2)return e;const i=[e[0]];let n=0;for(let r=1;r<e.length;r++){const[a,s]=e[r-1],[l,c]=e[r],d=o(a,s,l,c);for(n+=d;n>=t;){const e=1-(n-t)/d,o=a+e*(l-a),r=s+e*(c-s);i.push([o,r]),n-=t}}const r=e[e.length-1],a=i[i.length-1];return r[0]===a[0]&&r[1]===a[1]||i.push(r),i}function r(e,t=.01,o=.3){if(!e||e.length<2)return e;if(2===e.length)return n(e,t);const r=[];for(let t=0;t<e.length-1;t++){const n=e[Math.max(0,t-1)],a=e[t],s=e[t+1],l=e[Math.min(e.length-1,t+2)];for(let e=0;e<30;e++){const t=i(n,a,s,l,e/30,o);r.push(t)}}return r.push(e[e.length-1]),n(r,t)}function a(e,t){if(!t)return null;let o=[];if("FeatureCollection"===t.type&&t.features)o=t.features.map(e=>({center:e.geometry.coordinates}));else{if(!Array.isArray(t))return null;o=t}if(0===o.length)return null;if(1===o.length)return{center:o[0].center,zoom:e.getZoom()};let i=1/0,n=1/0,r=-1/0,a=-1/0;o.forEach(e=>{const[t,o]=e.center;i=Math.min(i,t),r=Math.max(r,t),n=Math.min(n,o),a=Math.max(a,o)});const s=(i+r)/2,l=(n+a)/2,c=[[i,n],[r,a]],d=e.getCanvas(),p=.15*Math.min(d.width,d.height),h=e.cameraForBounds(c,{padding:{top:p,bottom:p,left:p,right:p}});return{center:[s,l],zoom:h?h.zoom:e.getZoom()}}const s=e=>new Promise(t=>setTimeout(t,e)),l=["all",["==",["geometry-type"],"LineString"],["in",["get","class"],["literal",["motorway","trunk","primary","secondary","tertiary","minor","service","track","path"]]]],c=[{angle:0,name:"N"},{angle:45,name:"NE"},{angle:90,name:"E"},{angle:135,name:"SE"},{angle:180,name:"S"},{angle:225,name:"SW"},{angle:270,name:"W"},{angle:315,name:"NW"}],d=e=>{for(;e>180;)e-=360;for(;e<-180;)e+=360;return e},p=e=>e&&Array.isArray(e)&&"number"==typeof e[0]&&"number"==typeof e[1],h=(e,t)=>{if(e.map2)try{e.map2.remove()}catch(e){}e.div2&&e.div2.parentNode&&e.div2.parentNode.removeChild(e.div2);try{t.getLayer("drone-followed-segments-layer")&&t.removeLayer("drone-followed-segments-layer"),t.getSource("drone-followed-segments")&&t.removeSource("drone-followed-segments")}catch(e){}},u=(e,t,o,i)=>{const n=e[0],r=e[1],a=t[0],s=t[1],l=o[0],c=o[1],d=i[0],p=i[1],h=(n-a)*(c-p)-(r-s)*(l-d);if(Math.abs(h)<1e-10)return null;const u=((n-l)*(c-p)-(r-c)*(l-d))/h,m=-((n-a)*(r-c)-(r-s)*(n-l))/h;if(u>=0&&u<=1&&m>=0&&m<=1){const e=n+u*(a-n)-n,t=r+u*(s-r)-r;return Math.sqrt(e*e+t*t)}return null};class m{constructor(e={}){this.maxBounds=e.maxBounds||null,this.minZoom=void 0!==e.minZoom?e.minZoom:null,this.maxZoom=void 0!==e.maxZoom?e.maxZoom:null,this.strictBounds=e.strictBounds||!1}isWithinBounds(e){if(!this.maxBounds)return!0;const t=Array.isArray(e)?e[0]:e.lng,o=Array.isArray(e)?e[1]:e.lat,[[i,n],[r,a]]=this.maxBounds;return t>=i&&t<=r&&o>=n&&o<=a}constrainCenter(e){if(!this.maxBounds)return e;const t=Array.isArray(e),o=t?e[0]:e.lng,i=t?e[1]:e.lat,[[n,r],[a,s]]=this.maxBounds,l=Math.max(n,Math.min(a,o)),c=Math.max(r,Math.min(s,i));return t?[l,c]:{lng:l,lat:c,...e.toArray?{toArray:()=>[l,c]}:{}}}isWithinZoomLimits(e){return!(null!==this.minZoom&&e<this.minZoom)&&!(null!==this.maxZoom&&e>this.maxZoom)}constrainZoom(e){return null!==this.minZoom&&e<this.minZoom?this.minZoom:null!==this.maxZoom&&e>this.maxZoom?this.maxZoom:e}applyCameraConstraints(e){const t={...e};return void 0!==e.center&&null!==e.center&&(t.center=this.constrainCenter(e.center)),void 0!==e.zoom&&null!==e.zoom&&(t.zoom=this.constrainZoom(e.zoom)),t}calculateSafePath(e,t,o=10){const i=[],n=Array.isArray(e)?e[0]:e.lng,r=Array.isArray(e)?e[1]:e.lat,a=Array.isArray(t)?t[0]:t.lng,s=Array.isArray(t)?t[1]:t.lat;for(let e=0;e<=o;e++){const t=e/o,l=n+(a-n)*t,c=r+(s-r)*t;this.strictBounds?i.push(this.constrainCenter([l,c])):i.push([l,c])}return i}validateCurrentView(e){const t=[],o=e.getCenter().toArray(),i=e.getZoom();return this.isWithinBounds(o)||t.push(`Center ${o} is outside bounds`),this.isWithinZoomLimits(i)||t.push(`Zoom ${i} is outside limits [${this.minZoom}, ${this.maxZoom}]`),{valid:0===t.length,issues:t}}getSafeBounds(e){if(!this.maxBounds)return e.getBounds();const[[t,o],[i,n]]=this.maxBounds;return{getWest:()=>t,getEast:()=>i,getSouth:()=>o,getNorth:()=>n,getCenter:()=>[(t+i)/2,(o+n)/2]}}wrapAnimation(e){return async(t,o)=>{const i=t.flyTo.bind(t),n=t.easeTo.bind(t),r=t.jumpTo.bind(t);t.flyTo=e=>i(this.applyCameraConstraints(e)),t.easeTo=e=>n(this.applyCameraConstraints(e)),t.jumpTo=e=>r(this.applyCameraConstraints(e));try{await e(t,o)}finally{t.flyTo=i,t.easeTo=n,t.jumpTo=r}}}}async function g(e,t,o,{checkAbort:i,updateStatus:n}={}){const r=t.name||"waypoint";n&&n(`Flying to ${r}...`);const a={center:t.center,duration:o,essential:!0};if(void 0!==t.zoom&&(a.zoom=t.zoom),void 0!==t.bearing&&(a.bearing=t.bearing),void 0!==t.pitch&&(a.pitch=t.pitch),0===o||o<10){const o={center:t.center};void 0!==t.zoom&&(o.zoom=t.zoom),void 0!==t.bearing&&(o.bearing=t.bearing),void 0!==t.pitch&&(o.pitch=t.pitch),e.jumpTo(o)}else e.flyTo(a),await e.once("moveend");i&&i(),t.duration&&(n&&n(`At ${r} (pausing ${t.duration}ms)...`),await s(t.duration),i&&i())}const f=async(e,t,{checkAbort:o,degreesPerStep:i=2,pitch:n,onStep:r}={})=>{const a=(e,t)=>{let o=e+t;return o>180&&(o=o-180-180),o},s=360/i,l=t/s;let c=e.getBearing();for(let t=0;t<s;t++){t%20==0&&o&&o(),c=a(c,i);const d=t/s;let p;void 0!==n&&("number"==typeof n?p=n:void 0!==n.from&&void 0!==n.to&&(p=n.from+(n.to-n.from)*d));let h={bearing:c,duration:l,essential:!0,easing:e=>e};if(void 0!==p&&(h.pitch=p),r){const e=r(c,d);e&&"object"==typeof e&&(h={...h,...e})}e.easeTo(h),await e.once("moveend")}o&&o()},y=new WeakMap;class b{constructor(e){this.map=e,this.capabilities=this._detectCapabilities()}_detectCapabilities(e=!1){if(!e&&y.has(this.map))return y.get(this.map);const t={hasTerrain:!1,hasHillshade:!1,has3DBuildings:!1,hasRasterLayers:!1,hasVectorLayers:!1,hasRoads:!1,hasRailways:!1,hasWaterways:!1,hasWater:!1,hasPlaces:!1,hasLanduse:!1,hasGlyphs:!1,hasSprites:!1,bounds:null,center:this.map.getCenter(),zoom:this.map.getZoom(),maxZoomData:14,style:null,vectorSources:{roads:{sourceId:null,sourceLayer:null},railways:{sourceId:null,sourceLayer:null},waterways:{sourceId:null,sourceLayer:null}}},o=this.map.getStyle(),i=o?.sources||{};Object.values(i).forEach(e=>{"raster-dem"===e.type&&(t.hasTerrain=!0),e.maxzoom&&e.maxzoom>t.maxZoomData&&(t.maxZoomData=e.maxzoom)}),o?.glyphs&&(t.hasGlyphs=!0),o?.sprite&&(t.hasSprites=!0);const n=new Set,r=o?.layers||[];if(r.forEach(e=>{const o=e.id.toLowerCase(),i=e["source-layer"];i&&n.add(i.toLowerCase()),(o.includes("hillshad")||"hillshade"===e.type)&&(t.hasHillshade=!0),o.includes("building")&&"fill-extrusion"===e.type&&(t.has3DBuildings=!0),"raster"===e.type&&(t.hasRasterLayers=!0),["fill","line","symbol","circle"].includes(e.type)&&(t.hasVectorLayers=!0)}),console.log("üó∫Ô∏è Found source-layers:",Array.from(n)),n.has("transportation")||n.has("road")){t.hasRoads=!0,t.hasRailways=!0;for(const e of r){const o=e["source-layer"];if("transportation"===o||"road"===o){const n=e.source,r=i[n];if(r&&"vector"===r.type){t.vectorSources.roads.sourceId=n,t.vectorSources.roads.sourceLayer=o,t.vectorSources.railways.sourceId=n,t.vectorSources.railways.sourceLayer=o;break}}}}if(n.has("waterway")){t.hasWaterways=!0;for(const e of r){const o=e["source-layer"];if("waterway"===o){const n=e.source,r=i[n];if(r&&"vector"===r.type){t.vectorSources.waterways.sourceId=n,t.vectorSources.waterways.sourceLayer=o;break}}}}n.has("water")&&(t.hasWater=!0),(n.has("place")||n.has("place_label"))&&(t.hasPlaces=!0),(n.has("landuse")||n.has("landcover"))&&(t.hasLanduse=!0),n.has("building");try{t.bounds=this.map.getBounds()}catch(e){}const a=o?.sprite||"";return a.includes("satellite")||a.includes("aerial")?t.style="satellite":a.includes("outdoors")||a.includes("terrain")?t.style="outdoors":a.includes("dark")?t.style="dark":t.style="standard",console.log("üîç Detected capabilities:",t),y.set(this.map,t),t}static async _positionHelperMapAhead(e,t,o,i){try{const n=o*Math.PI/180,r=t[0]+i*Math.sin(n),a=t[1]+i*Math.cos(n),s=.5*i,l=Math.min(t[0],r)-s,c=Math.max(t[0],r)+s,d=Math.min(t[1],a)-s,p=Math.max(t[1],a)+s;e.fitBounds([[l,d],[c,p]],{linear:!0,padding:0,duration:0}),await new Promise(e=>setTimeout(e,200)),console.log(`[HelperMap] Positioned map2 with bbox: [${l.toFixed(6)}, ${d.toFixed(6)}] to [${c.toFixed(6)}, ${p.toFixed(6)}]`)}catch(e){console.error("[HelperMap] Failed to position helper map:",e)}}async _findInterestingPoints(){const e=[],t=this.map.getBounds();if(!t)return e;const o=t.getNorthEast(),i=t.getSouthWest(),n=t.getCenter();if(e.push(n,o,i,[o.lng,i.lat],[i.lng,o.lat]),this.capabilities.hasTerrain){const t=5;for(let n=0;n<t;n++)for(let r=0;r<t;r++){const a=i.lng+(o.lng-i.lng)*(n/t),s=i.lat+(o.lat-i.lat)*(r/t);e.push([a,s])}}return e}createAdaptiveAnimation(e,t={}){const o=t.duration||3e4;return{setup:null,animation:async(e,t)=>{const{updateStatus:i,checkAbort:n}=t;console.log("üé¨ Creating adaptive animation for",o,"ms");const r=[];r.push(this._createOpeningShot()),this.capabilities.hasTerrain&&r.push(this._createTerrainShowcase()),this.capabilities.has3DBuildings&&r.push(this._createBuildingFlythrough()),r.push(this._createExplorationSequence()),r.push(this._createCinematicSequence()),r.push(this._createClosingShot());const a=o/r.length;for(const e of r)await e(t,a),n();i("‚úÖ Animation complete!")}}}_createOpeningShot(){return async(e,t)=>{const{updateStatus:o,checkAbort:i}=e;o("üåç Opening shot...");const n=this.map.getZoom(),r=Math.max(n-4,1);this.map.easeTo({zoom:r,pitch:0,bearing:0,duration:.6*t,essential:!0}),await this.map.once("moveend"),i(),this.map.easeTo({zoom:n-2,duration:.4*t,essential:!0}),await this.map.once("moveend"),i()}}_createTerrainShowcase(){return async(e,t)=>{const{updateStatus:o,checkAbort:i}=e;if(o("üèîÔ∏è Mountain vista..."),!this.map.getTerrain()){const e=this.map.getStyle()?.sources||{},t=Object.keys(e).find(t=>"raster-dem"===e[t].type);t&&(this.map.setTerrain({source:t,exaggeration:1.5}),await s(500),i())}const n=await this._findInterestingPoints();for(let e=0;e<Math.min(3,n.length);e++)this.map.flyTo({center:n[e],zoom:14,pitch:75,bearing:120*e,duration:t/3,essential:!0}),await this.map.once("moveend"),i()}}_createBuildingFlythrough(){return async(e,t)=>{const{updateStatus:o,checkAbort:i}=e;o("üè¢ City flythrough..."),this.map.easeTo({pitch:60,zoom:this.map.getZoom()+1,duration:.3*t,essential:!0}),await this.map.once("moveend"),i(),this.map.easeTo({bearing:this.map.getBearing()+180,duration:.7*t,essential:!0}),await this.map.once("moveend"),i()}}_createExplorationSequence(){return async(e,t)=>{const{updateStatus:o,checkAbort:i}=e;o("üîç Exploring area...");const n=this.map.getBounds();if(!n)return void await s(t);const r=n.getNorthEast(),a=n.getSouthWest(),l=n.getCenter(),c=[l,[.7*r.lng+.3*a.lng,.7*r.lat+.3*a.lat],[.3*r.lng+.7*a.lng,.3*r.lat+.7*a.lat],l],d=t/c.length;for(let e=0;e<c.length;e++)this.map.flyTo({center:c[e],zoom:this.map.getZoom()+(e%2?.5:-.5),bearing:45*e,pitch:20+10*e,duration:d,essential:!0}),await this.map.once("moveend"),i()}}_createCinematicSequence(){return async(e,t)=>{const{updateStatus:o,checkAbort:i}=e;o("üé¨ Cinematic view...");const n=this.map.getBearing();this.map.easeTo({bearing:n+360,duration:.6*t,essential:!0,easing:e=>e*(2-e)}),await this.map.once("moveend"),i(),this.map.easeTo({pitch:45,zoom:this.map.getZoom()+1,duration:.2*t,essential:!0}),await this.map.once("moveend"),i(),this.map.easeTo({pitch:0,zoom:this.map.getZoom()-1,duration:.2*t,essential:!0}),await this.map.once("moveend"),i()}}_createClosingShot(){return async(e,t)=>{const{updateStatus:o,checkAbort:i}=e;o("üé• Closing shot...");const n={center:this.capabilities.center,zoom:this.capabilities.zoom,bearing:0,pitch:0};this.map.flyTo({...n,zoom:n.zoom-2,pitch:30,bearing:-30,duration:.7*t,essential:!0}),await this.map.once("moveend"),i(),this.map.easeTo({...n,duration:.3*t,essential:!0}),await this.map.once("moveend"),i()}}}function v(e,t=!1){try{const o=e.getStyle();if(!o)return console.warn("[HelperMap] No style found"),null;let i=t?null:y.get(e);if(!i){const o=new b(e);i=t?o._detectCapabilities(!0):o.capabilities}const n=o.sources||{},r=new Set;if(Object.values(i.vectorSources).forEach(e=>{e.sourceId&&r.add(e.sourceId)}),0===r.size)return console.warn("[HelperMap] No vector sources found for roads/railways/waterways"),console.warn("[HelperMap] Available source-layers:",Array.from(new Set((o.layers||[]).filter(e=>e["source-layer"]).map(e=>e["source-layer"])))),null;const a={};r.forEach(e=>{const t=n[e];t&&"vector"===t.type&&(a[e]={type:t.type,...t.tiles&&{tiles:t.tiles},...t.url&&{url:t.url},...void 0!==t.minzoom&&{minzoom:t.minzoom},...void 0!==t.maxzoom&&{maxzoom:t.maxzoom},...t.attribution&&{attribution:t.attribution},...t.bounds&&{bounds:t.bounds}})}),console.log(`[HelperMap] Created minimal style with ${Object.keys(a).length} vector source(s):`,Object.keys(a)),console.log("[HelperMap] Available features:",{roads:i.vectorSources.roads.sourceLayer||"none",railways:i.vectorSources.railways.sourceLayer||"none",waterways:i.vectorSources.waterways.sourceLayer||"none"});const s=[];i.vectorSources.roads.sourceId&&i.vectorSources.roads.sourceLayer&&s.push({id:"helper-roads",type:"line",source:i.vectorSources.roads.sourceId,"source-layer":i.vectorSources.roads.sourceLayer,paint:{"line-opacity":0,"line-width":0}}),i.vectorSources.railways.sourceId&&i.vectorSources.railways.sourceLayer&&s.push({id:"helper-railways",type:"line",source:i.vectorSources.railways.sourceId,"source-layer":i.vectorSources.railways.sourceLayer,paint:{"line-opacity":0,"line-width":0}}),i.vectorSources.waterways.sourceId&&i.vectorSources.waterways.sourceLayer&&s.push({id:"helper-waterways",type:"line",source:i.vectorSources.waterways.sourceId,"source-layer":i.vectorSources.waterways.sourceLayer,paint:{"line-opacity":0,"line-width":0}}),console.log(`[HelperMap] Created ${s.length} invisible layer(s) to force feature loading`);const l={version:8,sources:a,layers:s,glyphs:o.glyphs,sprite:o.sprite,id:o.id||"helper-map"};return console.log("[HelperMap] Minimal style.json:",l),{vectorSources:i.vectorSources,style:l}}catch(e){return console.error("[HelperMap] Failed to extract minimal style:",e),null}}function w(e,t,i,n,r={}){const{prefer:a=null,searchRadius:s=.002}=r,l=a?Array.isArray(a)?a:[a]:[];console.log("[RoadSearch] Searching nearby roads in cardinal directions..."+(l.length?` (prefer: ${l.join(", ")})`:""));const p=c.map(e=>e.angle),h=111*s;let u=null,m=1/0;for(const r of p){const a=r*Math.PI/180,c=e[0]+s*Math.sin(a),p=e[1]+s*Math.cos(a);for(const a of n){if(!a.geometry||!a.geometry.coordinates)continue;if(i.has(a.id))continue;const n=a.geometry.coordinates[0],s=a.geometry.coordinates[a.geometry.coordinates.length-1],g=o(e[0],e[1],n[0],n[1]),f=o(e[0],e[1],s[0],s[1]),y=Math.min(g,f),b=o(c,p,n[0],n[1]),v=o(c,p,s[0],s[1]),w=Math.min(b,v);if(w>h)continue;const x=Math.abs(d(r-t));let _=w+x/180*.001;const S=a.properties?.class||"unknown";if(l.length>0&&l.includes(S)&&(_*=.5,console.log(`[RoadSearch]   ‚ú® Found preferred ${S} at ${r}¬∞ (bonus applied)`)),_<m){m=_;const e=f<g;u={road:a,coords:e?[...a.geometry.coordinates].reverse():a.geometry.coordinates,reversed:e,distance:y,direction:r,bearingDiff:x}}}}if(u&&u.distance>.25&&(console.log(`[RoadSearch] ‚ö†Ô∏è Found road but too far (${(1e3*u.distance).toFixed(0)}m > 250m) - rejecting to avoid huge jump`),u=null),u){const e=u.road.properties?.class||"unknown",t=l.includes(e);console.log(`[RoadSearch] üîç Found ${t?"‚ú® preferred ":""}${e} at ${u.direction}¬∞ (${(1e3*u.distance).toFixed(0)}m away, bearing Œî${u.bearingDiff.toFixed(1)}¬∞)`)}else console.log(`[RoadSearch] No roads found within ${(1e3*h).toFixed(0)}m in any direction`);return u}const x={orbit360:async(e,{updateStatus:t,checkAbort:o},i={})=>{const n=i.duration||1e4,r=i.waypoints||null;if(r){const o=a(e,r);o&&(t("üîÑ Positioning to show all waypoints..."),e.jumpTo({center:o.center,zoom:o.zoom}),await s(500))}t("üîÑ 360¬∞ orbit...");const l=e.getBearing();e.easeTo({bearing:l+360,duration:n,essential:!0,easing:e=>e}),await e.once("moveend"),o()},zoomPulse:async(e,{updateStatus:t,checkAbort:o},i={})=>{const n=i.duration||5e3,r=i.waypoints||null;if(r){const o=a(e,r);o&&(t("üîç Positioning to show all waypoints..."),e.jumpTo({center:o.center,zoom:o.zoom}),await s(500))}t("üîç Zoom pulse...");const l=e.getZoom();e.easeTo({zoom:l+2,duration:n/2,essential:!0}),await e.once("moveend"),o(),e.easeTo({zoom:l,duration:n/2,essential:!0}),await e.once("moveend"),o()},figure8:async(e,{updateStatus:t,checkAbort:o},i={})=>{const n=i.duration||15e3,r=i.waypoints||null;if(r){const o=a(e,r);o&&(t("‚àû Positioning to show all waypoints..."),e.jumpTo({center:o.center,zoom:o.zoom}),await s(500))}t("‚àû Figure-8 pattern...");const l=e.getCenter(),c=e.getBounds();if(!c)return;const d=c.getNorthEast(),p=c.getSouthWest(),h=d.lng-p.lng,u=d.lat-p.lat,m=[[l.lng+.2*h,l.lat],[l.lng+.2*h,l.lat+.2*u],[l.lng,l.lat],[l.lng-.2*h,l.lat-.2*u],[l.lng-.2*h,l.lat],[l.lng,l.lat]];for(const t of m)e.flyTo({center:t,duration:n/m.length,essential:!0}),await e.once("moveend"),o()},spiralZoom:async(e,{updateStatus:t,checkAbort:o},i={})=>{const n=i.duration||12e3;t("üåÄ Spiral zoom...");const r=e.getZoom();for(let t=0;t<8;t++)e.easeTo({bearing:e.getBearing()+45,zoom:r+t/8*2,pitch:t/8*45,duration:n/8,essential:!0}),await e.once("moveend"),o();e.flyTo({zoom:r,bearing:0,pitch:0,duration:n/4,essential:!0}),await e.once("moveend"),o()},neighborhood:async(e,{updateStatus:t,checkAbort:o},i={})=>{const n=i.duration||25e3;t("üèòÔ∏è Exploring neighborhood...");const r=e.getCenter(),a=e.getZoom(),s=e.getBearing(),l=e.getPitch();t("üó∫Ô∏è Showing area context..."),e.flyTo({center:r,zoom:Math.max(a-3,10),bearing:0,pitch:0,duration:.15*n,essential:!0}),await e.once("moveend"),o(),t("üèòÔ∏è Neighborhood overview..."),e.flyTo({center:r,zoom:Math.min(a,14),bearing:0,pitch:35,duration:.15*n,essential:!0}),await e.once("moveend"),o(),t("üîÑ Scanning surroundings..."),e.easeTo({bearing:360,duration:.25*n,essential:!0,easing:e=>e}),await e.once("moveend"),o(),t("üîç Examining nearby area..."),e.flyTo({zoom:Math.min(a+1,16),bearing:0,pitch:45,duration:.15*n,essential:!0}),await e.once("moveend"),o(),e.easeTo({bearing:180,duration:.15*n,essential:!0}),await e.once("moveend"),o(),t("üìç Returning to property..."),e.flyTo({center:r,zoom:a,bearing:s,pitch:l,duration:.15*n,essential:!0}),await e.once("moveend"),o()},propertyShowcase:async(e,{updateStatus:t,checkAbort:o},i={})=>{const n=i.duration||2e4;t("üè° Property showcase...");const r=e.getCenter(),a=e.getZoom();t("üé¨ Opening shot..."),e.flyTo({center:r,zoom:a-2,bearing:0,pitch:60,duration:.2*n,essential:!0}),await e.once("moveend"),o(),t("üè† Focusing on property..."),e.flyTo({zoom:Math.min(a+1,17),bearing:-45,pitch:55,duration:.2*n,essential:!0}),await e.once("moveend"),o(),t("üì∏ Viewing from all angles...");const s=[0,90,180,270];for(const t of s)e.easeTo({bearing:t,duration:.12*n,essential:!0}),await e.once("moveend"),o();t("üåÖ Final view..."),e.flyTo({zoom:a,bearing:0,pitch:30,duration:.16*n,essential:!0}),await e.once("moveend"),o()},panorama:async(e,{updateStatus:t,checkAbort:o},i={})=>{const n=i.duration||15e3;t("üì∑ Panoramic view...");const r=e.getPitch();t("üé• Sweeping panorama..."),await f(e,n,{checkAbort:o,onStep:(e,t)=>({pitch:t<.5?r+2*t*(50-r):50-2*(t-.5)*(50-r)})})},exploreAround:async(e,{updateStatus:t,checkAbort:o},i={})=>{const n=i.duration||2e4;t("üß≠ Exploring surroundings...");const r=e.getCenter(),a=e.getBounds();if(!a)return;const l=a.getNorthEast(),c=a.getSouthWest(),d=.25*(l.lng-c.lng),p=.25*(l.lat-c.lat),h=[{pos:[r.lng,r.lat+p],name:"North"},{pos:[r.lng+d,r.lat],name:"East"},{pos:[r.lng,r.lat-p],name:"South"},{pos:[r.lng-d,r.lat],name:"West"}],u=n/(h.length+1);for(const i of h)t(`üß≠ Checking ${i.name}...`),e.flyTo({center:i.pos,duration:.8*u,essential:!0}),await e.once("moveend"),o(),await s(.2*u),o();t("üéØ Returning to center..."),e.flyTo({center:r,duration:u,essential:!0}),await e.once("moveend"),o()},aerialSweep:async(e,{updateStatus:t,checkAbort:o},i={})=>{const n=i.duration||15e3;t("üöÅ Aerial sweep...");const r=e.getZoom(),a=e.getPitch();let s=3;if(e.getTerrain&&e.getTerrain()){const t=e.getCenter(),o=e.getBounds(),i=o.getNorth()-o.getSouth(),n=o.getEast()-o.getWest(),r=[t,{lng:t.lng,lat:t.lat+.3*i},{lng:t.lng,lat:t.lat-.3*i},{lng:t.lng+.3*n,lat:t.lat},{lng:t.lng-.3*n,lat:t.lat},{lng:t.lng+.25*n,lat:t.lat+.25*i},{lng:t.lng-.25*n,lat:t.lat+.25*i},{lng:t.lng+.25*n,lat:t.lat-.25*i},{lng:t.lng-.25*n,lat:t.lat-.25*i}];let a=0;for(const t of r){const o=e.queryTerrainElevation(t);null!==o&&o>a&&(a=o)}if(a>0){const e=a/1e3,t=2;s=Math.max(3,2*Math.log2(e+1)+t),console.log(`üèîÔ∏è Terrain detected: max elevation ${a.toFixed(0)}m ‚Üí safe zoom ${s.toFixed(1)}`)}}t("‚¨ÜÔ∏è Rising...");const l=Math.max(r-4,s);e.easeTo({zoom:l,duration:.15*n,essential:!0}),await e.once("moveend"),o(),t("üìê Tilting view..."),e.easeTo({pitch:75,duration:.1*n,essential:!0}),await e.once("moveend"),o(),t("üåç 360¬∞ panorama..."),await f(e,.75*n,{checkAbort:o,pitch:75,onStep:(e,o)=>{if(o>=.85){const e=(o-.85)/.15,i=l+(r-l)*e,n=75+(a-75)*e;return e>.1&&t("üåÄ Descending spiral..."),{zoom:i,pitch:n}}}})},droneShot:async(e,{updateStatus:t,checkAbort:o},i={})=>{const n=i.duration||2e4;t("üõ∏ Drone takeoff...");const r=e.getZoom(),a=e.getPitch(),s=e.getBearing();t("üìà Ascending spiral...");const l=.3*n/90,c=Math.max(r-5,2);for(let t=0;t<90;t++){t%15==0&&o();const i=t/90,n=r-(r-c)*i,d=a+(65-a)*i,p=90*i;e.easeTo({zoom:n,pitch:d,bearing:s+p,duration:l,essential:!0,easing:e=>e}),await e.once("moveend")}o(),t("üåç 360¬∞ survey..."),await f(e,.4*n,{checkAbort:o,pitch:65}),t("üìâ Landing approach...");const d=.3*n/90,p=e.getBearing();for(let t=0;t<90;t++){t%15==0&&o();const i=t/90,n=c+(r-c)*i,s=65-(65-a)*i,l=p-90*i;e.easeTo({zoom:n,pitch:s,bearing:l,duration:d,essential:!0,easing:e=>e}),await e.once("moveend")}o()},orbitZoom:async(e,{updateStatus:t,checkAbort:o},i={})=>{const n=i.duration||15e3;t("üåÄ Orbit zoom...");const r=e.getZoom(),a=Math.min(r+4,18);await f(e,n,{checkAbort:o,pitch:45,onStep:(e,t)=>({zoom:r+(a-r)*t})})},waveMotion:async(e,{updateStatus:t,checkAbort:o},i={})=>{const n=i.duration||18e3;t("üåä Wave motion...");const r=e.getPitch();await f(e,n,{checkAbort:o,onStep:(e,t)=>{const o=3*t*Math.PI*2;return{pitch:r+30+30*Math.sin(o)}}})},pendulum:async(e,{updateStatus:t,checkAbort:o},i={})=>{const n=i.duration||15e3;t("‚è±Ô∏è Pendulum motion...");const r=e.getBearing(),a=e.getPitch();for(let i=0;i<3;i++)o(),t(`‚è±Ô∏è Swing ${i+1}/3...`),e.easeTo({bearing:r+60,pitch:55,duration:n/6,essential:!0,easing:e=>1-Math.cos(e*Math.PI/2)}),await e.once("moveend"),o(),await s(200),e.easeTo({bearing:r-60,pitch:55,duration:n/6,essential:!0,easing:e=>1-Math.cos(e*Math.PI/2)}),await e.once("moveend"),o(),await s(200);t("‚è±Ô∏è Settling..."),e.easeTo({bearing:r,pitch:a,duration:.15*n,essential:!0}),await e.once("moveend"),o()},spotlightScan:async(e,{updateStatus:t,checkAbort:o},i={})=>{const n=i.duration||15e3;t("üî¶ Spotlight scan...");const r=e.getZoom();await f(e,n,{checkAbort:o,pitch:50,onStep:(e,t)=>{const o=4*t*Math.PI*2;return{zoom:r+1.5*Math.sin(o)}}})},butterfly:async(e,{updateStatus:t,checkAbort:o},i={})=>{const n=i.duration||2e4;t("ü¶ã Butterfly pattern...");const r=e.getCenter(),a=e.getBounds();if(!a)return;const s=a.getNorthEast(),l=a.getSouthWest(),c=s.lng-l.lng,d=s.lat-l.lat,p=[];for(let e=0;e<16;e++){const t=e/16*Math.PI*2,o=Math.sin(t)*c*.25,i=Math.sin(2*t)/2*d*.25;p.push({pos:[r.lng+o,r.lat+i],pitch:20+40*Math.abs(i/(.25*d)),bearing:180*t/Math.PI%360})}const h=n/p.length;for(const t of p)e.flyTo({center:t.pos,pitch:t.pitch,bearing:t.bearing,duration:.9*h,essential:!0,easing:e=>e}),await e.once("moveend"),o();t("ü¶ã Returning..."),e.flyTo({center:r,pitch:e.getPitch(),bearing:0,duration:2*h,essential:!0}),await e.once("moveend"),o()},waypointTour:async(e,{updateStatus:t,checkAbort:o},i={})=>{const n=i.duration||3e4,r=i.waypoints||null;let a=[];if(r&&("FeatureCollection"===r.type&&r.features?a=r.features.map(e=>({center:e.geometry.coordinates,zoom:e.properties.zoom,bearing:e.properties.bearing,pitch:e.properties.pitch,duration:e.properties.duration,name:e.properties.name})):Array.isArray(r)&&(a=r)),0===a.length)return t("‚ö†Ô∏è No waypoints defined for tour"),void await s(2e3);t(`üéØ Starting tour of ${a.length} waypoints...`);const l=function(e,t){if(!e||0===e.length)return[];const o=e.reduce((e,t)=>e+(t.duration||0),0),i=Math.max(0,t-o),n=e.length>0?i/e.length:0;return e.map(e=>({waypoint:e,transitionDuration:n}))}(a,n);for(let i=0;i<l.length;i++){const{waypoint:n,transitionDuration:r}=l[i];await g(e,n,r,{checkAbort:o,updateStatus:e=>t(`üìç ${i+1}/${l.length}: ${e}`)})}t("‚úÖ Tour complete!")},terrainFollowing:async(e,{updateStatus:t,checkAbort:o},i={})=>{const n=i.duration||2e4;if(t("üöÅ Terrain following flight..."),!e.getTerrain||!e.getTerrain())return t("‚ö†Ô∏è No 3D terrain - using standard rotation"),void await x.orbit360(e,{updateStatus:t,checkAbort:o},i);const r=e.getBearing(),a=e.getPitch(),s=e.getCenter();t("üìê Setting terrain view angle..."),e.easeTo({pitch:60,duration:1e3,essential:!0}),await e.once("moveend"),o();const l=120,c=.95*n/l,d=[];t("üèîÔ∏è Following terrain contours...");for(let i=0;i<l;i++){i%20==0&&o();const n=i/l,a=r+3*i,p=e.queryTerrainElevation(s);let h=e.getZoom();if(null!==p&&p>=0){const e=17,t=1.5*(p/1e3);h=Math.max(10,e-t)}d.push(h),d.length>5&&d.shift();const u=d.reduce((e,t)=>e+t,0)/d.length;if(e.easeTo({bearing:a,zoom:u,pitch:60,duration:c,essential:!0,easing:e=>e}),await e.once("moveend"),i%30==0){t(`üèîÔ∏è Terrain following: ${Math.round(100*n)}%`)}}t("üéØ Returning to start..."),e.easeTo({bearing:r,pitch:a,duration:.05*n,essential:!0}),await e.once("moveend"),o()},_followPathWithVehicleSetup:(e,o,i={},n)=>{const r=n.transportClasses||["motorway","trunk","primary","secondary","tertiary","minor","service","track","path"];let a=null,s=null,l="openmaptiles",p="transportation";const h=[];return{setup:async(e,o,{updateStatus:i,checkAbort:h})=>{console.log("[HelperMap] Creating invisible query map...");try{const t=v(e);if(t&&t.vectorSources.roads.sourceId){l=t.vectorSources.roads.sourceId,p=t.vectorSources.roads.sourceLayer;const o=document.getElementById("maplibre-query-helper");o&&o.parentNode&&o.parentNode.removeChild(o);const i=e.getContainer(),n=i.offsetWidth,r=i.offsetHeight;s=document.createElement("div"),s.id="maplibre-query-helper",s.style.cssText=`\n                            position: absolute;\n                            top: -9999px;\n                            left: -9999px;\n                            width: ${n}px;\n                            height: ${r}px;\n                            visibility: hidden;\n                            pointer-events: none;\n                        `,document.body.appendChild(s),console.log("styleInfo",t),a=new maplibregl.Map({container:s,style:t.style,center:e.getCenter(),zoom:15,bearing:e.getBearing(),pitch:0,preserveDrawingBuffer:!1,interactive:!1}),await new Promise(e=>a.once("load",e)),console.log("[HelperMap] Helper map ready for queries")}else console.warn("[HelperMap] Could not extract style, will use main map")}catch(e){if(console.error("[HelperMap] Failed to create helper map:",e),a){try{a.remove()}catch(e){}a=null}s&&s.parentNode&&(s.parentNode.removeChild(s),s=null)}if(i(`üõ£Ô∏è Finding nearest ${n.transportClasses?"path":"road"}...`),!a)return void console.error("[Setup] Helper map not available - cannot query roads");if(!e.getSource(l))return void console.log(`[Setup] No vector source '${l}' found - skipping path positioning`);const m=e.getBearing(),g=e.getCenter(),f=a.querySourceFeatures(l,{sourceLayer:p,filter:["all",["==",["geometry-type"],"LineString"],["in",["get","class"],["literal",r]]]});if(console.log(`[Setup] Found ${f?f.length:0} road segments nearby`),!f||0===f.length)return void console.log("[Setup] No roads found");i("üîç Detecting road by intersection...");let y=null,b=1/0;for(const e of c){const t=e.angle*Math.PI/180,o=[g.lng+.002*Math.sin(t),g.lat+.002*Math.cos(t)],i=[g.lng,g.lat];for(const t of f){if(!t.geometry||!t.geometry.coordinates)continue;const n=t.geometry.coordinates;for(let r=1;r<n.length;r++){const a=n[r-1],s=n[r],l=u(i,o,a,s);null!==l&&l<b&&(b=l,y={road:t,direction:e.name,distance:l,roadClass:t.properties?.class||"unknown"})}}}if(!y){console.log("[Setup] No road intersection found with rays - falling back to closest point");let e=null,t=1/0;for(const o of f)if(o.geometry&&o.geometry.coordinates)for(const i of o.geometry.coordinates){const[n,r]=i,a=n-g.lng,s=r-g.lat,l=Math.sqrt(a*a+s*s);l<t&&(t=l,e=o)}if(!e)return void console.log("[Setup] No valid road found");y={road:e,direction:"fallback",distance:t,roadClass:e.properties?.class||"unknown"}}const w=y.road,x=y.roadClass;console.log(`[Setup] Found road by intersection: ${x} at ${(111e3*y.distance).toFixed(1)}m (direction: ${y.direction})`),console.log(`[Setup] Keeping all ${f.length} road segments (all classes) for fluid exploration`);let _=w.geometry.coordinates;if(_.length>=2){const[e,o]=_[0],[i,n]=_[_.length-1],r=t(e,o,i,n),a=d(r-m);Math.abs(a)>90&&(_=[..._].reverse())}i(`${n.icon} Positioning at road start...`);const S=n.pitch;e.easeTo({pitch:S,duration:1e3,essential:!0}),await e.once("moveend"),h();const[k,C]=_[0],E={lng:k,lat:C};let T=m;if(_.length>=2){const[e,o]=_[1];T=t(k,C,e,o)}const M=n.altitude||10,P=n.zoom||Math.max(10,Math.min(22,22-Math.log2(M)));e.easeTo({center:E,bearing:T,zoom:P,pitch:S,duration:2e3,essential:!0,easing:e=>e<.5?2*e*e:(4-2*e)*e-1,noMoveStart:!0,delayEndEvents:0}),await e.once("moveend"),h(),await e.once("idle"),h(),console.log("[Setup] Initial position set, ready to record")},animation:async(e,t)=>{const o={...i,map2:a,div2:s,sourceId2:l,sourceLayer2:p,debugFeatures:h};await x._followPathWithVehicle(e,t,o,n)},supportsExploration:n.supportsExploration}},_followPathWithVehicle:async(e,{updateStatus:i,checkAbort:a},s={},c)=>{const u=s.duration||2e4;if(i("üõ£Ô∏è Finding nearest road..."),console.log("[HelperMap] Debug - options.map2:",s.map2),console.log("[HelperMap] Debug - typeof options.map2:",typeof s.map2),!s.map2){console.log("[HelperMap] Creating invisible query map...");try{const t=v(e);if(t?t.vectorSources.roads.sourceId||(console.error("[HelperMap] No roads source found in style"),console.error("[HelperMap] Available sources:",t.vectorSources)):console.error("[HelperMap] Failed to extract style info from main map"),t&&t.vectorSources.roads.sourceId){s.sourceId2=t.vectorSources.roads.sourceId,s.sourceLayer2=t.vectorSources.roads.sourceLayer;const o=document.getElementById("maplibre-query-helper");o&&o.parentNode&&o.parentNode.removeChild(o);const i=e.getContainer(),n=i.offsetWidth,r=i.offsetHeight;s.div2=document.createElement("div"),s.div2.id="maplibre-query-helper",s.div2.style.cssText=`\n                        position: absolute;\n                        top: -9999px;\n                        left: -9999px;\n                        width: ${n}px;\n                        height: ${r}px;\n                        visibility: hidden;\n                        pointer-events: none;\n                    `,document.body.appendChild(s.div2),s.map2=new maplibregl.Map({container:s.div2,style:t.style,center:e.getCenter(),zoom:18,bearing:e.getBearing(),pitch:0,interactive:!1}),await new Promise(e=>s.map2.once("load",e)),console.log("[HelperMap] Helper map ready for queries"),console.log("[Debug] Creating visualization layer for followed segments...");try{const t="drone-followed-segments",o="drone-followed-segments-layer";e.getLayer(o)&&e.removeLayer(o),e.getSource(t)&&e.removeSource(t),e.addSource(t,{type:"geojson",data:{type:"FeatureCollection",features:[]}}),e.addLayer({id:o,type:"line",source:t,layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":"#FF00FF","line-width":4,"line-opacity":.8}}),console.log("[Debug] Visualization layer created successfully")}catch(e){console.warn("[Debug] Could not create visualization layer:",e)}}}catch(e){console.error("[HelperMap] Failed to create helper map:",e)}}s.debugFeatures||(s.debugFeatures=[]);const m=s.map2,g=s.sourceId2||"openmaptiles",f=s.sourceLayer2||"transportation";if(!m)return console.error("[Animation] map2 is not available - cannot query roads"),i("‚ö†Ô∏è Helper map not available - using terrain following"),void await x.terrainFollowing(e,{updateStatus:i,checkAbort:a},s);if(!e.getSource(g))return i("‚ö†Ô∏è No vector source - using terrain following"),h(s,e),void await x.terrainFollowing(e,{updateStatus:i,checkAbort:a},s);const y=e.getBearing(),_=e.getCenter(),S=m.querySourceFeatures(g,{sourceLayer:f,filter:l});if(!S||0===S.length)return i("‚ö†Ô∏è No roads found - using terrain following"),h(s,e),void await x.terrainFollowing(e,{updateStatus:i,checkAbort:a},s);let k=null,C=1/0;for(const e of S)if(e.geometry&&e.geometry.coordinates)for(const t of e.geometry.coordinates){const[o,i]=t,n=o-_.lng,r=i-_.lat,a=Math.sqrt(n*n+r*r);a<C&&(C=a,k=e)}if(!k)return i("‚ö†Ô∏è No valid road found - using terrain following"),h(s,e),void await x.terrainFollowing(e,{updateStatus:i,checkAbort:a},s);let E=k.geometry.coordinates;const T=k.properties?.class||"road";if(E.length>=2){const[e,o]=E[0],[i,n]=E[E.length-1],r=t(e,o,i,n),a=d(r-y);Math.abs(a)>90?(E=[...E].reverse(),console.log(`[RoadFollow] Reversed road direction to match user's view (bearingDiff: ${a.toFixed(1)}¬∞)`)):console.log(`[RoadFollow] Following road in natural direction (bearingDiff: ${a.toFixed(1)}¬∞)`)}const M=async(e,o,i)=>{const n=t(o[0],o[1],e[0],e[1]),r=$.roadName,a=$.roadRef,h=$.roadClass;s.map2&&c.searchRadius&&await b._positionHelperMapAhead(s.map2,e,n,c.searchRadius);const u=m.querySourceFeatures(g,{sourceLayer:f,filter:l});let y=null,v=1/0,w=0;const x=5e-4;console.log(`[RoadChain] Searching for next segment from ${h}${r?" ("+r+")":""}${a?" ["+a+"]":""}, bearing: ${n.toFixed(1)}¬∞`),console.log(`[RoadChain] Total segments in cache: ${u.length}`),console.log(`[RoadChain] Connection threshold: ${55.5.toFixed(0)}m`);for(const o of u){if(!o.geometry||!o.geometry.coordinates)continue;if(i.has(o.id))continue;const s=o.geometry.coordinates[0],l=o.geometry.coordinates[o.geometry.coordinates.length-1],c=s[0]-e[0],u=s[1]-e[1],m=Math.sqrt(c*c+u*u),g=l[0]-e[0],f=l[1]-e[1],b=Math.sqrt(g*g+f*f);if(Math.min(m,b)>=x)continue;const _=b<m,S=_?[...o.geometry.coordinates].reverse():o.geometry.coordinates;if(S.length<2)continue;const k=S[0],C=S[1];if(!p(k)||!p(C)){console.warn(`[RoadChain] Invalid coordinates for road ${o.id}, skipping`);continue}const E=t(k[0],k[1],C[0],C[1]);if(isNaN(E)){console.warn(`[RoadChain] NaN bearing for road ${o.id}, skipping`);continue}const T=Math.abs(d(E-n));if(isNaN(T)){console.warn(`[RoadChain] NaN bearingDiff for road ${o.id}, skipping`);continue}if(T>150)continue;const M=Math.min(m,b),P=o.properties?.name,F=o.properties?.ref,I=o.properties?.class,$=F&&a&&F===a,W=P&&r&&P===r,A=I&&h&&I===h;let L=0;L=$?0+10*M+.01*T:W?100+10*M+.01*T:A?1e3+10*M+50*T:1e4+100*M+200*T,w++;const z=F?`[${F}]`:P||I,B=$?"P1-SameRef":W?"P2-SameName":A?"P3-SameClass":"P4-Different";console.log(`[RoadChain]   Candidate #${w}: ${z} (${B}) bearing Œî${T.toFixed(1)}¬∞, dist ${(111e3*M).toFixed(1)}m, score ${L.toFixed(1)}`),L<v&&(v=L,y={road:o,coords:S,reversed:_,bearingDiff:T,distance:M,score:L,roadName:P,roadRef:F})}if(console.log(`[RoadChain] Evaluated ${w} candidate segments, best score: ${v===1/0?"none found":v.toFixed(1)}`),!y&&s.map2&&c.searchRadius){const o=s.map2.getZoom(),r=18===o?[16,17]:[];for(const a of r){console.log(`[RoadChain] No segment found at zoom ${o.toFixed(1)}, retrying at zoom ${a}...`),s.map2.setZoom(a),await new Promise(e=>setTimeout(e,200));const r=m.querySourceFeatures(g,{sourceLayer:f,filter:l});console.log(`[RoadChain] Retry found ${r.length} segments at zoom ${a}`);for(const o of r){if(!o.geometry||!o.geometry.coordinates)continue;if(i.has(o.id))continue;const r=o.geometry.coordinates[0],s=o.geometry.coordinates[o.geometry.coordinates.length-1],l=r[0]-e[0],c=r[1]-e[1],p=Math.sqrt(l*l+c*c),h=s[0]-e[0],u=s[1]-e[1],m=Math.sqrt(h*h+u*u),g=Math.min(p,m);if(g<x){const e=m<p,i=e?[...o.geometry.coordinates].reverse():o.geometry.coordinates;if(i.length>=2){const r=i[0],s=i[1],l=t(r[0],r[1],s[0],s[1]),c=Math.abs(d(l-n));if(c<=150){console.log(`[RoadChain] ‚úÖ Found segment at zoom ${a}: bearingDiff ${c.toFixed(1)}¬∞`),y={road:o,coords:i,reversed:e,bearingDiff:c,distance:g,score:1e3+50*c,roadName:o.properties?.name,roadRef:o.properties?.ref};break}}}}if(y){s.map2.setZoom(18);break}}!y&&s.map2&&s.map2.setZoom(18)}return y};console.log(`[RoadChain] Starting with ${T}: ${E.length} points`),i(`${c.icon} Following ${T} (${E.length} points)...`);const P=c.pitch;e.easeTo({pitch:P,duration:1e3,essential:!0}),await e.once("moveend"),a();const F=c.speedKmh||30;console.log(`[RoadFollow] Vehicle speed: ${F} km/h`);const I=maplibregl.now();let $=c.smoothPath?r(E,.01):n(E,.01);$.roadClass=k.properties?.class,$.roadName=k.properties?.name,$.roadRef=k.properties?.ref;const W=[],A=c.smoothing;i(`${c.icon} Following road network...`);const L=new Set([k.id]);let z=1,B=1,R=1;try{for(;;){a();const l=maplibregl.now()-I;if((!maplibregl.isTimeFrozen||!maplibregl.isTimeFrozen())&&l>=u){console.log(`[RoadChain] Animation complete: ${(l/1e3).toFixed(1)}s, ${R} points, ${B} segments`);break}if(z>=$.length){if(console.log(`[RoadChain] End of segment #${B} reached (index ${z} >= ${$.length} points)`),B>=1e4){console.log("[RoadChain] Max segments (10000) reached");break}const o=$[$.length-1],a=$[$.length-2];if(!a){console.error("[RoadChain] ‚ùå ERROR: Segment has only 1 point, cannot calculate bearing!"),console.error(`[RoadChain] currentSegmentCoords.length = ${$.length}`),console.error("[RoadChain] This is a bug - segments should always have ‚â•2 points");break}console.log(`[RoadChain] Searching for segment #${B+1} from point [${o[0].toFixed(6)}, ${o[1].toFixed(6)}]`);let l=await M(o,a,L);if(console.log("[RoadChain] Search result: "+(l?"FOUND":"NOT FOUND")),!l){const e=t(a[0],a[1],o[0],o[1]),n=$.roadClass||k.properties?.class;l=w(o,e,L,S,{prefer:n?[n]:[],searchRadius:Math.min(.002,c.searchRadius||.002)}),l?(console.log("[RoadChain] Cardinal search: FOUND road in direction"),i(`${c.icon} Jumping to nearby road...`)):console.log("[RoadChain] Cardinal search: NOT FOUND")}if(!l&&c.supportsExploration){console.log("[RoadSearch] Explore mode: searching forward for next road...");const e=t(a[0],a[1],o[0],o[1]),n=5e-4,r=4;let s=null;for(let t=1;t<=r&&!s;t++){const r=e*Math.PI/180,a=o[0]+n*t*Math.sin(r),d=o[1]+n*t*Math.cos(r),p=$.roadClass||k.properties?.class;if(s=w([a,d],e,L,S,{prefer:p?[p]:[],searchRadius:.5*(c.searchRadius||.002)}),s){console.log(`[RoadSearch] ‚úÖ Found road after ${t} steps (${(50*t).toFixed(0)}m forward)`);const e=[];for(let i=1;i<=t;i++){const t=o[0]+n*i*Math.sin(r),a=o[1]+n*i*Math.cos(r);e.push([t,a])}l={...s,coords:[...e,...s.coords]},i(`${c.icon} Crossing terrain to next road...`)}}if(!s){console.log("[RoadSearch] No road found within 200m forward - generating synthetic segment to continue");const t=n*r,a=e*Math.PI/180,s=10,d=[];for(let e=1;e<=s;e++){const i=e/s,n=o[0]+t*i*Math.sin(a),r=o[1]+t*i*Math.cos(a);d.push([n,r])}l={road:{id:`synthetic-${B}`,properties:{class:"aerial"}},coords:d,reversed:!1,bearingDiff:0,distance:0,synthetic:!0},i(`${c.icon} Flying over terrain (no roads)...`)}}if(!l){console.error(`[RoadChain] ‚ùå STOPPING: No roads found in any direction after ${B} segments`),console.error("[RoadChain] This should NEVER happen in exploration mode with synthetic segments!"),console.error(`[RoadChain] Last position: [${o[0].toFixed(6)}, ${o[1].toFixed(6)}]`),console.error(`[RoadChain] supportsExploration: ${c.supportsExploration}`),L.clear();break}{l.coords.length>2?$=c.smoothPath?r(l.coords.slice(1),.01):n(l.coords.slice(1),.01):($=c.smoothPath?r(l.coords,.01):n(l.coords,.01),console.log(`[RoadChain] Short segment - keeping all ${l.coords.length} points for bearing calc`)),$.roadClass=l.road.properties?.class,$.roadName=l.road.properties?.name,$.roadRef=l.road.properties?.ref,z=0,B++,L.add(l.road.id);const t=l.road.properties?.class||"road",o=l.road.properties?.name,a=l.road.properties?.ref,d=a||o||t,p=l.distance?(1e3*l.distance).toFixed(1):"0.0";if(console.log(`[RoadChain] ‚úÖ Segment #${B}: ${d} (${l.coords.length} pts, ${l.reversed?"reversed":"forward"}, bearing Œî${l.bearingDiff.toFixed(1)}¬∞, ${p}m)`+(l.score?`, score: ${l.score.toFixed(1)}`:"")),console.log(`[RoadChain] After processing: ${$.length} points remaining for animation`),s.debugFeatures)try{const i=maplibregl.now()-I;s.debugFeatures.push({type:"Feature",properties:{name:o||"unnamed",ref:a||"",class:t,segmentNum:B,reversed:l.reversed,bearingDiff:parseFloat(l.bearingDiff.toFixed(1)),distanceM:parseFloat(p),score:l.score?parseFloat(l.score.toFixed(1)):null,numPoints:l.coords.length,roadId:l.road.id,timestampMs:Math.round(i),zoom2:s.map2?parseFloat(s.map2.getZoom().toFixed(1)):null},geometry:{type:"LineString",coordinates:l.coords}});const n=e.getSource("drone-followed-segments");n&&(n.setData({type:"FeatureCollection",features:s.debugFeatures}),console.log(`[Debug] Added segment #${B} to visualization (total: ${s.debugFeatures.length} segments)`))}catch(e){console.error("[Debug] Failed to update visualization:",e)}i(`${c.icon} Following ${d} (segment ${B})...`)}}const[d,p]=$[z],h={lng:d,lat:p};let m=100,g=y;if(z<$.length-1){const[e,i]=$[z+1];g=t(d,p,e,i);m=o(d,p,e,i)/F*3600*1e3,m=Math.max(20,m)}else if(z>0){const[e,o]=$[z-1];g=t(e,o,d,p)}const f=e.queryTerrainElevation(h);let b=c.zoom;if(null!==f&&f>=0){const e=f/1e3,t=c.zoom,o=1.5*e;b=Math.max(10,t-o)}W.push(b),W.length>A&&W.shift();const v=W.reduce((e,t)=>e+t,0)/W.length;if(e.easeTo({center:h,bearing:g,zoom:v,pitch:P,duration:m,essential:!0,easing:e=>e,noMoveStart:!0,delayEndEvents:0}),await e.once("moveend"),z++,R++,R%30==0){const e=Math.min(99,Math.round(l/u*100));i(`${c.icon} Following road network: ${e}% (${B} segments)`)}}i(`‚úÖ ${c.name} complete!`)}finally{if(s.debugFeatures&&s.debugFeatures.length>0){const e={type:"FeatureCollection",features:s.debugFeatures};console.log("[Debug] Final followed path GeoJSON ("+s.debugFeatures.length+" segments):"),console.log(JSON.stringify(e,null,2))}console.log("[HelperMap] Cleaning up helper map..."),h(s,e),console.log("[Debug] Cleaning up visualization layer...");try{const t="drone-followed-segments-layer",o="drone-followed-segments";e.getLayer(t)&&e.removeLayer(t),e.getSource(o)&&e.removeSource(o),console.log("[Debug] Visualization layer cleaned up")}catch(e){console.error("[Debug] Error cleaning up visualization layer:",e)}}},tractorRoadTrip:(e,t,o={})=>x._followPathWithVehicleSetup(e,t,o,{altitude:8,zoom:20,pitch:60,smoothing:5,speedKmh:30,searchRadius:.002,preloadDistance:.002,icon:"üöú",name:"Tractor Road Trip",supportsExploration:!0,smoothPath:!0}),carRoadTrip:(e,t,o={})=>x._followPathWithVehicleSetup(e,t,o,{altitude:15,zoom:19,pitch:60,smoothing:5,speedKmh:70,searchRadius:.002,preloadDistance:.005,icon:"üöó",name:"Car Road Trip",supportsExploration:!0,smoothPath:!0}),sportsCarRace:(e,t,o={})=>x._followPathWithVehicleSetup(e,t,o,{altitude:25,zoom:17.5,pitch:60,smoothing:5,speedKmh:130,searchRadius:.003,preloadDistance:.01,icon:"üèéÔ∏è",name:"Sports Car Race",supportsExploration:!0,smoothPath:!0}),planeFlight:(e,t,o={})=>x._followPathWithVehicleSetup(e,t,o,{altitude:200,zoom:15,pitch:45,smoothing:8,speedKmh:200,searchRadius:.01,preloadDistance:.015,icon:"‚úàÔ∏è",name:"Plane Flight",supportsExploration:!0,smoothPath:!0}),helicopterTour:(e,t,o={})=>x._followPathWithVehicleSetup(e,t,o,{altitude:50,zoom:17.5,pitch:70,smoothing:6,speedKmh:60,searchRadius:.005,preloadDistance:.005,icon:"üöÅ",name:"Helicopter Tour",supportsExploration:!0,smoothPath:!0}),droneFollow:(e,t,o={})=>x._followPathWithVehicleSetup(e,t,o,{altitude:30,zoom:18.5,pitch:65,smoothing:4,speedKmh:60,searchRadius:.005,preloadDistance:.004,icon:"üõ∏",name:"Drone Follow",supportsExploration:!0,smoothPath:!0}),birdsEyeRoad:(e,t,o={})=>x._followPathWithVehicleSetup(e,t,o,{altitude:100,zoom:16,pitch:40,smoothing:7,speedKmh:50,searchRadius:.01,preloadDistance:.004,icon:"ü¶Ö",name:"Bird's Eye Road",supportsExploration:!0,smoothPath:!0}),trainRide:(e,t,o={})=>x._followPathWithVehicleSetup(e,t,o,{altitude:12,zoom:19,pitch:55,smoothing:8,speedKmh:70,searchRadius:.002,preloadDistance:.005,icon:"üöÇ",name:"Train Ride",supportsExploration:!0,transportClasses:["rail","transit"],smoothPath:!0}),speedboat:(e,t,o={})=>x._followPathWithVehicleSetup(e,t,o,{altitude:8,zoom:18,pitch:55,smoothing:4,speedKmh:90,searchRadius:.005,preloadDistance:.007,icon:"üö§",name:"Speedboat",supportsExploration:!0,transportClasses:["river","canal","stream"],smoothPath:!0}),sailboat:(e,t,o={})=>x._followPathWithVehicleSetup(e,t,o,{altitude:10,zoom:17,pitch:55,smoothing:7,speedKmh:28,searchRadius:.004,preloadDistance:.002,icon:"‚õµ",name:"Sailboat",supportsExploration:!0,transportClasses:["river","canal"],smoothPath:!0}),cruiseShip:(e,t,o={})=>x._followPathWithVehicleSetup(e,t,o,{altitude:18,zoom:15,pitch:45,smoothing:11,speedKmh:22,searchRadius:.004,preloadDistance:.002,icon:"üõ•Ô∏è",name:"Cruise Ship",supportsExploration:!0,transportClasses:["river","canal"],smoothPath:!0}),freeFlight:async(e,{updateStatus:t,checkAbort:o},i={})=>{const n=i.duration||6e4,r=i.speedKmh||80,a=i.pitch||50;t("‚úàÔ∏è Free flight - cruising forward...");const l=maplibregl.now(),c=e.getBearing(),d=e.getCenter();e.easeTo({pitch:a,duration:2e3,essential:!0}),await e.once("moveend"),o();const p=.1*(1e3*r/3600)/111e3;let h=d.lng,u=d.lat,m=c,g=0;for(t("‚úàÔ∏è Cruising...");;){o();const t=maplibregl.now()-l;if((!maplibregl.isTimeFrozen||!maplibregl.isTimeFrozen())&&t>=n){console.log(`[FreeFlight] Cruise complete: ${(t/1e3).toFixed(1)}s`);break}const i=t/1e3;g+=.02*Math.sin(.1*i)+.05*(Math.random()-.5),g=Math.max(-5,Math.min(5,g)),m=c+g;const r=m*Math.PI/180;h+=p*Math.sin(r),u+=p*Math.cos(r),e.easeTo({center:[h,u],bearing:m,duration:100,essential:!0}),await s(100)}t("‚úàÔ∏è Free flight complete")}};class _{constructor(){this.abortController=null,this.isRunning=!1,this.initialPosition=null}async run(e,t,o={}){if(this.isRunning)return this.cancel(e),{cancelled:!0};this.isRunning=!0,this.abortController=new AbortController,this.initialPosition=this._capturePosition(e);const i=this.abortController.signal;try{return await t(e,{signal:i,updateStatus:o.updateStatus||(()=>{}),checkAbort:()=>{if(i.aborted)throw new DOMException("Animation aborted","AbortError")}}),{success:!0}}catch(e){if("AbortError"===e.name)return{cancelled:!0};throw e}finally{this.cleanup()}}cancel(e){this.abortController&&this.abortController.abort(),e&&this.initialPosition&&e.jumpTo(this.initialPosition),this.cleanup()}stop(){this.abortController&&this.abortController.abort(),this.cleanup()}get running(){return this.isRunning}get aborted(){return this.abortController?.signal.aborted??!1}cleanup(){this.isRunning=!1,this.abortController=null,this.initialPosition=null}_capturePosition(e){return{center:e.getCenter(),zoom:e.getZoom(),bearing:e.getBearing(),pitch:e.getPitch()}}createAbortChecker(){const e=this.abortController?this.abortController.signal:null;return()=>{if(e&&e.aborted)throw new DOMException("Animation aborted","AbortError")}}async waitForMove(e,t){await t,await e.once("moveend");const o=this.abortController?this.abortController.signal:null;if(o&&o.aborted)throw new DOMException("Animation aborted","AbortError")}}class S{constructor(){this.worker=null,this.resolveEnd=null,this.videoChunks=[],this.frameCount=0,this.realtimeMode=!1}async create(e){const{width:t,height:o,fps:i,bitrate:n,wasmUrl:r,workerUrl:a,realtime:s=!1}=e;let l;this.realtimeMode=s,console.log("[WebM Encoder] Initializing with:",{width:t,height:o,fps:i,bitrate:`${n} kbps`,realtime:s?"enabled (fast)":"disabled (high quality)",wasmUrl:r,workerUrl:a});try{const e=new URL(a,window.location.href);if(e.origin!==window.location.origin)throw new Error(`Worker URL must be same-origin. Expected: ${window.location.origin}, Got: ${e.origin}`);if(!e.pathname.endsWith("webm-worker.js"))throw new Error(`Invalid worker URL pattern. Expected path ending with 'webm-worker.js', Got: ${e.pathname}`);l=e.href}catch(e){throw new Error(`Worker URL validation failed: ${e.message}\nProvided URL: ${a}`)}const c=l.replace("webm-worker.js","webm-worker-wrapper.js");try{console.log("[WebM Encoder] Creating worker from wrapper:",c),this.worker=new Worker(c)}catch(e){throw new Error(`Failed to create WebM worker. Make sure vendor/webm/ files are deployed alongside the plugin.\nWorker URL: ${c}\nError: ${e.message}`)}this.worker.onmessage=e=>{if(e.data instanceof ArrayBuffer?console.log(`[WebM Encoder] Chunk received: ${e.data.byteLength} bytes (total: ${this.videoChunks.length+1})`):console.log("[WebM Encoder] Worker message:","object"==typeof e.data?JSON.stringify(e.data):e.data),e.data instanceof ArrayBuffer)this.videoChunks.push(e.data),console.log(`[WebM Encoder] Collected chunk ${this.videoChunks.length}: ${e.data.byteLength} bytes`),!this.realtimeMode&&this.resolveEnd&&(console.log("[WebM Encoder] Non-realtime mode: received final video"),this.resolveEnd(e.data),this.resolveEnd=null);else if("ready"===e.data||"READY"===e.data)console.log("[WebM Encoder] Worker ready"),this.resolveReady&&(this.resolveReady(),this.resolveReady=null);else if(null===e.data||void 0===e.data){if(console.log("[WebM Encoder] End signal (null) received - finalizing video"),this.resolveEnd){console.log(`[WebM Encoder] Realtime mode: concatenating ${this.videoChunks.length} chunks...`);const e=this.videoChunks.reduce((e,t)=>e+t.byteLength,0);console.log(`[WebM Encoder] Total size: ${e} bytes`);const t=new Uint8Array(e);let o=0;for(const e of this.videoChunks)t.set(new Uint8Array(e),o),o+=e.byteLength;console.log(`[WebM Encoder] Video finalized: ${t.byteLength} bytes`),this.resolveEnd(t.buffer),this.resolveEnd=null}}else"object"==typeof e.data&&e.data.error?(console.error("[WebM Encoder] Worker error:",e.data.error),this.resolveEnd&&(this.resolveEnd(null),this.resolveEnd=null)):console.log("[WebM Encoder] Unexpected worker message:",e.data)},this.worker.onerror=e=>{console.error("[WebM Encoder] Worker error:",e),this.resolveEnd&&(this.resolveEnd(null),this.resolveEnd=null)},console.log("[WebM Encoder] Sending WASM path to worker"),this.worker.postMessage(r),await new Promise((e,t)=>{const o=setTimeout(()=>{this.resolveReady=null,t(new Error("WebM worker initialization timeout. Make sure vendor/webm/ files are correctly deployed."))},3e4);this.resolveReady=()=>{clearTimeout(o),e()}}),console.log("[WebM Encoder] Configuring encoder");const d={width:t,height:o,bitrate:n,realtime:s};return console.log("[WebM Encoder] Configuration:",d),this.worker.postMessage(d),await new Promise(e=>setTimeout(e,100)),console.log("[WebM Encoder] Initialization complete, ready to receive frames"),this}addFrame(e){this.frameCount++,this.frameCount%30==0&&console.log(`[WebM Encoder] Encoding frame ${this.frameCount}`),1===this.frameCount&&console.log(`[WebM Encoder] First frame - buffer size: ${e.byteLength} bytes`);const t=new ArrayBuffer(e.byteLength);new Uint8Array(t).set(e),this.worker.postMessage(t)}async end(){console.log(`[WebM Encoder] Finalizing encoding (${this.frameCount} total frames, ${this.videoChunks.length} chunks collected so far)`),console.log("[WebM Encoder] Sending null to signal end of stream");try{this.worker.postMessage(null)}catch(e){return console.error("[WebM Encoder] Error sending null:",e),Promise.reject(new Error("Failed to signal end of stream"))}return new Promise((e,t)=>{const o=setTimeout(()=>{console.error("[WebM Encoder] Timeout waiting for end signal from worker"),console.error(`[WebM Encoder] Chunks collected: ${this.videoChunks.length}`),t(new Error("WebM encoding failed - timeout waiting for end signal"))},3e4);this.resolveEnd=i=>{clearTimeout(o),i?(console.log(`[WebM Encoder] Successfully finalized video: ${i.byteLength} bytes`),e(i)):t(new Error("WebM encoding failed - no video data"))}})}destroy(){console.log("[WebM Encoder] Destroying encoder"),this.worker&&(this.worker.terminate(),this.worker=null),this.videoChunks=[],this.resolveEnd=null,this.frameCount=0}}const k=()=>"undefined"!=typeof VideoEncoder&&"undefined"!=typeof VideoFrame?(console.log("‚úì VP9 supported - using VP9 as default format (better quality/compression)"),"webm-vp9"):(console.log("‚úì VP9 not available - using VP8 as default format"),"webm-vp8"),C={smart:{label:"üß† Smart (Try to auto-detect map features)",description:"Animation that adapts to your map. Visits all waypoints if present, otherwise creates a dynamic tour based on detected features (roads, water, terrain).",supportsExploration:!1,group:"auto",requires:[],func:(e,t,o,i)=>i.createAdaptiveAnimation(t,o)},orbit:{label:"üîÑ 360¬∞ Orbit",description:"Smooth circular rotation around the center point. Perfect for creating seamless looping videos of a location from all angles.",supportsExploration:!1,group:"loops",requires:[],func:(e,t,o)=>({animation:async(e,t,o)=>x.orbit360(e,t,o)})},pulse:{label:"üíì Zoom Pulse",description:"Rhythmic zoom in and out from the center. Creates a breathing effect that draws attention to a specific area.",supportsExploration:!1,group:"loops",requires:[],func:(e,t,o)=>({animation:async(e,t,o)=>x.zoomPulse(e,t,o)})},orbitZoom:{label:"üåç Orbit Zoom",description:"Combines orbital rotation with gradual zoom. Reveals the location from wide view to close-up while circling around.",supportsExploration:!1,group:"loops",requires:[],func:(e,t,o)=>({animation:async(e,t,o)=>x.orbitZoom(e,t,o)})},waveMotion:{label:"üåä Wave Motion",description:"Flowing side-to-side motion with smooth camera movement. Especially effective for coastal areas and waterways.",supportsExploration:!1,group:"loops",requires:["?hasWater"],func:(e,t,o)=>({animation:async(e,t,o)=>x.waveMotion(e,t,o)})},pendulum:{label:"‚è±Ô∏è Pendulum",description:"Gentle swing motion back and forth. Creates a contemplative, hypnotic effect ideal for atmospheric backgrounds.",supportsExploration:!1,group:"loops",requires:[],func:(e,t,o)=>({animation:async(e,t,o)=>x.pendulum(e,t,o)})},neighborhood:{label:"üèòÔ∏è Neighborhood Explorer",description:"Explores a neighborhood area with multiple perspectives and angles. Ideal for showcasing residential areas, community spaces, and local amenities.",supportsExploration:!1,group:"cinematic",requires:["?hasPlaces","?hasRoads"],func:(e,t,o)=>({animation:async(e,t,o)=>x.neighborhood(e,t,o)})},property:{label:"üè° Property Showcase",description:"Professional real estate presentation that circles around a property with strategic viewpoints. Perfect for property listings and architectural showcases.",supportsExploration:!1,group:"cinematic",requires:["?has3DBuildings"],func:(e,t,o)=>({animation:async(e,t,o)=>x.propertyShowcase(e,t,o)})},explore:{label:"üß≠ Explore Around",description:"Dynamic exploration that moves through and around the area in all directions. Great for discovering locations and showing spatial relationships.",supportsExploration:!1,group:"cinematic",requires:[],func:(e,t,o)=>({animation:async(e,t,o)=>x.exploreAround(e,t,o)})},panorama:{label:"üì∑ Panoramic Sweep",description:"Smooth horizontal sweep across the landscape. Captures wide vistas and creates a cinematic establishing shot effect.",supportsExploration:!1,group:"cinematic",requires:[],func:(e,t,o)=>({animation:async(e,t,o)=>x.panorama(e,t,o)})},aerial:{label:"üöÅ Aerial Sweep",description:"High-altitude sweep with bird's eye perspective. Excellent for showing large areas, urban layouts, and geographic context.",supportsExploration:!1,group:"cinematic",requires:[],func:(e,t,o)=>({animation:async(e,t,o)=>x.aerialSweep(e,t,o)})},droneShot:{label:"üõ∏ Drone Shot",description:"Simulates professional drone cinematography with ascending and descending movements. Creates dramatic reveals and dynamic perspectives.",supportsExploration:!1,group:"cinematic",requires:[],func:(e,t,o)=>({animation:async(e,t,o)=>x.droneShot(e,t,o)})},terrainFollowing:{label:"üèîÔ∏è Terrain Following",description:"Follows the natural contours of the landscape at low altitude. Spectacular for mountainous regions, valleys, and dramatic topography.",supportsExploration:!1,group:"cinematic",requires:["?hasTerrain","?hasHillshade"],func:(e,t,o)=>({animation:async(e,t,o)=>x.terrainFollowing(e,t,o)})},spotlightScan:{label:"üî¶ Spotlight Scan",description:"Systematic scanning movement that reveals the area section by section. Perfect for methodical exploration and attention-grabbing presentations.",supportsExploration:!1,group:"cinematic",requires:[],func:(e,t,o)=>({animation:async(e,t,o)=>x.spotlightScan(e,t,o)})},butterfly:{label:"ü¶ã Butterfly",description:"Graceful figure-8 pattern with smooth flowing movements. Creates an elegant, organic feel ideal for natural landscapes and parks.",supportsExploration:!1,group:"cinematic",requires:[],func:(e,t,o)=>({animation:async(e,t,o)=>x.butterfly(e,t,o)})},figure8:{label:"‚àû Figure-8",description:"Classic infinity-shaped path around two focal points. Versatile pattern that works well for comparing two areas or showing connections.",supportsExploration:!1,group:"cinematic",requires:[],func:(e,t,o)=>({animation:async(e,t,o)=>x.figure8(e,t,o)})},spiral:{label:"üåÄ Spiral Zoom",description:"Spiraling motion while zooming in or out. Creates hypnotic, attention-drawing effect perfect for dramatic openings or closings.",supportsExploration:!1,group:"cinematic",requires:[],func:(e,t,o)=>({animation:async(e,t,o)=>x.spiralZoom(e,t,o)})},tractorRoadTrip:{label:"üöú Tractor Road Trip",description:"Leisurely journey along roads at tractor speed with smooth curves. Perfect for rural routes, countryside tours, and relaxed explorations.",supportsExploration:!0,group:"road",requires:["hasRoads"],func:(e,t,o)=>x.tractorRoadTrip(e,t,o)},carRoadTrip:{label:"üöó Car Road Trip",description:"Moderate-speed road journey that follows streets and highways naturally. Great for urban navigation and everyday road perspectives.",supportsExploration:!0,group:"road",requires:["hasRoads"],func:(e,t,o)=>x.carRoadTrip(e,t,o)},sportsCarRace:{label:"üèéÔ∏è Sports Car Race",description:"High-speed chase along roads with dynamic banking angles. Thrilling and fast-paced for action-oriented presentations.",supportsExploration:!0,group:"road",requires:["hasRoads"],func:(e,t,o)=>x.sportsCarRace(e,t,o)},trainRide:{label:"üöÇ Train Ride",description:"Follows railway tracks at steady train speed with authentic rail perspective. Requires railways on the map.",supportsExploration:!0,group:"road",requires:["hasRailways"],func:(e,t,o)=>x.trainRide(e,t,o)},speedboat:{label:"üö§ Speedboat",description:"Fast-paced journey along waterways with dynamic low angle. Exciting for rivers, canals, and coastal routes.",supportsExploration:!0,group:"road",requires:["hasWaterways"],func:(e,t,o)=>x.speedboat(e,t,o)},sailboat:{label:"‚õµ Sailboat",description:"Graceful navigation across water bodies at sailing speed. Peaceful and scenic for lakes, bays, and open water.",supportsExploration:!0,group:"road",requires:["hasWater"],func:(e,t,o)=>x.sailboat(e,t,o)},cruiseShip:{label:"üõ•Ô∏è Cruise Ship",description:"Stately movement across large water bodies with elevated viewpoint. Majestic perspective for oceans, large lakes, and harbors.",supportsExploration:!0,group:"road",requires:["hasWater"],func:(e,t,o)=>x.cruiseShip(e,t,o)},droneFollow:{label:"üõ∏ Drone Follow",description:"Aerial tracking that follows roads from above with varying altitude. Modern perspective for documenting routes and infrastructure.",supportsExploration:!0,group:"road",requires:["hasRoads"],func:(e,t,o)=>x.droneFollow(e,t,o)},helicopterTour:{label:"üöÅ Helicopter Tour",description:"High-altitude road following with sweeping movements and wide views. Professional aerial tour perspective.",supportsExploration:!0,group:"road",requires:["hasRoads"],func:(e,t,o)=>x.helicopterTour(e,t,o)},birdsEyeRoad:{label:"ü¶Ö Bird's Eye Road",description:"Top-down road following that maintains vertical perspective. Ideal for showing route patterns and spatial relationships.",supportsExploration:!0,group:"road",requires:["hasRoads"],func:(e,t,o)=>x.birdsEyeRoad(e,t,o)},planeFlight:{label:"‚úàÔ∏è Plane Flight",description:"High-altitude journey with plane-like speed and perspective. Covers large distances quickly for regional overviews.",supportsExploration:!0,group:"road",requires:["hasRoads"],func:(e,t,o)=>({animation:async(e,t)=>x.waypointTour(e,t,o)})},waypointTour:{label:"üó∫Ô∏è Visit All Waypoints",description:"Travels through your custom waypoints in order with smooth transitions. Perfect for guided tours, storytelling, and showcasing specific locations in sequence.",supportsExploration:!1,group:"waypoint",requires:[],func:(e,t,o)=>({animation:async(e,t)=>x.waypointTour(e,t,o)})}},E={auto:"üß† Auto",loops:"‚ü≥ Seamless Loops ready",cinematic:"üé¨ Cinematic & POI",road:"üõ£Ô∏è Road Following",waypoint:"üéØ Waypoint Tour"};class T{static DEFAULT_SETTINGS={"ve-resolution":"auto","ve-cinematic-bars":"none","ve-duration":"30","ve-speed":"1","ve-fps":60,"ve-format":"webm-vp9","ve-bitrate":"auto","ve-wait-tiles":!0,"ve-format-advanced-toggle":!1,"ve-animation":"smart","ve-loop":"false","ve-show-labels-toggle":!1,"ve-icon-size-slider":1,"ve-bounds-west":"","ve-bounds-east":"","ve-bounds-south":"","ve-bounds-north":"","ve-zoom-min":"","ve-zoom-max":"","ve-strict-bounds":!1,"ve-show-bounds":!0,"ve-mp4-speed":"5","ve-mp4-qp":"10,42","ve-mp4-gop":"30","ve-vp8-bitrate-custom":"","ve-vp9-quality":"high","ve-vp9-latency":"quality","ve-vp9-bitrate-mode":"variable","ve-vp9-keyframe":120,"ve-vp9-content-hint":""};constructor(e={}){this.options={resolution:e.resolution||"auto",fps:e.fps||60,bitrate:void 0!==e.bitrate?e.bitrate:"auto",speedMultiplier:e.speedMultiplier||1,waitForTiles:void 0===e.waitForTiles||e.waitForTiles,position:e.position||"top-left",collapsed:!1!==e.collapsed,compactPosition:e.compactPosition||"top-left",animation:e.animation||"smart",duration:e.duration||3e4,loop:e.loop||!1,explorationLimitEnabled:void 0!==e.explorationLimitEnabled&&e.explorationLimitEnabled,explorationMaxDuration:e.explorationMaxDuration||3e5,maxBounds:e.maxBounds||null,minZoom:void 0!==e.minZoom?e.minZoom:null,maxZoom:void 0!==e.maxZoom?e.maxZoom:null,strictBounds:e.strictBounds||!1,showBoundsOverlay:void 0!==e.showBoundsOverlay&&e.showBoundsOverlay,waypoints:e.waypoints||null,format:e.format||k(),encoderPath:e.encoderPath||null,encoderCdn:e.encoderCdn||"https://unpkg.com/mp4-h264@1.0.7/build/",onStart:e.onStart||(()=>{}),onProgress:e.onProgress||(()=>{}),onComplete:e.onComplete||(()=>{}),onError:e.onError||(e=>console.error("Video export error:",e))},this._map=null,this._container=null,this._animationController=new _,this._encoder=null,this._encoderLoaded=!1,this._spriteIcons=[],this._waypointMarkers=[],this._isRecording=!1,this._savedWaypointsVisibility=void 0,this._waypointsLayerId="ve-waypoints-recording-layer",this._waypointsSourceId="ve-waypoints-recording-source",this.options.waypoints&&this.options.waypoints.type||(this.options.waypoints=this._loadWaypoints()),this._spriteImage=null,this._spriteData=null,this._spritePngUrl=null,this._iconSize=1,this._availableFonts=[],this._selectedFont=null,this._showWaypointLabels=!1,this._recordingStartTime=null}onAdd(e){return this._map=e,this._checkMapLibreVersion(),this._container=document.createElement("div"),this._container.className="maplibregl-ctrl maplibre-gl-video-export-ctrl",this._createUI(),e.isStyleLoaded()?(console.log("[VideoExport] Map style already loaded, loading sprites and default icon now"),this._checkMapCapabilities(),this._loadSpriteIcons(),this._addDefaultWaypointIcon(),this.options.waypoints&&this.options.waypoints.features&&this.options.waypoints.features.length>0&&setTimeout(()=>{this._createWaypointsLayer(),this._createWaypointMarkers(),this._updateWaypointsUI()},500)):(console.log("[VideoExport] Waiting for map style to load..."),e.once("load",()=>{console.log("[VideoExport] Map style loaded, loading sprites and default icon now"),this._checkMapCapabilities(),this._loadSpriteIcons(),this._addDefaultWaypointIcon(),this.options.waypoints&&this.options.waypoints.features&&this.options.waypoints.features.length>0&&setTimeout(()=>{this._createWaypointsLayer(),this._createWaypointMarkers(),this._updateWaypointsUI()},500)})),this._container}onRemove(){this._encoder&&(this._encoder.destroy?this._encoder.destroy():this._encoder.delete&&this._encoder.delete(),this._encoder=null);const e=this._map?.getContainer();e&&(this._overlay&&this._overlay.parentNode&&this._overlay.parentNode.removeChild(this._overlay),this._panel&&this._panel.parentNode&&this._panel.parentNode.removeChild(this._panel)),this._container&&this._container.parentNode&&this._container.parentNode.removeChild(this._container),this._overlay=null,this._panel=null,this._container=null,this._map=null}_checkMapLibreVersion(){if(!("undefined"!=typeof maplibregl&&"function"==typeof maplibregl.setNow&&"function"==typeof maplibregl.restoreNow&&"function"==typeof maplibregl.isTimeFrozen)){const e=this._map&&this._map.version?this._map.version:"unknown";throw new Error("MapLibre GL JS v5.10.0 or higher is required for video recording. The timeControl API (setNow, restoreNow, isTimeFrozen) is missing. Please upgrade to MapLibre GL JS v5.10.0+. Current version: "+e)}if(!("function"==typeof maplibregl.now)){const e=this._map&&this._map.version?this._map.version:"unknown";throw new Error("MapLibre GL JS with exported now() function is required for vehicle animations. The official v5.10.0 does not export now() - see https://github.com/maplibre/maplibre-gl-js/issues/6643. Please use a custom build of MapLibre that exports now() from time_control.ts. Current version: "+e)}console.log("[VideoExport] ‚úì MapLibre GL JS timeControl API detected (including now())")}_generateAnimationOptions(){const e={};Object.entries(C).forEach(([t,o])=>{e[o.group]||(e[o.group]=[]),e[o.group].push({key:t,...o})});let t="";return Object.entries(E).forEach(([o,i])=>{if(e[o]){t+=`<optgroup label="${i}"${"road"===o?' id="ve-road-animations-group"':""}${"road"===o?' style="display: none;"':""}>`,e[o].forEach(e=>{const o=e.key===this.options.animation?" selected":"";t+=`<option value="${e.key}"${o}>&nbsp;&nbsp;${e.label}</option>`}),t+="</optgroup>"}}),t}_loadSettings(){const e=localStorage.getItem("maplibre-video-export-settings");return e?JSON.parse(e):T.DEFAULT_SETTINGS}_applySettings(e){Object.entries(e).forEach(([e,t])=>{if(""!==t&&null!=t&&e.endsWith("-custom")){let t=e.replace(/-custom$/,"");t=t.replace(/-(width|height)$/,"");const o=document.getElementById(t);o&&"SELECT"===o.tagName&&(o.value="custom")}}),Object.entries(e).forEach(([e,t])=>{const o=document.getElementById(e);o&&("checkbox"===o.type?o.checked=t:o.value=t,o.dispatchEvent(new Event("change")))})}_saveSettings(){const e={};this._panel.querySelectorAll('input[id^="ve-"], select[id^="ve-"], textarea[id^="ve-"]').forEach(t=>{if("checkbox"===t.type)e[t.id]=t.checked;else if(""!==t.value)if(t.id.endsWith("-custom")){let o=t.id.replace(/-custom$/,"");o=o.replace(/-(width|height)$/,"");const i=document.getElementById(o);"custom"===i?.value&&(e[t.id]=t.value)}else e[t.id]=t.value}),localStorage.setItem("maplibre-video-export-settings",JSON.stringify(e))}_loadWaypoints(){const e=localStorage.getItem("maplibre-video-export-waypoints");if(e)try{return JSON.parse(e)}catch(e){console.warn("[Waypoints] Failed to parse saved waypoints:",e)}return{type:"FeatureCollection",features:[]}}_saveWaypoints(){if(this.options.waypoints)try{localStorage.setItem("maplibre-video-export-waypoints",JSON.stringify(this.options.waypoints)),console.log(`[Waypoints] Saved ${this.options.waypoints.features?.length||0} waypoints to localStorage`)}catch(e){console.error("[Waypoints] Failed to save waypoints:",e)}}_loadSectionStates(){const e=localStorage.getItem("maplibre-video-export-sections"),t={"video-settings":!1,movie:!1,"points-of-interest":!0,"geographic-constraints":!0};return e?{...t,...JSON.parse(e)}:t}_saveSectionStates(){this._sectionStates&&localStorage.setItem("maplibre-video-export-sections",JSON.stringify(this._sectionStates))}_toggleSection(e){this._sectionStates||(this._sectionStates=this._loadSectionStates());const t=this._panel?.querySelector(`[data-section="${e}"]`),o=this._panel?.querySelector(`[data-section-content="${e}"]`),i=t?.querySelector(".section-indicator");if(!t||!o)return;const n=!this._sectionStates[e];this._sectionStates[e]=n,o instanceof HTMLElement&&(o.style.display=n?"none":"block"),i&&(i.textContent=n?"‚ñ∂":"‚ñº"),this._saveSectionStates(),console.log(`[UI] Section "${e}" ${n?"collapsed":"expanded"}`)}_collapseSection(e){this._sectionStates||(this._sectionStates=this._loadSectionStates());const t=this._panel?.querySelector(`[data-section="${e}"]`),o=this._panel?.querySelector(`[data-section-content="${e}"]`),i=t?.querySelector(".section-indicator");t&&o&&(this._sectionStates[e]=!0,o instanceof HTMLElement&&(o.style.display="none"),i&&(i.textContent="‚ñ∂"),this._saveSectionStates(),console.log(`[UI] Section "${e}" collapsed`))}_createUI(){if(!this._container)return;const e=document.createElement("div");e.className="maplibregl-ctrl-group";const t=document.createElement("button");t.className="maplibregl-ctrl-icon",t.type="button",t.title="Export Video",t.innerHTML='\n            <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor">\n                <circle cx="12" cy="12" r="10" stroke-width="2"/>\n                <path d="M10 8l6 4-6 4V8z" fill="currentColor"/>\n                <circle cx="18" cy="6" r="3" fill="#ef4444" stroke="#b91c1c" stroke-width="1"/>\n            </svg>\n        ',t.addEventListener("click",()=>this._togglePanel()),e.appendChild(t),this._progressWidget=document.createElement("div"),this._progressWidget.className="maplibregl-ctrl-progress-widget",this._progressWidget.style.display="none",this._progressWidget.innerHTML='\n            <style>\n                .maplibregl-ctrl-progress-widget {\n                    background: rgba(255, 255, 255, 0.95);\n                    border-radius: 6px;\n                    padding: 12px;\n                    margin-top: 12px;\n                    border: 1px solid rgba(0, 0, 0, 0.1);\n                    font-size: 12px;\n                    font-family: -apple-system, BlinkMacSystemFont, \'Segoe UI\', Roboto, \'Helvetica Neue\', Arial, sans-serif;\n                    line-height: 1.5;\n                    color: #333;\n                }\n                .maplibregl-ctrl-progress-widget .progress-status {\n                    color: #555;\n                    font-weight: 500;\n                    font-size: 11px;\n                    text-transform: uppercase;\n                    letter-spacing: 0.5px;\n                }\n                .maplibregl-ctrl-progress-widget .progress-percent {\n                    color: #4CAF50;\n                    font-weight: 600;\n                    font-size: 14px;\n                }\n                .maplibregl-ctrl-progress-widget .progress-time {\n                    color: #1976D2;\n                    font-weight: 500;\n                }\n                .maplibregl-ctrl-progress-widget .progress-secondary {\n                    color: #888;\n                }\n                .maplibregl-ctrl-progress-widget .progress-separator {\n                    color: #888;\n                }\n                /* Override MapLibre popup constraints for waypoint popups */\n                .maplibregl-popup-content:has(.ve-waypoint-popup) {\n                    max-width: none !important;\n                    padding: 10px !important;\n                }\n                .maplibregl-popup {\n                    max-width: none !important;\n                }\n                .ve-waypoint-popup {\n                    box-sizing: border-box;\n                }\n                .ve-waypoint-popup h3 {\n                    margin: 0 0 8px 0 !important;\n                }\n\n                @media (prefers-color-scheme: dark) {\n                    .maplibregl-ctrl-progress-widget {\n                        background: rgba(42, 42, 42, 0.95);\n                        color: #e0e0e0;\n                        border-color: rgba(255, 255, 255, 0.1);\n                    }\n                    .maplibregl-ctrl-progress-widget .progress-status {\n                        color: #999;\n                    }\n                }\n            </style>\n            <div style="margin-bottom: 3px;">\n                <span class="progress-status" id="ve-progress-status">Recording</span>\n            </div>\n            <div>\n                <span class="progress-percent" id="ve-progress-percent">0% complete</span>\n                <span class="progress-separator" style="margin: 0 4px;">‚Ä¢</span>\n                <span class="progress-secondary" id="ve-progress-frames">Frame 0 of 0</span>\n            </div>\n            <div style="margin-top: 2px; font-size: 11px;">\n                <span class="progress-secondary" id="ve-progress-size">Size: ~0 MB</span>\n                <span class="progress-separator" style="margin: 0 4px;">‚Ä¢</span>\n                <span class="progress-time" id="ve-progress-time">calculating time...</span>\n            </div>\n            \x3c!-- Final stats summary (hidden during recording, shown at end) --\x3e\n            <div id="ve-progress-summary" style="display: none; margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(0,0,0,0.1);">\n                <div style="margin-bottom: 4px;">\n                    <span class="progress-status">‚úÖ Export Complete</span>\n                </div>\n                <div style="font-size: 11px; line-height: 1.6;">\n                    <div><strong>Video:</strong> <span id="ve-summary-video">-</span></div>\n                    <div><strong>Real time:</strong> <span id="ve-summary-realtime">-</span></div>\n                    <div><strong>Speed:</strong> <span id="ve-summary-speed">-</span></div>\n                    <div><strong>Size:</strong> <span id="ve-summary-size">-</span></div>\n                </div>\n            </div>\n        ',this._container.appendChild(e),this._panel=document.createElement("div"),this._panel.className="maplibre-gl-video-export-panel",this._panel.style.display="none",this._panel.innerHTML=`\n            <style>\n                /* Invisible overlay to capture clicks outside panel */\n                .maplibre-gl-video-export-overlay {\n                    position: absolute;\n                    top: 0;\n                    left: 0;\n                    right: 0;\n                    bottom: 0;\n                    z-index: 999;\n                    opacity: 0;\n                    pointer-events: none;\n                }\n\n                .maplibre-gl-video-export-overlay[data-visible="true"] {\n                    opacity: 1;\n                    pointer-events: auto;\n                }\n\n                /* Centered panel within map container */\n                .maplibre-gl-video-export-panel {\n                    position: absolute;\n                    top: 50%;\n                    left: 50%;\n                    transform: translate(-50%, calc(-50% + 20px)) scale(0.95);\n                    background: rgba(255, 255, 255, 0.95);\n                    border-radius: 12px;\n                    box-shadow: 0 8px 32px rgba(0,0,0,0.3);\n                    padding: 20px;\n                    width: 420px;\n                    max-width: 90%;\n                    max-height: 90%;\n                    overflow-y: auto;\n                    z-index: 1000;\n                    opacity: 0;\n                    transition: opacity 0.3s ease-out, transform 0.3s ease-out;\n                    pointer-events: none;\n                    height: auto;\n                }\n\n                .maplibre-gl-video-export-panel[data-visible="true"] {\n                    opacity: 1;\n                    transform: translate(-50%, -50%) scale(1);\n                    pointer-events: auto;\n                }\n\n                /* Compact mode: panel positioning during test/record */\n                .maplibre-gl-video-export-panel.compact-top-left {\n                    top: 10px;\n                    left: 10px;\n                    transform: translate(-20px, -20px) scale(0.95);\n                    min-width: 280px;\n                    max-width: 320px;\n                }\n\n                .maplibre-gl-video-export-panel.compact-top-left[data-visible="true"] {\n                    transform: translate(0, 0) scale(1);\n                }\n\n                .maplibre-gl-video-export-panel.compact-top-right {\n                    top: 10px;\n                    right: 10px;\n                    left: auto;\n                    transform: translate(20px, -20px) scale(0.95);\n                    min-width: 280px;\n                    max-width: 320px;\n                }\n\n                .maplibre-gl-video-export-panel.compact-top-right[data-visible="true"] {\n                    transform: translate(0, 0) scale(1);\n                }\n\n                .maplibre-gl-video-export-panel.compact-bottom-left {\n                    bottom: 10px;\n                    left: 10px;\n                    top: auto;\n                    transform: translate(-20px, 20px) scale(0.95);\n                    min-width: 280px;\n                    max-width: 320px;\n                }\n\n                .maplibre-gl-video-export-panel.compact-bottom-left[data-visible="true"] {\n                    transform: translate(0, 0) scale(1);\n                }\n\n                .maplibre-gl-video-export-panel.compact-bottom-right {\n                    bottom: 10px;\n                    right: 10px;\n                    top: auto;\n                    left: auto;\n                    transform: translate(20px, 20px) scale(0.95);\n                    min-width: 280px;\n                    max-width: 320px;\n                }\n\n                .maplibre-gl-video-export-panel.compact-bottom-right[data-visible="true"] {\n                    transform: translate(0, 0) scale(1);\n                }\n\n                /* Smooth scrollbar for panel content */\n                .maplibre-gl-video-export-panel::-webkit-scrollbar {\n                    width: 8px;\n                }\n\n                .maplibre-gl-video-export-panel::-webkit-scrollbar-track {\n                    background: rgba(0, 0, 0, 0.05);\n                    border-radius: 4px;\n                }\n\n                .maplibre-gl-video-export-panel::-webkit-scrollbar-thumb {\n                    background: rgba(0, 0, 0, 0.2);\n                    border-radius: 4px;\n                }\n\n                .maplibre-gl-video-export-panel::-webkit-scrollbar-thumb:hover {\n                    background: rgba(0, 0, 0, 0.3);\n                }\n\n                @media (prefers-color-scheme: dark) {\n                    .maplibre-gl-video-export-panel {\n                        background: rgba(40, 40, 40, 0.95);\n                        color: #e0e0e0;\n                    }\n                    .maplibre-gl-video-export-panel::-webkit-scrollbar-track {\n                        background: rgba(255, 255, 255, 0.05);\n                    }\n                    .maplibre-gl-video-export-panel::-webkit-scrollbar-thumb {\n                        background: rgba(255, 255, 255, 0.2);\n                    }\n                    .maplibre-gl-video-export-panel::-webkit-scrollbar-thumb:hover {\n                        background: rgba(255, 255, 255, 0.3);\n                    }\n                }\n                .maplibre-gl-video-export-panel h3 {\n                    margin: 0 0 10px 0;\n                    font-size: 14px;\n                    color: #333;\n                }\n                .maplibre-gl-video-export-panel .form-group {\n                    margin-bottom: 10px;\n                }\n                .maplibre-gl-video-export-panel label {\n                    display: block;\n                    font-size: 12px;\n                    margin-bottom: 3px;\n                    color: #666;\n                }\n                .maplibre-gl-video-export-panel select,\n                .maplibre-gl-video-export-panel input[type="number"],\n                .maplibre-gl-video-export-panel input[type="text"] {\n                    width: 100%;\n                    padding: 5px;\n                    border: 1px solid #ddd;\n                    border-radius: 3px;\n                    font-size: 12px;\n                }\n                .maplibre-gl-video-export-panel input[type="checkbox"] {\n                    margin: 0 6px 0 0;\n                    padding: 0;\n                    vertical-align: middle;\n                }\n                .maplibre-gl-video-export-panel label:has(input[type="checkbox"]) {\n                    display: block;\n                    cursor: pointer;\n                    margin-bottom: 5px;\n                    line-height: 1.4;\n                }\n\n                /* Timing Table - Style 2 (Subtle Background) */\n                .ve-timing-table {\n                    width: 100%;\n                    border-collapse: collapse;\n                    border: 1px solid #dee2e6;\n                    border-radius: 4px;\n                    overflow: hidden;\n                }\n                .ve-timing-table th {\n                    font-size: 11px;\n                    font-weight: 500;\n                    padding: 8px 10px;\n                    text-align: left;\n                    background: #f8f9fa;\n                    border-bottom: 1px solid #dee2e6;\n                    color: #495057;\n                }\n                .ve-timing-table td {\n                    padding: 8px 10px;\n                    background: white;\n                }\n                .ve-timing-table th + th,\n                .ve-timing-table td + td {\n                    border-left: 1px solid #dee2e6;\n                }\n                /* Column widths (anti-jumping) */\n                .ve-timing-table th:nth-child(1),\n                .ve-timing-table td:nth-child(1) {\n                    width: 50%;\n                }\n                .ve-timing-table th:nth-child(2),\n                .ve-timing-table td:nth-child(2) {\n                    width: 30%;\n                }\n                .ve-timing-table th:nth-child(3),\n                .ve-timing-table td:nth-child(3) {\n                    width: 20%;\n                }\n                .ve-timing-table select,\n                .ve-timing-table input[type="number"] {\n                    padding: 4px 6px;\n                    font-size: 12px;\n                    border: 1px solid #ccc;\n                    border-radius: 3px;\n                }\n                .ve-timing-table abbr {\n                    text-decoration: none;\n                    border-bottom: 1px dotted #999;\n                    cursor: help;\n                }\n\n                .maplibre-gl-video-export-panel .recording-time-display {\n                    text-align: center;\n                    padding: 10px;\n                    margin-top: 15px;\n                    margin-bottom: 10px;\n                    background: #e3f2fd;\n                    border-radius: 4px;\n                    font-size: 14px;\n                    color: #1976d2;\n                }\n                .maplibre-gl-video-export-panel .button-group {\n                    display: flex;\n                    gap: 10px;\n                }\n                .maplibre-gl-video-export-panel button {\n                    flex: 1;\n                    padding: 8px;\n                    border: none;\n                    border-radius: 4px;\n                    font-size: 12px;\n                    cursor: pointer;\n                    transition: background 0.2s;\n                    min-height: 36px;\n                    display: flex;\n                    align-items: center;\n                    justify-content: center;\n                }\n                .maplibre-gl-video-export-panel .btn-primary {\n                    background: #3887be;\n                    color: white;\n                }\n                .maplibre-gl-video-export-panel .btn-primary:hover {\n                    background: #2e7bb3;\n                }\n                .maplibre-gl-video-export-panel .btn-secondary {\n                    background: #f0f0f0;\n                    color: #333;\n                }\n                .maplibre-gl-video-export-panel .btn-secondary:hover {\n                    background: #e0e0e0;\n                }\n                .maplibre-gl-video-export-panel .btn-compact {\n                    padding: 6px !important; /* Smaller buttons for compact areas */\n                    font-size: 11px;\n                }\n                .maplibre-gl-video-export-panel .btn-mini {\n                    padding: 4px !important; /* Mini buttons for tight spaces */\n                    font-size: 11px;\n                }\n                .maplibre-gl-video-export-panel .status {\n                    margin-top: 10px;\n                    padding: 8px;\n                    background: #f0f0f0;\n                    border-radius: 3px;\n                    font-size: 11px;\n                    text-align: center;\n                    color: #666;\n                }\n                .maplibre-gl-video-export-ctrl > .maplibregl-ctrl-group {\n                    border-bottom-right-radius: unset;\n                    border-bottom-left-radius: unset;\n                }\n                .maplibre-gl-video-export-panel .status.recording {\n                    background: #ffebee;\n                    color: #c62828;\n                    animation: pulse 1s infinite;\n                }\n                .maplibre-gl-video-export-panel .status.success {\n                    background: #e8f5e9;\n                    color: #2e7d32;\n                }\n                .maplibre-gl-video-export-panel .status.error {\n                    background: #ffebee;\n                    color: #c62828;\n                }\n                small {\n                    font-size: 0.9em;\n                }\n                @keyframes pulse {\n                    0%, 100% { opacity: 1; }\n                    50% { opacity: 0.7; }\n                }\n\n                /* Dark mode support */\n                @media (prefers-color-scheme: dark) {\n                    /* Control group and button dark mode */\n                    .maplibre-gl-video-export-ctrl .maplibregl-ctrl-group {\n                        background: #2d2d2d;\n                    }\n                    .maplibre-gl-video-export-ctrl .maplibregl-ctrl-group button {\n                        background: transparent;\n                        border: none;\n                        color: #e0e0e0;  /* currentColor h√©rite de cette couleur */\n                    }\n                    .maplibre-gl-video-export-ctrl .maplibregl-ctrl-group button:hover {\n                        background: rgba(255, 255, 255, 0.1);\n                    }\n\n                    /* Panel dark mode */\n                    .maplibre-gl-video-export-panel {\n                        background: #2d2d2d;\n                        box-shadow: 0 2px 8px rgba(0,0,0,0.5);\n                    }\n                    .maplibre-gl-video-export-panel h3 {\n                        color: #e0e0e0;\n                    }\n                    .maplibre-gl-video-export-panel label {\n                        color: #b0b0b0;\n                    }\n                    .maplibre-gl-video-export-panel select,\n                    .maplibre-gl-video-export-panel input {\n                        background: #3d3d3d;\n                        border: 1px solid #555;\n                        color: #e0e0e0;\n                    }\n                    .maplibre-gl-video-export-panel select option {\n                        background: #3d3d3d;\n                        color: #e0e0e0;\n                    }\n                    .maplibre-gl-video-export-panel .btn-secondary {\n                        background: #3d3d3d;\n                        color: #e0e0e0;\n                    }\n                    .maplibre-gl-video-export-panel .btn-secondary:hover {\n                        background: #4d4d4d;\n                    }\n                    .maplibre-gl-video-export-panel .status {\n                        background: #3d3d3d;\n                        color: #b0b0b0;\n                    }\n                    .maplibre-gl-video-export-panel .status.recording {\n                        background: #4d2020;\n                        color: #ff8a80;\n                    }\n                    .maplibre-gl-video-export-panel .status.success {\n                        background: #1b4d1b;\n                        color: #81c784;\n                    }\n                    .maplibre-gl-video-export-panel .status.error {\n                        background: #4d2020;\n                        color: #ff8a80;\n                    }\n                    .maplibre-gl-video-export-panel small {\n                        color: #888 !important;\n                    }\n                    .maplibre-gl-video-export-panel .recording-time-display {\n                        background: #1e3a5f;\n                        color: #64b5f6;\n                    }\n                    /* Additional dark mode support for waypoints */\n                    .ve-waypoint-item {\n                        background: #2a2a2a !important;\n                        color: #e0e0e0 !important;\n                    }\n                    #ve-icon-size-control {\n                        background: rgba(42, 42, 42, 0.8) !important;\n                    }\n                    #ve-waypoint-editor {\n                        border-top-color: #444 !important;\n                    }\n                    #ve-icon-preview {\n                        background: #333 !important;\n                        border-color: #444 !important;\n                    }\n                    #ve-waypoints-list {\n                        background: transparent !important;\n                    }\n                    .ve-wp-edit {\n                        background: #1a5490 !important;\n                    }\n                    .ve-wp-delete {\n                        background: #aa3333 !important;\n                    }\n                    #ve-wp-save {\n                        background: #2a6b2a !important;\n                    }\n                    #ve-icon-size-value {\n                        color: #b0b0b0 !important;\n                    }\n                    /* Section groups dark mode */\n                    #ve-video-settings-group,\n                    #ve-movie-group,\n                    #ve-waypoints-group,\n                    #ve-constraints-group {\n                        background: rgba(255, 255, 255, 0.03) !important;\n                        border-color: #444 !important;\n                        box-shadow: 0 1px 3px rgba(0,0,0,0.2) !important;\n                    }\n                    #ve-waypoints-group > div:first-child span {\n                        color: #b0b0b0 !important;\n                    }\n                    #ve-waypoints-group > div:first-child {\n                        border-bottom-color: rgba(255,255,255,0.1) !important;\n                    }\n                    #ve-constraints-group > div:first-child span {\n                        color: #b0b0b0 !important;\n                    }\n                    #ve-constraints-group > div:first-child {\n                        border-bottom-color: rgba(255,255,255,0.1) !important;\n                    }\n                    /* Timing table dark mode */\n                    .ve-timing-table {\n                        border-color: #444;\n                    }\n                    .ve-timing-table th {\n                        background: #3d3d3d;\n                        border-bottom-color: #444;\n                        color: #b0b0b0;\n                    }\n                    .ve-timing-table td {\n                        background: #2a2a2a;\n                    }\n                    .ve-timing-table th + th,\n                    .ve-timing-table td + td {\n                        border-left-color: #444;\n                    }\n                    #ve-real-time {\n                        color: #888 !important;\n                    }\n                    /* Waypoint popup dark mode */\n                    .maplibregl-popup-content {\n                        background: #2d2d2d !important;\n                        color: #e0e0e0 !important;\n                    }\n                    .maplibregl-popup-content h3 {\n                        color: #e0e0e0 !important;\n                    }\n                    .maplibregl-popup-content label {\n                        color: #b0b0b0 !important;\n                    }\n                    .maplibregl-popup-content small {\n                        color: #888 !important;\n                    }\n                    .maplibregl-popup-content input,\n                    .maplibregl-popup-content select {\n                        background: #3d3d3d !important;\n                        color: #e0e0e0 !important;\n                        border-color: #555 !important;\n                    }\n                    .maplibregl-popup-content input:disabled {\n                        background: #2a2a2a !important;\n                        color: #666 !important;\n                    }\n                    .maplibregl-popup-content input::placeholder {\n                        color: #666 !important;\n                    }\n                    /* Popup icon preview dark mode */\n                    .maplibregl-popup-content [id^="ve-popup-icon-preview-"] {\n                        background: #3d3d3d !important;\n                        border-color: #555 !important;\n                    }\n                    /* Popup buttons dark mode */\n                    .maplibregl-popup-content .ve-popup-save {\n                        background: #2e7d32 !important;\n                    }\n                    .maplibregl-popup-content .ve-popup-cancel {\n                        background: #666 !important;\n                    }\n                    .maplibregl-popup-content .ve-popup-delete {\n                        background: #c62828 !important;\n                    }\n                    .maplibregl-popup-tip {\n                        border-top-color: #2d2d2d !important;\n                        border-bottom-color: #2d2d2d !important;\n                    }\n                    /* Popup scrollbar dark mode */\n                    .ve-waypoint-popup::-webkit-scrollbar {\n                        width: 8px;\n                    }\n                    .ve-waypoint-popup::-webkit-scrollbar-track {\n                        background: rgba(255, 255, 255, 0.05);\n                        border-radius: 4px;\n                    }\n                    .ve-waypoint-popup::-webkit-scrollbar-thumb {\n                        background: rgba(255, 255, 255, 0.2);\n                        border-radius: 4px;\n                    }\n                    .ve-waypoint-popup::-webkit-scrollbar-thumb:hover {\n                        background: rgba(255, 255, 255, 0.3);\n                    }\n                }\n            </style>\n\n            \x3c!-- Reset button --\x3e\n            <div style="margin-bottom: 15px; text-align: right;">\n                <a href="#" id="ve-reset-defaults" style="font-size: 11px; color: #666; text-decoration: none; padding: 4px 8px; border: 1px solid #ddd; border-radius: 3px; display: inline-block;">‚Üª Reset to Defaults</a>\n            </div>\n\n            \x3c!-- Reset message (hidden by default) --\x3e\n            <div id="ve-reset-message" style="display: none; background: #fff3cd; border: 1px solid #ffc107; color: #856404; padding: 10px; border-radius: 4px; margin-bottom: 15px; font-size: 12px;">\n                Settings reset to defaults. <a href="#" id="ve-cancel-reset" style="color: #856404; font-weight: bold;">Cancel</a> or Run to save.\n            </div>\n\n            \x3c!-- VIDEO SETTINGS Section --\x3e\n\n            <h3 data-section="video-settings" style="cursor: pointer; user-select: none;">\n              <span class="section-indicator">‚ñº</span> üé¨ VIDEO SETTINGS\n            </h3>\n\n            <div data-section-content="video-settings">\n\n              <div id="ve-video-settings-group" style="padding: 15px; background: rgba(0,0,0,0.05); border: 1px solid #ddd; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">\n\n                  \x3c!-- Section Header --\x3e\n                  <div style="margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid rgba(0,0,0,0.1);">\n                      <span style="font-size: 11px; font-weight: 600; color: #555; text-transform: uppercase; letter-spacing: 0.5px;">\n                        Configuration\n                      </span>\n                  </div>\n\n              <div class="form-group">\n                  <label for="ve-resolution"><h4>Resolution</h4></label>\n                  <select id="ve-resolution">\n                      <option value="auto" selected>Auto (Current Size)</option>\n                      <option value="hd">HD (1280√ó720)</option>\n                      <option value="fullhd">Full HD (1920√ó1080)</option>\n                      <option value="4k">4K (3840√ó2160)</option>\n                      <option value="8k">8K (7680√ó4320)</option>\n                      <option value="custom">Custom...</option>\n                  </select>\n              </div>\n\n              <div class="form-group">\n                  <label for="ve-cinematic-bars"><h4>Cinematic Bars</h4></label>\n                  <select id="ve-cinematic-bars">\n                      <option value="none" selected>None</option>\n                      <option value="2.39">2.39:1 (Scope)</option>\n                      <option value="1.85">1.85:1 (Cinema)</option>\n                      <option value="2.33">21:9 (Ultrawide)</option>\n                  </select>\n                  <small style="color: #999;">Add black bars for cinematic aspect ratios</small>\n              </div>\n\n              <div class="form-group" id="ve-resolution-custom-group" style="display:none;">\n                  <label>Custom Resolution</label>\n                  <div style="display: flex; gap: 5px; align-items: center;">\n                      <input type="number" id="ve-resolution-width-custom" value="1920" step="16" placeholder="Width" style="flex: 1;">\n                      <span style="color: #999;">√ó</span>\n                      <input type="number" id="ve-resolution-height-custom" value="1080" step="16" placeholder="Height" style="flex: 1;">\n                  </div>\n                  <small style="color: #999;">Dimensions should be multiples of 16</small>\n              </div>\n\n              \x3c!-- Timing Table --\x3e\n              <div class="form-group" style="margin-top: 12px;">\n                  <label style="margin-bottom: 6px;"><h4>Timing</h4></label>\n                  <table class="ve-timing-table">\n                      <thead>\n                          <tr>\n                              <th>Virtual time</th>\n                              <th>Speed</th>\n                              <th><abbr title="Frames per second">FPS</abbr></th>\n                          </tr>\n                      </thead>\n                      <tbody>\n                          <tr>\n                              <td>\n                                  <select id="ve-duration" style="width: 100%;">\n                                      <option value="3">3s</option>\n                                      <option value="5">5s</option>\n                                      <option value="10">10s</option>\n                                      <option value="15">15s</option>\n                                      <option value="30" selected>30s</option>\n                                      <option value="60">1m</option>\n                                      <option value="custom">Custom...</option>\n                                  </select>\n                              </td>\n                              <td>\n                                  <select id="ve-speed" style="width: 100%;">\n                                      <option value="0.25">0.25x</option>\n                                      <option value="0.5">0.5x</option>\n                                      <option value="1" selected>1x</option>\n                                      <option value="2">2x</option>\n                                      <option value="4">4x</option>\n                                      <option value="custom">Custom...</option>\n                                  </select>\n                              </td>\n                              <td>\n                                  <input type="number" id="ve-fps" value="60" min="1" max="120" step="0.01" style="width: 100%; text-align: center;">\n                              </td>\n                          </tr>\n                      </tbody>\n                  </table>\n                  <div id="ve-real-time" style="font-size: 11px; color: #666; font-style: italic; margin-top: 6px;">\n                      Real capture time: ~30s\n                  </div>\n              </div>\n\n              \x3c!-- Custom duration input (hidden) --\x3e\n              <div class="form-group" id="ve-duration-custom-group" style="display:none;">\n                  <label>Custom Virtual Time (seconds)</label>\n                  <input type="number" id="ve-duration-custom" value="30" min="1">\n              </div>\n\n              \x3c!-- Custom speed input (hidden) --\x3e\n              <div class="form-group" id="ve-speed-custom-group" style="display:none;">\n                  <label>Custom Speed Multiplier</label>\n                  <input type="number" id="ve-speed-custom" value="1" step="0.1" min="0.1">\n                  <small style="color: #999;">1.0 = real-time, 2.0 = twice as fast</small>\n              </div>\n\n              \x3c!-- Video Format Section --\x3e\n              <div class="form-group" style="margin-top: 12px;">\n                  <label for="ve-format"><h4>Format</h4></label>\n                  <select id="ve-format">\n                      <option value="webm-vp8">WebM (VP8) - Good Compatibility</option>\n                      <option value="webm-vp9" id="ve-format-vp9">WebM (VP9) ‚≠ê Recommended - Best Quality [Auto-selected if supported]</option>\n                      <option value="mp4">MP4 (H.264) - Legacy Compatibility</option>\n                  </select>\n                  <small id="ve-format-info" style="display:block; margin-top: 6px; color: #666; line-height: 1.4;"></small>\n              </div>\n\n              <div class="form-group">\n                  <label for="ve-bitrate"><h4>Bitrate</h4></label>\n                  <select id="ve-bitrate">\n                      <option value="auto" selected>Auto</option>\n                      <option value="5000">5 Mbps (HD)</option>\n                      <option value="8000">8 Mbps (Full HD)</option>\n                      <option value="12000">12 Mbps (2K)</option>\n                      <option value="20000">20 Mbps (4K)</option>\n                      <option value="custom">Custom...</option>\n                  </select>\n              </div>\n\n              <div class="form-group" id="ve-bitrate-custom-group" style="display:none;">\n                  <label>Custom Bitrate (kbps)</label>\n                  <input type="number" id="ve-bitrate-custom" value="8000" step="1000" min="100">\n                  <small style="color: #999;">Higher = better quality but larger file</small>\n              </div>\n\n              \x3c!-- Format-specific settings --\x3e\n              <div class="form-group">\n                  <label>\n                      <input type="checkbox" id="ve-format-advanced-toggle">\n                      Format-specific settings\n                  </label>\n              </div>\n\n              <div id="ve-format-advanced-group" style="display:none; padding: 10px; background: rgba(0,0,0,0.03); border-radius: 4px; margin-top: -5px;">\n                  \x3c!-- MP4 Advanced Settings --\x3e\n                  <div id="ve-mp4-advanced" style="display:none;">\n                      <div class="form-group">\n                          <label>Encoding Speed</label>\n                          <select id="ve-mp4-speed">\n                              <option value="10">Fast (default)</option>\n                              <option value="5" selected>Balanced</option>\n                              <option value="0">Best Quality (slow)</option>\n                          </select>\n                          <small style="color: #999;">Slower = better compression</small>\n                      </div>\n\n                      <div class="form-group">\n                          <label>Quality (QP)</label>\n                          <select id="ve-mp4-qp">\n                              <option value="10,42" selected>Standard</option>\n                              <option value="5,35">High Quality</option>\n                              <option value="15,45">Smaller File</option>\n                          </select>\n                          <small style="color: #999;">Lower QP = better quality</small>\n                      </div>\n\n                      <div class="form-group">\n                          <label>Keyframe Interval</label>\n                          <select id="ve-mp4-gop">\n                              <option value="30" selected>Standard (30)</option>\n                              <option value="10">Frequent (10)</option>\n                              <option value="60">Sparse (60)</option>\n                          </select>\n                          <small style="color: #999;">More keyframes = easier editing</small>\n                      </div>\n                  </div>\n\n                  \x3c!-- WebM VP8 Settings --\x3e\n                  <div id="ve-webm-vp8-advanced" style="display:none;">\n                      <div style="padding: 8px; background: rgba(46, 125, 50, 0.1); border-radius: 4px; margin-bottom: 10px;">\n                          <small style="color: #2e7d32;">‚ÑπÔ∏è VP8 optimized for broad compatibility. Bitrate auto-adjusted for quality.</small>\n                      </div>\n                      <div class="form-group">\n                          <label>Bitrate Override</label>\n                          <input type="number" id="ve-vp8-bitrate-custom" placeholder="Auto" step="1000" min="1000">\n                          <small style="color: #999;">Leave empty for auto (recommended). Custom bitrate in kbps.</small>\n                      </div>\n                      <small style="color: #999;">üí° For advanced controls, use WebM VP9 format (Modern browsers).</small>\n                  </div>\n\n                  \x3c!-- WebM VP9 Settings --\x3e\n                  <div id="ve-webm-vp9-advanced" style="display:none;">\n                      <div style="padding: 8px; background: rgba(25, 118, 210, 0.1); border-radius: 4px; margin-bottom: 10px;">\n                          <small style="color: #1976d2;">üåü VP9 High Quality - Hardware Accelerated (WebCodecs)</small>\n                      </div>\n\n                      <div class="form-group">\n                          <label>Quality Preset</label>\n                          <select id="ve-vp9-quality">\n                              <option value="medium">Medium (fast, smaller)</option>\n                              <option value="high" selected>High (balanced)</option>\n                              <option value="very-high">Very High (best quality)</option>\n                          </select>\n                          <small style="color: #999;">Higher quality = larger file & slower encoding</small>\n                      </div>\n\n                      <div class="form-group">\n                          <label>Encoding Mode</label>\n                          <select id="ve-vp9-latency">\n                              <option value="quality" selected>Quality (slower, better)</option>\n                              <option value="realtime">Realtime (faster, good)</option>\n                          </select>\n                          <small style="color: #999;">Realtime mode useful for long videos</small>\n                      </div>\n\n                      <div class="form-group">\n                          <label>Bitrate Mode</label>\n                          <select id="ve-vp9-bitrate-mode">\n                              <option value="variable" selected>Variable (VBR) - Recommended</option>\n                              <option value="constant">Constant (CBR)</option>\n                          </select>\n                          <small style="color: #999;">VBR gives better quality at same file size</small>\n                      </div>\n\n                      <div class="form-group">\n                          <label>Keyframe Interval (frames)</label>\n                          <input type="number" id="ve-vp9-keyframe" value="120" min="10" max="300" step="10">\n                          <small style="color: #999;">Lower = better seeking, larger file. Default: 120 (2s @ 60fps)</small>\n                      </div>\n\n                      <div class="form-group">\n                          <label>Content Optimization</label>\n                          <select id="ve-vp9-content-hint">\n                              <option value="" selected>Auto</option>\n                              <option value="motion">Motion (aerial views, animations)</option>\n                              <option value="detail">Detail (fine map details)</option>\n                              <option value="text">Text (overlays, labels)</option>\n                          </select>\n                          <small style="color: #999;">Optimizes encoder for content type</small>\n                      </div>\n                  </div>\n              </div>\n\n              <div class="form-group">\n                  <label>\n                      <input type="checkbox" id="ve-wait-tiles" checked>\n                      Wait for tiles to load\n                  </label>\n                  <small style="color: #999;">Try to ensures all tiles are loaded (slower but better quality)</small>\n              </div>\n\n              </div> \x3c!-- End ve-video-settings-group --\x3e\n\n            </div>\n\n            \x3c!-- Section Separator --\x3e\n            <hr style="border: none; border-top: 1px solid #ddd; margin: 20px 0;">\n\n            \x3c!-- MOVIE Section --\x3e\n\n            <h3 data-section="movie" style="cursor: pointer; user-select: none;">\n              <span class="section-indicator">‚ñº</span> üéûÔ∏è MOVIE\n            </h3>\n\n            <div data-section-content="movie">\n\n              <div id="ve-movie-group" style="padding: 15px; background: rgba(0,0,0,0.05); border: 1px solid #ddd; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">\n\n                  \x3c!-- Section Header --\x3e\n                  <div style="margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid rgba(0,0,0,0.1);">\n                      <span style="font-size: 11px; font-weight: 600; color: #555; text-transform: uppercase; letter-spacing: 0.5px;">\n                        Configuration\n                      </span>\n                  </div>\n\n              <div class="form-group">\n                  <label for="ve-animation"><h4>Animation</h4></label>\n                  <select id="ve-animation">\n                      ${this._generateAnimationOptions()}\n                  </select>\n                  <small style="color: #999; display: block; margin-top: 3px;">\n                      üí° Tip: Most animations adapt to show all waypoints when present (happily or not)\n                  </small>\n\n                  \x3c!-- Animation Description --\x3e\n                  <div id="ve-animation-description" style="display: none; margin-top: 8px; padding: 10px; background: rgba(33, 150, 243, 0.08); border-left: 3px solid #2196F3; border-radius: 4px;">\n                      <span style="color: #1976D2; font-size: 13px; line-height: 1.5;"></span>\n                  </div>\n\n                  \x3c!-- Capability Feedback UI --\x3e\n                  <div id="ve-capability-feedback" style="display: none; margin-top: 8px;">\n                      \x3c!-- Dynamically filled with capability analysis --\x3e\n                  </div>\n              </div>\n\n              <div class="form-group">\n                  <label for="ve-loop"><h4>Loop Animation</h4></label>\n                  <select id="ve-loop">\n                      <option value="false">No loop</option>\n                      <option value="true">Loop (instant jump)</option>\n                      <option value="smooth">Loop (smooth transition)</option>\n                  </select>\n                  <small style="color: #999;">Return to start position for seamless video loops (some does not need this param)</small>\n              </div>\n\n              </div> \x3c!-- End ve-movie-group --\x3e\n\n            </div>\n\n            <hr style="border: none; border-top: 1px solid #ddd; margin: 20px 0;">\n\n            \x3c!-- Waypoints Section --\x3e\n\n            <h3 data-section="points-of-interest" style="cursor: pointer; user-select: none;">\n              <span class="section-indicator">‚ñº</span>\n              <svg width="20" height="20" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle; margin-right: 4px;">\n                <defs>\n                  <linearGradient id="poi-star-gradient" x1="0%" y1="0%" x2="100%" y2="100%">\n                    <stop offset="0%" style="stop-color:#ffd700;stop-opacity:1" />\n                    <stop offset="100%" style="stop-color:#ffed4e;stop-opacity:1" />\n                  </linearGradient>\n                </defs>\n                <path d="M12 2 L15 9 L22 10 L17 15 L18 22 L12 18 L6 22 L7 15 L2 10 L9 9 Z"\n                      fill="url(#poi-star-gradient)" stroke="#d4af37" stroke-width="1"/>\n              </svg> POINTS OF INTEREST\n            </h3>\n\n            <div data-section-content="points-of-interest">\n\n              <div id="ve-waypoints-group" style="padding: 15px; background: rgba(0,0,0,0.05); border: 1px solid #ddd; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">\n\n                  \x3c!-- Section Header --\x3e\n                  <div style="margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid rgba(0,0,0,0.1);">\n                      <div style="display: flex; justify-content: space-between; align-items: center;">\n                          <span style="font-size: 11px; font-weight: 600; color: #555; text-transform: uppercase; letter-spacing: 0.5px;">\n                            Configuration\n                          </span>\n                          <small id="ve-icon-mode-status" style="font-size: 10px; color: #666;">\n                              Checking for map icons...\n                          </small>\n                      </div>\n                  </div>\n\n                  \x3c!-- Waypoint Labels Toggle --\x3e\n                  <div style="margin-bottom: 10px; padding: 8px; border-radius: 3px;">\n                      <label style="display: flex; align-items: center; gap: 5px; font-size: 11px; cursor: pointer; color: #555;">\n                          <input type="checkbox" id="ve-show-labels-toggle" style="margin: 0;">\n                          <span style="color: #555; font-weight: 500;">Show Waypoint Labels</span>\n                      </label>\n                      <small style="color: #666; display: block; margin-top: 3px;">\n                          Display text labels on waypoints (requires fonts)\n                      </small>\n\n                      \x3c!-- Font Selection (visible only if labels enabled) --\x3e\n                      <div id="ve-font-select-container" style="display: none; margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(0,0,0,0.1);">\n                          <label style="font-size: 10px; color: #666; display: block; margin-bottom: 4px;">\n                              Font Family:\n                          </label>\n                          <select id="ve-font-select" style="width: 100%; padding: 4px; font-size: 11px; border: 1px solid #ccc; border-radius: 3px;">\n                              <option value="">Loading fonts...</option>\n                          </select>\n                          <small id="ve-font-status" style="color: #666; display: block; margin-top: 3px;">\n                              No fonts available\n                          </small>\n                      </div>\n                  </div>\n\n                  \x3c!-- Icon Size Slider --\x3e\n                  <div id="ve-icon-size-control" style="margin-bottom: 10px; padding: 8px; background: rgba(255,255,255,0.5); border-radius: 3px;">\n                      <label style="font-size: 11px; color: #333; font-weight: 500; display: block; margin-bottom: 6px;">\n                          Icon Size: <span id="ve-icon-size-value">1.0√ó</span>\n                      </label>\n                      <input type="range" id="ve-icon-size-slider"\n                            min="0.5" max="3" step="0.1" value="1.0"\n                            style="width: 100%; margin: 0;">\n                  </div>\n\n                  \x3c!-- Waypoints List --\x3e\n                  <div id="ve-waypoints-list" style="max-height: 200px; overflow-y: auto; margin-bottom: 10px;">\n                      \x3c!-- Dynamically filled with waypoints --\x3e\n                      <div style="text-align: center; color: #999; font-size: 12px; padding: 20px 0;">\n                          No waypoints yet. Click "Add draggable Icon" to start.\n                      </div>\n                  </div>\n\n                  \x3c!-- Action Buttons --\x3e\n                  <div style="display: flex; gap: 5px; margin-bottom: 10px;">\n                      <button type="button" id="ve-waypoint-add" class="btn-secondary btn-compact" style="flex: 1;">\n                          üìç Add draggable Icon\n                      </button>\n                      <button type="button" id="ve-waypoint-import" class="btn-secondary btn-compact" style="flex: 1;">\n                          üì• Import JSON\n                      </button>\n                      <button type="button" id="ve-waypoint-export" class="btn-secondary btn-compact" style="flex: 1;" disabled>\n                          üì§ Export\n                      </button>\n                  </div>\n\n              </div>\n\n            </div>\n\n            <hr style="border: none; border-top: 1px solid #ddd; margin: 20px 0;">\n\n            \x3c!-- Geographic Constraints Section --\x3e\n\n            <h3 data-section="geographic-constraints" style="cursor: pointer; user-select: none;">\n              <span class="section-indicator">‚ñº</span> üó∫Ô∏è GEOGRAPHIC CONSTRAINTS\n            </h3>\n\n            <div data-section-content="geographic-constraints">\n\n              <div id="ve-constraints-group" style="padding: 15px; background: rgba(0,0,0,0.05); border: 1px solid #ddd; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">\n\n                  \x3c!-- Section Header --\x3e\n                  <div style="margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid rgba(0,0,0,0.1);">\n                      <span style="font-size: 11px; font-weight: 600; color: #555; text-transform: uppercase; letter-spacing: 0.5px;">\n                        Configuration\n                      </span>\n                  </div>\n\n                  \x3c!-- Bounding Box --\x3e\n                  <div class="form-group">\n                      <label>Bounding Box (Longitude, Latitude)</label>\n                      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">\n                          <input type="number" id="ve-bounds-west" placeholder="West" step="0.001">\n                          <input type="number" id="ve-bounds-east" placeholder="East" step="0.001">\n                          <input type="number" id="ve-bounds-south" placeholder="South" step="0.001">\n                          <input type="number" id="ve-bounds-north" placeholder="North" step="0.001">\n                      </div>\n                      <div style="margin-top: 5px; display: flex; gap: 5px;">\n                          <button type="button" id="ve-bounds-current" class="btn-secondary btn-mini" style="flex: 1;">\n                              üó∫Ô∏è Use Current View\n                          </button>\n                          <button type="button" id="ve-bounds-waypoints" class="btn-secondary btn-mini" style="flex: 1;">\n                              üìê From POIs\n                          </button>\n                      </div>\n                      <small style="color: #999;">Animation will stay within these bounds</small>\n                  </div>\n\n                  \x3c!-- Zoom Limits --\x3e\n                  <div class="form-group">\n                      <label>Zoom Limits</label>\n                      <div style="display: flex; gap: 5px; align-items: center;">\n                          <input type="number" id="ve-zoom-min" placeholder="Min" min="0" max="24" step="0.5" style="flex: 1;">\n                          <span style="color: #999;">to</span>\n                          <input type="number" id="ve-zoom-max" placeholder="Max" min="0" max="24" step="0.5" style="flex: 1;">\n                      </div>\n                      <small style="color: #999;">Zoom will stay between these levels (0-24)</small>\n                  </div>\n\n                  \x3c!-- Strict Mode --\x3e\n                  <div class="form-group">\n                      <label>\n                          <input type="checkbox" id="ve-strict-bounds">\n                          Strict Bounds\n                      </label>\n                      <small style="color: #999;">Strictly enforce bounds (no partial view outside)</small>\n                  </div>\n\n                  \x3c!-- Show Overlay --\x3e\n                  <div class="form-group">\n                      <label>\n                          <input type="checkbox" id="ve-show-bounds">\n                          Show Bounds Overlay\n                      </label>\n                      <small style="color: #999;">Display visual boundary on map during recording</small>\n                  </div>\n              </div>\n\n            </div>\n\n            \x3c!-- Section Separator --\x3e\n            <hr style="border: none; border-top: 1px solid #ddd; margin: 20px 0;">\n\n            <div class="recording-time-display">\n                üìπ <strong>Recording time: <span id="ve-recording-time">30s</span></strong>\n            </div>\n\n            <div style="margin-bottom: 8px;" id="ve-exploration-limit-container">\n                <label style="display: flex; align-items: center; gap: 6px; font-size: 13px; cursor: pointer;">\n                    <input type="checkbox" id="ve-exploration-limit" style="cursor: pointer;">\n                    <span>Limit exploration duration (<span id="ve-exploration-max-duration">300</span>s)</span>\n                </label>\n            </div>\n\n            <div class="button-group">\n                <button class="btn-secondary" id="ve-test">‚ñ∂Ô∏è Test</button>\n                <button class="btn-secondary" id="ve-explore" style="display: none;">üó∫Ô∏è Explore</button>\n                <button class="btn-primary" id="ve-record">üî¥ Record</button>\n            </div>\n\n            <div class="status" id="ve-status">Ready</div>\n        `,this._overlay=document.createElement("div"),this._overlay.className="maplibre-gl-video-export-overlay",this._overlay.style.display="none",this._overlay.addEventListener("click",()=>this._togglePanel());const o=this._map.getContainer();"static"===window.getComputedStyle(o).position&&(o.style.position="relative"),o.appendChild(this._overlay),o.appendChild(this._panel),this._panel.appendChild(this._progressWidget),this._initWaypointsIconSelect();const i=this._loadSettings();this._applySettings(i),this._bindEvents(),this._updateAnimationDescription()}_bindEvents(){if(!this._panel)return;this._sectionStates=this._loadSectionStates(),["video-settings","movie","points-of-interest","geographic-constraints"].forEach(e=>{const t=this._panel.querySelector(`[data-section="${e}"]`),o=this._panel.querySelector(`[data-section-content="${e}"]`),i=t?.querySelector(".section-indicator");if(t&&o){const n=this._sectionStates[e];o.style.display=n?"none":"block",i&&(i.textContent=n?"‚ñ∂":"‚ñº"),t.addEventListener("click",()=>this._toggleSection(e))}}),this._panel.querySelector("#ve-test")?.addEventListener("click",()=>this._testAnimation()),this._panel.querySelector("#ve-explore")?.addEventListener("click",()=>this._startExploration()),this._panel.querySelector("#ve-record")?.addEventListener("click",()=>this._startRecording()),this._panel.querySelector("#ve-reset-defaults")?.addEventListener("click",e=>{if(e.preventDefault(),!confirm("Reset all settings to default values?"))return;this._applySettings(T.DEFAULT_SETTINGS);const t=this._panel.querySelector("#ve-reset-message");t&&(t.style.display="block")}),this._panel.querySelector("#ve-cancel-reset")?.addEventListener("click",e=>{e.preventDefault();const t=this._loadSettings();this._applySettings(t);const o=this._panel.querySelector("#ve-reset-message");o&&(o.style.display="none")});const e=()=>{if(!this._panel)return;const e=this.options.duration/this.options.speedMultiplier,t=Math.round(e/1e3),o=this._panel.querySelector("#ve-recording-time");o&&(o.textContent=`${t}s`)};this._panel.querySelector("#ve-animation")?.addEventListener("change",e=>{this.options.animation=e.target?.value||"orbit",this._updateAnimationDescription(),this._updateExplorationUI()}),this._map.once("idle",()=>{this._checkMapCapabilities()});const t=this._panel.querySelector("#ve-resolution"),o=this._panel.querySelector("#ve-resolution-custom-group"),i=this._panel.querySelector("#ve-resolution-width-custom"),n=this._panel.querySelector("#ve-resolution-height-custom");t?.addEventListener("change",e=>{"custom"===e.target?.value?(o&&(o.style.display="block"),this.options.resolution={width:parseInt(i?.value||"1920",10),height:parseInt(n?.value||"1080",10)}):(o&&(o.style.display="none"),this.options.resolution=e.target?.value||"1920x1080")}),i?.addEventListener("input",e=>{"custom"===t?.value&&(this.options.resolution={width:parseInt(e.target?.value||"1920",10),height:parseInt(n?.value||"1080",10)})}),n?.addEventListener("input",e=>{"custom"===t?.value&&(this.options.resolution={width:parseInt(i?.value||"1920",10),height:parseInt(e.target?.value||"1080",10)})});const r=this._panel.querySelector("#ve-duration"),a=this._panel.querySelector("#ve-duration-custom-group"),s=this._panel.querySelector("#ve-duration-custom"),l=this._panel.querySelector("#ve-real-time");r&&("custom"===r.value?this.options.duration=1e3*parseFloat(s?.value||"30"):this.options.duration=1e3*parseFloat(r.value||"30"));const c=()=>{const t=this.options.duration/1e3/this.options.speedMultiplier;if(l){let e;if(t<60)e=`~${Math.round(t)}s`;else{const o=Math.floor(t/60),i=Math.round(t%60);e=i>0?`~${o}m ${i}s`:`~${o}m`}l.textContent=`Real capture time: ${e}`}e()};r&&r.addEventListener("change",e=>{const t=e.target?.value;"custom"===t?(a&&(a.style.display="block"),this.options.duration=1e3*parseFloat(s?.value||"30")):(a&&(a.style.display="none"),this.options.duration=1e3*parseFloat(t||"30")),c()}),s&&s.addEventListener("input",e=>{this.options.duration=1e3*parseFloat(e.target?.value||"30"),c()}),this._panel.querySelector("#ve-fps")?.addEventListener("input",e=>{this.options.fps=parseFloat(e.target?.value||"30")}),this._panel.querySelector("#ve-wait-tiles")?.addEventListener("change",e=>{this.options.waitForTiles=e.target?.checked??!0}),this._panel.querySelector("#ve-loop")?.addEventListener("change",e=>{const t=e.target?.value;this.options.loop="false"!==t&&("true"===t||"smooth")}),this._panel.querySelector("#ve-format")?.addEventListener("change",e=>{if(!this._panel)return;this.options.format=e.target?.value||"webm-vp8",console.log("üìπ Format changed to:",this.options.format);const t=this._panel.querySelector("#ve-format-info");t&&("webm-vp8"===this.options.format?(t.innerHTML="‚úì Free & open-source (no licensing issues)<br>‚úì Works on all modern browsers<br>‚úì Good quality for most use cases",t.style.color="#2e7d32"):"webm-vp9"===this.options.format?(t.innerHTML="‚úì Free & open-source<br>‚úì Best compression & quality<br>‚ö† Modern browsers only (WebCodecs API)",t.style.color="#1976d2"):"mp4"===this.options.format&&(t.innerHTML="‚ö† Patent-encumbered codec<br>‚ö† May require licensing for commercial use<br>‚úì Maximum compatibility",t.style.color="#d32f2f"));const o=this._panel.querySelector("#ve-mp4-advanced"),i=this._panel.querySelector("#ve-webm-vp8-advanced"),n=this._panel.querySelector("#ve-webm-vp9-advanced");o&&i&&n&&(o.style.display="none",i.style.display="none",n.style.display="none","mp4"===this.options.format?o.style.display="block":"webm-vp8"===this.options.format?i.style.display="block":"webm-vp9"===this.options.format&&(n.style.display="block"))});const d=this._panel.querySelector("#ve-format-vp9"),p=this._panel.querySelector("#ve-format"),h="undefined"!=typeof VideoEncoder&&"undefined"!=typeof VideoFrame;!h&&d?(d.disabled=!0,d.textContent="WebM (VP9) - Not supported in this browser",console.log("‚ö†Ô∏è WebCodecs not supported - VP9 option disabled"),"webm-vp9"===this.options.format&&(this.options.format="webm-vp8",p&&(p.value="webm-vp8"))):h&&(console.log("‚úì WebCodecs supported - VP9 high quality encoding available"),p&&(p.value=this.options.format)),p?.dispatchEvent(new Event("change")),setTimeout(()=>{c()},0);const u=this._panel.querySelector("#ve-format-advanced-toggle"),m=this._panel.querySelector("#ve-format-advanced-group");u?.addEventListener("change",e=>{if(!this._panel)return;m&&(m.style.display=e.target?.checked?"block":"none");const t=this._panel.querySelector("#ve-mp4-advanced"),o=this._panel.querySelector("#ve-webm-vp8-advanced"),i=this._panel.querySelector("#ve-webm-vp9-advanced");e.target?.checked&&t&&o&&i&&(t.style.display="none",o.style.display="none",i.style.display="none","mp4"===this.options.format?t.style.display="block":"webm-vp8"===this.options.format?o.style.display="block":"webm-vp9"===this.options.format&&(i.style.display="block"))});const g=this._panel.querySelector("#ve-speed"),f=this._panel.querySelector("#ve-speed-custom-group"),y=this._panel.querySelector("#ve-speed-custom");g&&("custom"===g.value?this.options.speedMultiplier=parseFloat(y?.value||"1"):this.options.speedMultiplier=parseFloat(g.value||"1")),g?.addEventListener("change",e=>{"custom"===e.target?.value?(f&&(f.style.display="block"),this.options.speedMultiplier=parseFloat(y?.value||"1")):(f&&(f.style.display="none"),this.options.speedMultiplier=parseFloat(e.target?.value||"1")),c()}),y?.addEventListener("input",e=>{this.options.speedMultiplier=parseFloat(e.target?.value||"1"),c()});const b=this._panel.querySelector("#ve-bitrate"),v=this._panel.querySelector("#ve-bitrate-custom-group"),w=this._panel.querySelector("#ve-bitrate-custom");b?.addEventListener("change",e=>{"custom"===e.target?.value?(v&&(v.style.display="block"),this.options.bitrate=parseInt(w?.value||"5000",10)):"auto"===e.target?.value?(v&&(v.style.display="none"),this.options.bitrate="auto"):(v&&(v.style.display="none"),this.options.bitrate=parseInt(e.target?.value||"5000",10))}),w?.addEventListener("input",e=>{this.options.bitrate=parseInt(e.target?.value||"5000",10)});const x=this._panel.querySelector("#ve-bounds-current");x&&x.addEventListener("click",()=>{if(this._panel&&this._map){const e=this._map.getBounds(),t=this._panel.querySelector("#ve-bounds-west"),o=this._panel.querySelector("#ve-bounds-east"),i=this._panel.querySelector("#ve-bounds-south"),n=this._panel.querySelector("#ve-bounds-north");t&&(t.value=e.getWest().toFixed(6)),o&&(o.value=e.getEast().toFixed(6)),i&&(i.value=e.getSouth().toFixed(6)),n&&(n.value=e.getNorth().toFixed(6));const r=this._map.getZoom(),a=this._panel.querySelector("#ve-zoom-min"),s=this._panel.querySelector("#ve-zoom-max");a&&!a.value&&(a.value=Math.max(0,r-2).toFixed(1)),s&&!s.value&&(s.value=Math.min(24,r+2).toFixed(1)),this._updateBoundsFromUI(),this._updateBoundsOverlay()}});const _=this._panel.querySelector("#ve-bounds-waypoints");_&&_.addEventListener("click",()=>{if(!this._panel)return;const e=this.options.waypoints?.features||[];if(0===e.length)return void alert("No waypoints available.\n\nAdd some waypoints first using the Waypoints section above.");let t=1/0,o=1/0,i=-1/0,n=-1/0;e.forEach(e=>{const[r,a]=e.geometry.coordinates;t=Math.min(t,r),i=Math.max(i,r),o=Math.min(o,a),n=Math.max(n,a)});const r=.1*(i-t),a=.1*(n-o);t-=r,i+=r,o-=a,n+=a;const s=this._panel.querySelector("#ve-bounds-west"),l=this._panel.querySelector("#ve-bounds-east"),c=this._panel.querySelector("#ve-bounds-south"),d=this._panel.querySelector("#ve-bounds-north");if(s&&(s.value=t.toFixed(6)),l&&(l.value=i.toFixed(6)),c&&(c.value=o.toFixed(6)),d&&(d.value=n.toFixed(6)),this._map){const e=this._map.getCanvas(),r=.15*Math.min(e.width,e.height),a=this._map.cameraForBounds([[t,o],[i,n]],{padding:{top:r,bottom:r,left:r,right:r}});if(a){const e=this._panel.querySelector("#ve-zoom-min"),t=this._panel.querySelector("#ve-zoom-max");e&&!e.value&&(e.value=Math.max(0,a.zoom-2).toFixed(1)),t&&!t.value&&(t.value=Math.min(24,a.zoom+2).toFixed(1))}}this._updateBoundsFromUI(),this._updateBoundsOverlay(),console.log(`‚úÖ Suggested bounds from ${e.length} waypoints: [${t.toFixed(4)}, ${o.toFixed(4)}] to [${i.toFixed(4)}, ${n.toFixed(4)}]`)});["#ve-bounds-west","#ve-bounds-east","#ve-bounds-south","#ve-bounds-north"].forEach(e=>{const t=this._panel?.querySelector(e);t&&t.addEventListener("input",()=>{this._updateBoundsFromUI(),this._updateBoundsOverlay()})});["#ve-zoom-min","#ve-zoom-max"].forEach(e=>{const t=this._panel?.querySelector(e);t&&t.addEventListener("input",()=>{this._updateZoomLimitsFromUI()})});const S=this._panel.querySelector("#ve-strict-bounds");S&&S.addEventListener("change",e=>{this.options.strictBounds=e.target?.checked??!1});const k=this._panel.querySelector("#ve-show-bounds");k&&k.addEventListener("change",e=>{const t=e.target?.checked??!1;this.options.showBoundsOverlay=t,t?this._updateBoundsOverlay():this._removeBoundsOverlay()});const C=this._panel.querySelector("#ve-show-labels-toggle"),E=this._panel.querySelector("#ve-font-select-container");C&&E&&C.addEventListener("change",e=>{const t=e.target?.checked??!1;this._showWaypointLabels=t,console.log(`[Waypoints] Show labels changed to: ${this._showWaypointLabels}`),E.style.display=t?"block":"none",this._updateWaypointsLayer()});const M=this._panel.querySelector("#ve-font-select");M&&M.addEventListener("change",e=>{this._selectedFont=e.target?.value||"Roboto",console.log(`[Waypoints] Font changed to: ${this._selectedFont}`),this._updateWaypointsLayer()});const P=this._panel.querySelector("#ve-icon-size-slider"),F=this._panel.querySelector("#ve-icon-size-value");P&&F&&P.addEventListener("input",e=>{this._iconSize=parseFloat(e.target?.value||"1"),F.textContent=`${this._iconSize.toFixed(1)}√ó`,this._map&&this._map.getLayer(this._waypointsLayerId)&&this._updateWaypointsLayer()});const I=this._panel.querySelector("#ve-waypoint-add");I&&I.addEventListener("click",()=>this._addWaypoint());const $=this._panel.querySelector("#ve-waypoint-import");$&&$.addEventListener("click",()=>this._importWaypoints());const W=this._panel.querySelector("#ve-waypoint-export");W&&W.addEventListener("click",()=>this._exportWaypoints())}_updateBoundsFromUI(){if(!this._panel)return;const e=parseFloat(this._panel.querySelector("#ve-bounds-west")?.value||""),t=parseFloat(this._panel.querySelector("#ve-bounds-east")?.value||""),o=parseFloat(this._panel.querySelector("#ve-bounds-south")?.value||""),i=parseFloat(this._panel.querySelector("#ve-bounds-north")?.value||"");isNaN(e)||isNaN(t)||isNaN(o)||isNaN(i)?this.options.maxBounds=null:this.options.maxBounds=[[e,o],[t,i]]}_updateZoomLimitsFromUI(){if(!this._panel)return;const e=parseFloat(this._panel.querySelector("#ve-zoom-min")?.value||""),t=parseFloat(this._panel.querySelector("#ve-zoom-max")?.value||"");this.options.minZoom=isNaN(e)?null:e,this.options.maxZoom=isNaN(t)?null:t}_updateBoundsOverlay(){if(!this._map||!this.options.maxBounds||!this.options.showBoundsOverlay)return void this._removeBoundsOverlay();const e=this.options.maxBounds,t="video-export-bounds-overlay",o="video-export-bounds-overlay-layer";this._map.getLayer(o)&&this._map.removeLayer(o),this._map.getSource(t)&&this._map.removeSource(t),this._map.addSource(t,{type:"geojson",data:{type:"Feature",geometry:{type:"Polygon",coordinates:[[[e[0][0],e[0][1]],[e[1][0],e[0][1]],[e[1][0],e[1][1]],[e[0][0],e[1][1]],[e[0][0],e[0][1]]]]}}}),this._map.addLayer({id:o,type:"fill",source:t,paint:{"fill-color":"#3887be","fill-opacity":.1}}),this._map.addLayer({id:o+"-outline",type:"line",source:t,paint:{"line-color":"#3887be","line-width":2,"line-dasharray":[2,2]}})}_removeBoundsOverlay(){if(!this._map)return;const e="video-export-bounds-overlay-layer",t="video-export-bounds-overlay";this._map.getLayer(e+"-outline")&&this._map.removeLayer(e+"-outline"),this._map.getLayer(e)&&this._map.removeLayer(e),this._map.getSource(t)&&this._map.removeSource(t)}async _loadSpriteIcons(){if(this._map)try{await Promise.all([this._loadSpriteSheet(),this._loadFontstacks()]),this._populateFontSelect(),this._updateIconAvailability(),this._initWaypointsIconSelect()}catch(e){console.error("[Waypoints] Error loading sprite icons:",e),this._spriteIcons=[],this._updateIconAvailability(),this._initWaypointsIconSelect()}}async _loadSpriteSheet(){try{const e=this._map.getStyle();if(!e||!e.sprite)return console.warn("[Waypoints] No sprite URL in style - waypoints icons will not work"),this._spriteIcons=[],this._spriteData=null,void(this._spriteImage=null);const t=e.sprite;console.log("[Waypoints] Loading sprite from:",t);let o=2,i="@2x",n=null,r=null;try{const e=`${t}${i}.json`,o=await fetch(e);if(!o.ok)throw new Error(`@2x not available (${o.status})`);n=await o.json();const a=`${t}${i}.png`;r=new Image,r.crossOrigin="anonymous",await new Promise((e,t)=>{r.onload=e,r.onerror=t,r.src=a}),console.log("[Waypoints] Loaded @2x sprite (retina quality)")}catch(e){console.log("[Waypoints] @2x sprite not available, trying 1x fallback:",e.message),o=1,i="";const a=`${t}${i}.json`,s=await fetch(a);if(!s.ok)throw new Error(`Failed to load sprite JSON (1x): ${s.status}`);n=await s.json();const l=`${t}${i}.png`;r=new Image,r.crossOrigin="anonymous",await new Promise((e,t)=>{r.onload=e,r.onerror=t,r.src=l}),console.log("[Waypoints] Loaded 1x sprite (standard quality)")}this._spritePixelRatio=o,this._spriteData=n,this._spriteImage=r,this._spritePngUrl=`${t}${i}.png`,this._spriteIcons=Object.keys(this._spriteData),console.log(`[Waypoints] Loaded ${this._spriteIcons.length} icons from sprite sheet`)}catch(e){console.error("[Waypoints] Error loading sprite sheet:",e),this._spriteIcons=[],this._spriteImage=null,this._spriteData=null}}async _loadFontstacks(){try{const e=this._map.getStyle();if(!e||!e.glyphs)return console.log("[Waypoints] No glyphs URL in style - text labels not available"),this._availableFonts=[],[];const t=e.glyphs;console.log("[Waypoints] Glyphs URL template:",t);const o=t.replace("/{fontstack}/{range}.pbf",""),i=`${o}/fontstacks.json`;console.log("[Waypoints] Base URL:",o),console.log("[Waypoints] Trying to load fontstacks from:",i);try{const e=await fetch(i,{method:"GET",headers:{Accept:"application/json"}});if(e.ok){const t=await e.json();if(Array.isArray(t)&&t.length>0)return this._availableFonts=t,console.log(`[Waypoints] ‚úì Loaded ${t.length} font stacks from fontstacks.json`),this._selectedFont||(this._selectedFont=t[0],console.log("[Waypoints] Selected default font:",this._selectedFont)),t}}catch(e){console.log("[Waypoints] fontstacks.json not available, extracting fonts from style layers...")}const n=new Set;if(e.layers)for(const t of e.layers)if(t.layout&&t.layout["text-font"]){const e=t.layout["text-font"];Array.isArray(e)&&("literal"===e[0]&&Array.isArray(e[1])?e[1].forEach(e=>{"string"==typeof e&&n.add(e)}):e.forEach(e=>{"string"!=typeof e||e.startsWith("get")||e.startsWith("literal")||n.add(e)}))}const r=Array.from(n).sort();return r.length>0?(this._availableFonts=r,console.log(`[Waypoints] ‚úì Extracted ${r.length} fonts from style:`,r),this._selectedFont||(this._selectedFont=r[0],console.log("[Waypoints] Selected default font:",this._selectedFont)),r):(console.warn("[Waypoints] No fonts found in style"),this._availableFonts=[],[])}catch(e){return console.error("[Waypoints] Error loading fontstacks:",e),this._availableFonts=[],[]}}_populateFontSelect(){if(!this._panel)return;const e=this._panel.querySelector("#ve-font-select"),t=this._panel.querySelector("#ve-font-status");if(e&&t){if(e.innerHTML="",0===this._availableFonts.length){const o=document.createElement("option");return o.value="",o.textContent="No fonts available",o.disabled=!0,e.appendChild(o),void(t&&(t.textContent="No fonts available - labels cannot be shown",t.style.color="#e74c3c"))}this._availableFonts.forEach(t=>{const o=document.createElement("option");o.value=t,o.textContent=t,e.appendChild(o)}),this._selectedFont&&(e.value=this._selectedFont),t&&(t.textContent=`${this._availableFonts.length} fonts available`,t.style.color="#4CAF50")}}_updateIconAvailability(){if(!this._panel)return;const e=this._panel.querySelector("#ve-icon-mode-status");e&&(this._spriteIcons.length>0?(e.textContent=`${this._spriteIcons.length} icons available`,e.style.color="#4CAF50"):(e.textContent="Using default icon",e.style.color="#999",console.log("[Waypoints] No map sprites found - using built-in default icon")))}_initWaypointsIconSelect(){if(!this._panel)return;const e=this._panel.querySelector("#ve-wp-icon"),t=this._panel.querySelector("#ve-wp-icon-search");e&&(t&&(t.style.display=this._spriteIcons.length>30?"block":"none"),this._allIcons=[...this._spriteIcons],this._fillIconSelect(),t&&(t.removeEventListener("input",this._handleIconSearch),this._handleIconSearch=this._handleIconSearch.bind(this),t.addEventListener("input",this._handleIconSearch)),e.removeEventListener("change",this._updateIconPreview),this._updateIconPreview=this._updateIconPreview.bind(this),e.addEventListener("change",this._updateIconPreview),this._updateIconPreview())}_fillIconSelect(e=""){if(!this._panel)return;const t=this._panel.querySelector("#ve-wp-icon");if(!t)return;const o=t.value;if(t.innerHTML="",this._spriteIcons.length>0){if(!e||"waypoint-default".includes(e.toLowerCase())||"default".includes(e.toLowerCase())){const e=document.createElement("option");e.value="waypoint-default",e.textContent="üéØ Default Waypoint Icon",t.appendChild(e)}const o=e?(this._allIcons||[]).filter(t=>t.toLowerCase().includes(e.toLowerCase())):this._allIcons||[];if(o.forEach(e=>{const o=document.createElement("option");o.value=e,o.textContent=e.replace(/[_-]/g," "),t.appendChild(o)}),0===o.length){const e=document.createElement("option");e.value="",e.textContent="No icons found",e.disabled=!0,t.appendChild(e)}}else{const e=document.createElement("option");e.value="waypoint-default",e.textContent="Default Waypoint Icon",t.appendChild(e)}const i=t;if(o&&i&&Array.from(i.options).some(e=>e.value===o))i.value=o;else if(i&&i.options.length>0){const e=Array.from(i.options).find(e=>!e.disabled);e&&(i.value=e.value)}t.removeEventListener("change",this._updateIconPreview),t.addEventListener("change",this._updateIconPreview),this._updateIconPreview()}_handleIconSearch(e){const t=e.target.value;this._fillIconSelect(t),this._updateIconPreview()}_updateIconPreview(){if(!this._panel)return;const e=this._panel.querySelector("#ve-wp-icon"),t=this._panel.querySelector("#ve-wp-icon-preview");if(!e||!t)return;const o=e.value;if(t.innerHTML="",!o){const e=document.createElement("span");return e.style.fontSize="20px",e.textContent="üìç",void t.appendChild(e)}if("waypoint-default"===o){const e=document.createElement("div");return e.innerHTML='<svg width="24" height="36" viewBox="0 0 24 36" xmlns="http://www.w3.org/2000/svg">\n                <ellipse cx="12" cy="34" rx="4" ry="2" fill="rgba(0,0,0,0.3)" />\n                <path d="M12 2 C7 2 3 6 3 11 C3 16 12 26 12 26 C12 26 21 16 21 11 C21 6 17 2 12 2 Z" fill="white" />\n                <path d="M12 4 C8 4 5 7 5 11 C5 15 12 24 12 24 C12 24 19 15 19 11 C19 7 16 4 12 4 Z" fill="#3887be" />\n                <circle cx="12" cy="11" r="3" fill="white" opacity="0.9" />\n            </svg>',e.style.display="flex",e.style.alignItems="center",e.style.justifyContent="center",e.style.width="100%",e.style.height="100%",t.appendChild(e),void console.log("[Preview] Default icon preview created")}if(console.log("[Preview] Updating icon preview:",{selectedIcon:o,hasSpriteData:!!this._spriteData,hasIconInData:!!this._spriteData&&!!this._spriteData[o],hasSpriteUrl:!!this._spritePngUrl,hasSpriteImage:!!this._spriteImage,imageComplete:!!this._spriteImage&&this._spriteImage.complete}),this._spriteData&&this._spriteData[o]&&this._spritePngUrl&&this._spriteImage&&this._spriteImage.complete){const e=this._spriteData[o],i=this._spritePixelRatio||2,n=this._spriteImage.width/i,r=this._spriteImage.height/i;if(console.log("[Preview] Sprite dimensions:",{iconWidth:e.width,iconHeight:e.height,iconX:e.x,iconY:e.y,bgWidth:n,bgHeight:r,pixelRatio:i}),!isNaN(n)&&!isNaN(r)&&n>0&&r>0){const o=document.createElement("div");return o.style.width=e.width/i+"px",o.style.height=e.height/i+"px",o.style.backgroundImage=`url(${this._spritePngUrl})`,o.style.backgroundPosition=`-${e.x/i}px -${e.y/i}px`,o.style.backgroundSize=`${n}px ${r}px`,o.style.backgroundRepeat="no-repeat",o.style.maxWidth="100%",o.style.maxHeight="100%",t.appendChild(o),void console.log("[Preview] Sprite preview created successfully")}console.warn("[Preview] Invalid sprite dimensions")}else console.warn("[Preview] Sprite not available");const i=document.createElement("span");i.style.fontSize="12px",i.style.color="#999",i.textContent="No preview",t.appendChild(i)}_fillPopupIconSelect(e,t=""){if(0===document.querySelectorAll(".maplibregl-popup").length)return;const o=document.querySelector(`#ve-popup-icon-select-${e}`);if(!o)return;const i=o?.value;if(o.innerHTML="",this._spriteIcons.length>0){if(!t||"waypoint-default".includes(t.toLowerCase())||"default".includes(t.toLowerCase())){const e=document.createElement("option");e.value="waypoint-default",e.textContent="üéØ Default Waypoint Icon",o.appendChild(e)}(t?this._spriteIcons.filter(e=>e.toLowerCase().includes(t.toLowerCase())):this._spriteIcons).forEach(e=>{const t=document.createElement("option");t.value=e,t.textContent=e,o.appendChild(t)})}else{const e=document.createElement("option");e.value="waypoint-default",e.textContent="Default Waypoint",o.appendChild(e)}i&&(o.value=i)}_updatePopupIconPreview(e){const t=document.querySelector(`#ve-popup-icon-select-${e}`),o=document.querySelector(`#ve-popup-icon-preview-${e}`);if(!t||!o)return;const i=t?.value;if(o.innerHTML="",!i){const e=document.createElement("span");return e.style.fontSize="20px",e.textContent="üìç",void o.appendChild(e)}if("waypoint-default"===i){const e=document.createElement("div");return e.innerHTML='<svg width="24" height="36" viewBox="0 0 24 36" xmlns="http://www.w3.org/2000/svg">\n                <ellipse cx="12" cy="34" rx="4" ry="2" fill="rgba(0,0,0,0.3)" />\n                <path d="M12 2 C7 2 3 6 3 11 C3 16 12 26 12 26 C12 26 21 16 21 11 C21 6 17 2 12 2 Z" fill="white" />\n                <circle cx="12" cy="11" r="5" fill="#2196F3" />\n            </svg>',e.style.display="flex",e.style.justifyContent="center",e.style.alignItems="center",e.style.width="100%",e.style.height="100%",void o.appendChild(e)}if(this._spriteData&&this._spriteData[i]&&this._spritePngUrl&&this._spriteImage&&this._spriteImage.complete&&this._spriteImage.naturalWidth>0&&this._spriteImage.naturalHeight>0){const e=this._spriteData[i],t="number"==typeof e.pixelRatio?e.pixelRatio:1,n=this._spriteImage.naturalWidth/t,r=this._spriteImage.naturalHeight/t;if("number"==typeof n&&"number"==typeof r&&n>0&&r>0){const i=document.createElement("div");return i.style.width=e.width/t+"px",i.style.height=e.height/t+"px",i.style.backgroundImage=`url(${this._spritePngUrl})`,i.style.backgroundPosition=`-${e.x/t}px -${e.y/t}px`,i.style.backgroundSize=`${n}px ${r}px`,i.style.backgroundRepeat="no-repeat",i.style.maxWidth="100%",i.style.maxHeight="100%",void o.appendChild(i)}}const n=document.createElement("span");n.style.fontSize="12px",n.style.color="#999",n.textContent="No preview",o.appendChild(n)}_addDefaultWaypointIcon(){if(!this._map)return;const e="data:image/svg+xml;charset=utf-8,"+encodeURIComponent('<svg width="24" height="36" viewBox="0 0 24 36" xmlns="http://www.w3.org/2000/svg">\n            \x3c!-- Drop shadow --\x3e\n            <ellipse cx="12" cy="34" rx="4" ry="2" fill="rgba(0,0,0,0.3)" />\n            \x3c!-- Pin body with white border --\x3e\n            <path d="M12 2 C7 2 3 6 3 11 C3 16 12 26 12 26 C12 26 21 16 21 11 C21 6 17 2 12 2 Z"\n                  fill="white" />\n            \x3c!-- Pin body colored --\x3e\n            <path d="M12 4 C8 4 5 7 5 11 C5 15 12 24 12 24 C12 24 19 15 19 11 C19 7 16 4 12 4 Z"\n                  fill="#3887be" />\n            \x3c!-- Center dot --\x3e\n            <circle cx="12" cy="11" r="3" fill="white" opacity="0.9" />\n        </svg>'),t=new Image(24,36);t.onload=()=>{this._map.hasImage("waypoint-default")?console.log("[Waypoints] Default icon already exists, skipping"):(this._map.addImage("waypoint-default",t,{pixelRatio:1}),console.log("[Waypoints] ‚úì Added default waypoint icon"))},t.onerror=e=>{console.error("[Waypoints] Failed to load default icon:",e)},t.src=e}async _ensureDefaultWaypointIcon(){if(!this._map)return;if(this._map.hasImage("waypoint-default"))return;const e="data:image/svg+xml;charset=utf-8,"+encodeURIComponent('<svg width="24" height="36" viewBox="0 0 24 36" xmlns="http://www.w3.org/2000/svg">\n            \x3c!-- Drop shadow --\x3e\n            <ellipse cx="12" cy="34" rx="4" ry="2" fill="rgba(0,0,0,0.3)" />\n            \x3c!-- Pin body with white border --\x3e\n            <path d="M12 2 C7 2 3 6 3 11 C3 16 12 26 12 26 C12 26 21 16 21 11 C21 6 17 2 12 2 Z"\n                  fill="white" />\n            \x3c!-- Pin body colored --\x3e\n            <path d="M12 4 C8 4 5 7 5 11 C5 15 12 24 12 24 C12 24 19 15 19 11 C19 7 16 4 12 4 Z"\n                  fill="#3887be" />\n            \x3c!-- Center dot --\x3e\n            <circle cx="12" cy="11" r="3" fill="white" opacity="0.9" />\n        </svg>');return new Promise((t,o)=>{const i=new Image(24,36);i.onload=()=>{this._map.addImage("waypoint-default",i,{pixelRatio:1}),console.log("[Waypoints] ‚úì Added default waypoint icon (sync)"),t()},i.onerror=e=>{console.error("[Waypoints] Failed to load default icon:",e),o(e)},i.src=e})}_createMarkerElement(e,t){if(!this._spriteData||!this._spriteData[e]||!this._spritePngUrl){const e=document.createElement("div");return e.className="ve-waypoint-marker",e.innerHTML='<svg width="24" height="36" viewBox="0 0 24 36" xmlns="http://www.w3.org/2000/svg">\n                <ellipse cx="12" cy="34" rx="4" ry="2" fill="rgba(0,0,0,0.3)" />\n                <path d="M12 2 C7 2 3 6 3 11 C3 16 12 26 12 26 C12 26 21 16 21 11 C21 6 17 2 12 2 Z" fill="white" />\n                <path d="M12 4 C8 4 5 7 5 11 C5 15 12 24 12 24 C12 24 19 15 19 11 C19 7 16 4 12 4 Z" fill="#3887be" />\n                <circle cx="12" cy="11" r="3" fill="white" opacity="0.9" />\n            </svg>',e.style.cssText="\n                width: 24px;\n                height: 36px;\n                cursor: grab;\n                filter: drop-shadow(0 2px 4px rgba(0,0,0,0.4));\n            ",e.dataset.waypointIndex=String(t),e}const o=this._spriteData[e],i=this._spritePixelRatio||2,n=o.width/i,r=o.height/i,a=o.x/i,s=o.y/i,l=this._spriteImage?this._spriteImage.width/i:"auto",c=this._spriteImage?this._spriteImage.height/i:"auto",d=n*this._iconSize,p=r*this._iconSize,h=document.createElement("div");return h.className="ve-waypoint-marker",h.dataset.waypointIndex=String(t),h.style.cssText=`\n            width: ${d}px;\n            height: ${p}px;\n            background-image: url(${this._spritePngUrl});\n            background-position: -${a*this._iconSize}px -${s*this._iconSize}px;\n            background-size: ${"number"==typeof l?l*this._iconSize:l}px ${"number"==typeof c?c*this._iconSize:c}px;\n            background-repeat: no-repeat;\n            cursor: grab;\n            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.4));\n        `,h}_createMarkerPopupHTML(e){const t=this.options.waypoints.features[e];if(!t)return"";const o=t.properties,i=t.geometry.coordinates;let n='<option value="waypoint-default">Default Waypoint</option>';return this._spriteIcons&&this._spriteIcons.length>0&&this._spriteIcons.forEach(e=>{const t=o.icon===e?"selected":"";n+=`<option value="${e}" ${t}>${e}</option>`}),`\n            <div class="ve-waypoint-popup" style="min-width: 280px; max-width: 320px; max-height: 70vh; overflow-y: auto;">\n                <h3 style="font-size: 13px; font-weight: 600;">${o.name||`Waypoint ${e+1}`}</h3>\n\n                <div style="margin-bottom: 6px;">\n                    <label style="display: block; font-size: 11px; color: #666; margin-bottom: 2px;">Icon</label>\n                    <input type="text" id="ve-popup-icon-search-${e}" placeholder="Search icons..."\n                           style="width: 100%; padding: 3px; font-size: 11px; border: 1px solid #ddd; border-radius: 3px; margin-bottom: 3px; display: ${this._spriteIcons.length>30?"block":"none"};" />\n                    <select id="ve-popup-icon-select-${e}" data-field="icon" data-index="${e}"\n                            style="width: 100%; padding: 3px; font-size: 12px; border: 1px solid #ddd; border-radius: 3px;">\n                        ${n}\n                    </select>\n                    <div id="ve-popup-icon-preview-${e}"\n                         style="margin-top: 4px; padding: 6px; background: #f5f5f5; border: 1px solid #ddd; border-radius: 3px; text-align: center; min-height: 36px; display: flex; align-items: center; justify-content: center;">\n                    </div>\n                </div>\n\n                <div style="margin-bottom: 6px;">\n                    <label style="display: block; font-size: 11px; color: #666; margin-bottom: 2px;">Name (optional)</label>\n                    <input type="text" value="${o.name||""}" placeholder="e.g., Eiffel Tower"\n                           data-field="name" data-index="${e}"\n                           style="width: 100%; padding: 3px; font-size: 12px; border: 1px solid #ddd; border-radius: 3px;" />\n                </div>\n\n                <div style="margin-bottom: 6px;">\n                    <label style="display: block; font-size: 11px; color: #666; margin-bottom: 2px;">Coordinates</label>\n                    <div style="display: flex; gap: 4px;">\n                        <input type="number" id="ve-popup-lng-${e}" placeholder="Longitude" step="0.000001" value="${i[0].toFixed(6)}" style="flex: 1; padding: 3px; font-size: 11px;">\n                        <input type="number" id="ve-popup-lat-${e}" placeholder="Latitude" step="0.000001" value="${i[1].toFixed(6)}" style="flex: 1; padding: 3px; font-size: 11px;">\n                    </div>\n                </div>\n\n                <div style="margin-bottom: 6px;">\n                    <label style="font-size: 11px;">\n                        <input type="checkbox" id="ve-popup-camera-toggle-${e}">\n                        Capturer la position de cam√©ra\n                    </label>\n                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 4px; margin-top: 3px;">\n                        <input type="number" id="ve-popup-zoom-${e}" placeholder="Zoom" size="3" step="0.5" style="padding: 3px; font-size: 11px;" disabled>\n                        <input type="number" id="ve-popup-bearing-${e}" placeholder="Bearing" size="3" step="1" style="padding: 3px; font-size: 11px;" disabled>\n                        <input type="number" id="ve-popup-pitch-${e}" placeholder="Pitch" size="3" step="1" style="padding: 3px; font-size: 11px;" disabled>\n                    </div>\n                    <small style="display: block; color: #999; font-size: 10px; margin-top: 2px;">Fige le zoom et l'angle de vue pour ce point de passage</small>\n                </div>\n\n                <div style="margin-bottom: 6px;">\n                    <label style="display: block; font-size: 11px; color: #666; margin-bottom: 2px;">Pause Duration (ms)</label>\n                    <input type="number" value="${o.duration||2e3}" step="100" placeholder="e.g., 3000"\n                           data-field="duration" data-index="${e}"\n                           style="width: 100%; padding: 3px; font-size: 12px; border: 1px solid #ddd; border-radius: 3px;" />\n                    <small style="display: block; color: #999; font-size: 10px; margin-top: 2px;">How long to pause at this waypoint (0 = no pause)</small>\n                </div>\n\n                <div style="display: flex; gap: 4px; margin-top: 8px;">\n                    <button class="ve-popup-save" data-index="${e}"\n                            style="flex: 1; padding: 5px; font-size: 11px; background: #4CAF50; color: white; border: none; border-radius: 3px; cursor: pointer;">\n                        ‚úì Save\n                    </button>\n                    <button class="ve-popup-cancel" data-index="${e}"\n                            style="flex: 1; padding: 5px; font-size: 11px; background: #999; color: white; border: none; border-radius: 3px; cursor: pointer;">\n                        ‚úó Cancel\n                    </button>\n                </div>\n                <div style="margin-top: 4px;">\n                    <button class="ve-popup-delete" data-index="${e}"\n                            style="width: 100%; padding: 5px; font-size: 11px; background: #e74c3c; color: white; border: none; border-radius: 3px; cursor: pointer;">\n                        üóëÔ∏è Delete\n                    </button>\n                </div>\n            </div>\n        `}_createWaypointMarkers(){if(!this._map)return;this._waypointMarkers.forEach(e=>e.remove()),this._waypointMarkers=[];const e=this.options.waypoints.features||[];0!==e.length&&(e.forEach((e,t)=>{const o=e.geometry.coordinates,i=e.properties.icon||"waypoint-default";let n=null;if("waypoint-default"===i)n="waypoint-default";else{const e=i.toLowerCase();n=this._spriteIcons.includes(i)?i:this._spriteIcons.find(t=>{const o=t.toLowerCase();return o.includes(e)||o.startsWith(e+"-")||o.startsWith(e+"_")}),n||(n="waypoint-default")}console.log(`[Waypoints] Marker ${t}: icon="${i}" ‚Üí iconId="${n}"`);const r=this._createMarkerElement(n,t),a=new maplibregl.Marker({element:r,draggable:!0,anchor:"bottom"}).setLngLat(o).addTo(this._map),s=this._createMarkerPopupHTML(t),l=new maplibregl.Popup({offset:25,closeButton:!0,closeOnClick:!0}).setHTML(s);a.setPopup(l);let c=null;a.on("dragstart",()=>{r.style.cursor="grabbing",c=[...e.geometry.coordinates]}),a.on("dragend",()=>{r.style.cursor="grab";const o=a.getLngLat();if(!this._validateWaypointCoordinates(o.lng,o.lat)){const[[i,n],[r,s]]=this.options.maxBounds,l=e.properties.name||`Waypoint ${t+1}`;if(!confirm(`‚ö†Ô∏è Warning: This position is OUTSIDE the defined geographic bounds!\n\nWaypoint: "${l}"\nNew position: [${o.lng.toFixed(4)}, ${o.lat.toFixed(4)}]\nBounds: [${i.toFixed(2)}, ${n.toFixed(2)}] to [${r.toFixed(2)}, ${s.toFixed(2)}]\n\nAnimations may not visit this waypoint if strict bounds are enabled.\n\nKeep new position?`))return a.setLngLat(c),void console.log(`[Waypoints] Marker ${t} drag cancelled - out of bounds`)}e.geometry.coordinates=[o.lng,o.lat],l.setHTML(this._createMarkerPopupHTML(t)),this._attachPopupEventListeners(t,l),console.log(`[Waypoints] Marker ${t} dragged to:`,o)}),l.on("open",()=>{this._attachPopupEventListeners(t,l)}),this._waypointMarkers.push(a)}),console.log(`[Waypoints] ‚úì Created ${this._waypointMarkers.length} draggable markers`))}_attachPopupEventListeners(e,t){const o=t.getElement();if(!o)return;const i=this.options.waypoints.features[e];if(!i)return;let n=null;o.querySelectorAll("input[data-field]").forEach(t=>{t.addEventListener("change",t=>{const o=t.target?.dataset.field;if(!o)return;let n=t.target?.value;"zoom"===o||"duration"===o||"bearing"===o||"pitch"===o?""===n||null==n?delete i.properties[o]:(n=parseFloat(n),i.properties[o]=n):i.properties[o]=n,this._updateWaypointsUI(),console.log(`[Waypoints] Updated waypoint ${e} ${o}:`,n)})});const r=o.querySelector(`#ve-popup-icon-select-${e}`);r&&(r.addEventListener("change",t=>{const o=t.target?.value;o&&(i.properties.icon=o,this._updatePopupIconPreview(e),console.log(`[Waypoints] Updated waypoint ${e} icon:`,o))}),this._updatePopupIconPreview(e));const a=o.querySelector(`#ve-popup-icon-search-${e}`);a&&r&&a.addEventListener("input",t=>{const o=t.target?.value||"";this._fillPopupIconSelect(e,o),this._updatePopupIconPreview(e)});const s=o.querySelector(".ve-popup-save");s&&s.addEventListener("click",()=>{this._map&&n&&(this._map.off("move",n),n=null),t.remove(),this._createWaypointMarkers(),this._updateWaypointsUI(),this._saveWaypoints(),console.log(`[Waypoints] Saved waypoint ${e}`)});const l=o.querySelector(".ve-popup-cancel");l&&l.addEventListener("click",()=>{this._map&&n&&(this._map.off("move",n),n=null),t.remove(),console.log(`[Waypoints] Cancelled editing waypoint ${e}`)});const c=o.querySelector(".ve-popup-delete");c&&c.addEventListener("click",()=>{this._map&&n&&(this._map.off("move",n),n=null),this.options.waypoints.features.splice(e,1),t.remove(),this._createWaypointMarkers(),this._updateWaypointsUI(),this._saveWaypoints(),console.log(`[Waypoints] Deleted waypoint ${e}`)});const d=o.querySelector(`#ve-popup-lng-${e}`),p=o.querySelector(`#ve-popup-lat-${e}`);d&&p&&(d.addEventListener("change",e=>{const t=parseFloat(e.target?.value||"");isNaN(t)||(i.geometry.coordinates[0]=t,console.log(`[Waypoints] Updated longitude to ${t}`))}),p.addEventListener("change",e=>{const t=parseFloat(e.target?.value||"");isNaN(t)||(i.geometry.coordinates[1]=t,console.log(`[Waypoints] Updated latitude to ${t}`))}));const h=o.querySelector(`#ve-popup-camera-toggle-${e}`),u=o.querySelector(`#ve-popup-zoom-${e}`),m=o.querySelector(`#ve-popup-bearing-${e}`),g=o.querySelector(`#ve-popup-pitch-${e}`);if(h&&u&&m&&g){const o=h,r=u,a=m,s=g,l=()=>{if(!this._map)return;const e=this._map.getZoom(),t=this._map.getBearing(),o=this._map.getPitch();r&&(r.value=e.toFixed(1)),a&&(a.value=t.toFixed(0)),s&&(s.value=o.toFixed(0)),i.properties.zoom=e,i.properties.bearing=t,i.properties.pitch=o};void 0===i.properties.zoom&&void 0===i.properties.bearing&&void 0===i.properties.pitch||(o&&(o.checked=!0),r&&(r.disabled=!1,void 0!==i.properties.zoom&&(r.value=i.properties.zoom.toString())),a&&(a.disabled=!1,void 0!==i.properties.bearing&&(a.value=i.properties.bearing.toString())),s&&(s.disabled=!1,void 0!==i.properties.pitch&&(s.value=i.properties.pitch.toString())),this._map&&(n=l,this._map.on("move",n))),h.addEventListener("change",t=>{const o=t.target?.checked;o?(r&&(r.disabled=!1),a&&(a.disabled=!1),s&&(s.disabled=!1),l(),this._map&&!n&&(n=l,this._map.on("move",n))):(r&&(r.disabled=!0,r.value=""),a&&(a.disabled=!0,a.value=""),s&&(s.disabled=!0,s.value=""),delete i.properties.zoom,delete i.properties.bearing,delete i.properties.pitch,this._map&&n&&(this._map.off("move",n),n=null)),console.log(`[Waypoints] Camera capture ${o?"enabled":"disabled"} for waypoint ${e}`)}),[u,m,g].forEach(e=>{e.addEventListener("change",e=>{const t=e.target,o=t?.value,n=t?.id||"";if(o&&""!==o){const e=parseFloat(o);n.includes("zoom")?i.properties.zoom=e:n.includes("bearing")?i.properties.bearing=e:n.includes("pitch")&&(i.properties.pitch=e),console.log(`[Waypoints] Manually updated camera ${n} to ${e}`)}})}),t.on("close",()=>{this._map&&n&&(this._map.off("move",n),n=null)})}}_createWaypointsLayer(){console.log("[Waypoints] _createWaypointsLayer called (redirecting to markers)"),this._createWaypointMarkers()}_updateWaypointsLayer(){console.log("[Waypoints] _updateWaypointsLayer called (redirecting to markers)"),this._createWaypointMarkers()}_removeWaypointsLayer(){console.log("[Waypoints] _removeWaypointsLayer called (removing markers)"),this._waypointMarkers.forEach(e=>e.remove()),this._waypointMarkers=[]}_hideWaypointMarkers(){console.log("[Waypoints] Hiding waypoint markers for recording"),this._waypointMarkers.forEach(e=>{const t=e.getElement();t&&(t.style.display="none")})}_showWaypointMarkers(){this._waypointMarkers.forEach(e=>{const t=e.getElement();t&&(t.style.display="")})}async _createWaypointsWebGLLayer(){if(!this._map||!this.options.waypoints||0===this.options.waypoints.features.length)return;await this._ensureDefaultWaypointIcon();const e="ve-waypoints-recording-source",t="ve-waypoints-recording-layer";this._map.getLayer(t)&&this._map.removeLayer(t),this._map.getSource(e)&&this._map.removeSource(e);const o={type:"FeatureCollection",features:this.options.waypoints.features.map((e,t)=>{const o=e.properties.icon||"waypoint-default";let i=null;return"waypoint-default"===o?i="waypoint-default":(this._spriteIcons.includes(o)&&(i=o),i||(i="waypoint-default")),console.log(`[Waypoints] WebGL Layer - Waypoint ${t}: icon="${o}" ‚Üí iconId="${i}"`),{...e,properties:{...e.properties,iconId:i||"marker"}}})};this._map.addSource(e,{type:"geojson",data:o}),this._map.addLayer({id:t,type:"symbol",source:e,layout:{"icon-image":["get","iconId"],"icon-size":this._iconSize||1,"icon-allow-overlap":!0,"icon-ignore-placement":!0,"icon-anchor":"bottom",visibility:"visible",...this._showWaypointLabels&&this._selectedFont?{"text-field":["get","name"],"text-font":[this._selectedFont],"text-offset":[0,.5],"text-anchor":"top","text-size":12,"text-allow-overlap":!0,"text-ignore-placement":!0}:{}},paint:{"icon-opacity":1,"text-color":"#333","text-halo-color":"#fff","text-halo-width":2}}),console.log(`[Waypoints] ‚úì Created WebGL layer with ${o.features.length} waypoints`)}_removeWaypointsWebGLLayer(){const e="ve-waypoints-recording-source",t="ve-waypoints-recording-layer";this._map.getLayer(t)&&this._map.removeLayer(t),this._map.getSource(e)&&this._map.removeSource(e)}_validateWaypointCoordinates(e,t){if(!this.options.maxBounds)return!0;const[[o,i],[n,r]]=this.options.maxBounds;return e>=o&&e<=n&&t>=i&&t<=r}_addWaypoint(){if(!this._map)return;const e=this._map.getCenter();if(!this._validateWaypointCoordinates(e.lng,e.lat)){const[[t,o],[i,n]]=this.options.maxBounds;if(!confirm(`‚ö†Ô∏è Warning: This waypoint is OUTSIDE the defined geographic bounds!\n\nWaypoint: [${e.lng.toFixed(4)}, ${e.lat.toFixed(4)}]\nBounds: [${t.toFixed(2)}, ${o.toFixed(2)}] to [${i.toFixed(2)}, ${n.toFixed(2)}]\n\nAnimations may not visit this waypoint if strict bounds are enabled.\n\nAdd anyway?`))return void console.log("Waypoint addition cancelled - out of bounds")}const t={type:"Feature",geometry:{type:"Point",coordinates:[e.lng,e.lat]},properties:{name:`Waypoint ${(this.options.waypoints.features.length||0)+1}`,icon:"waypoint-default",duration:2e3}};this.options.waypoints.features.push(t),this._updateWaypointsUI(),this._saveWaypoints(),this._createWaypointMarkers();const o=this._waypointMarkers[this._waypointMarkers.length-1];o&&o.togglePopup(),this._hidePanel(),console.log("Added waypoint:",t)}_updateWaypointsUI(){if(!this._panel)return;const e=this._panel.querySelector("#ve-waypoints-list"),t=this._panel.querySelector("#ve-waypoint-export");if(!e||!t)return;e.innerHTML="";const o=this.options.waypoints.features||[];if(0===o.length)return e.innerHTML='\n                <div style="text-align: center; color: #999; font-size: 12px; padding: 20px 0;">\n                    No waypoints yet. Click "Add draggable Icon" to start.\n                </div>\n            ',void(t.disabled=!0);t.disabled=!1,o.forEach((t,i)=>{const n=t.properties,r=document.createElement("div");r.className="ve-waypoint-item",r.style.cssText="display: flex; align-items: center; gap: 8px; padding: 6px; background: white; border-radius: 3px; margin-bottom: 4px; cursor: pointer;";let a='<span style="font-size: 18px;">‚ùì</span>';if("waypoint-default"===n.icon)a='<div style="width: 20px; height: 20px; display: flex; align-items: center; justify-content: center;">\n                    <svg width="12" height="18" viewBox="0 0 24 36" xmlns="http://www.w3.org/2000/svg">\n                        <ellipse cx="12" cy="34" rx="4" ry="2" fill="rgba(0,0,0,0.3)" />\n                        <path d="M12 2 C7 2 3 6 3 11 C3 16 12 26 12 26 C12 26 21 16 21 11 C21 6 17 2 12 2 Z" fill="white" />\n                        <path d="M12 4 C8 4 5 7 5 11 C5 15 12 24 12 24 C12 24 19 15 19 11 C19 7 16 4 12 4 Z" fill="#3887be" />\n                        <circle cx="12" cy="11" r="3" fill="white" opacity="0.9" />\n                    </svg>\n                </div>';else if(this._spriteData&&this._spriteData[n.icon]&&this._spritePngUrl){const e=this._spriteData[n.icon],t=this._spritePixelRatio||2,o=e.width/t,i=e.height/t,r=e.x/t,s=e.y/t,l=this._spriteImage?this._spriteImage.width/t:"auto",c=this._spriteImage?this._spriteImage.height/t:"auto",d=Math.min(20/o,20/i);a=`<div style="width: 20px; height: 20px; display: flex; align-items: center; justify-content: center;">\n                    <div style="width: ${o*d}px; height: ${i*d}px; background-image: url(${this._spritePngUrl}); background-position: -${r}px -${s}px; background-size: ${l}px ${c}px; background-repeat: no-repeat;"></div>\n                </div>`}const s=document.createElement("div");s.innerHTML=a,r.appendChild(s);const l=document.createElement("span");l.className="ve-wp-name",l.setAttribute("data-index",String(i)),l.style.cssText="flex: 1; font-size: 12px; font-weight: 500; cursor: pointer;",l.textContent=n.name||`Waypoint ${i+1}`,r.appendChild(l);const c=document.createElement("button");c.className="ve-wp-move-up",c.setAttribute("data-index",String(i)),c.style.cssText="padding: 2px 6px; font-size: 11px; background: #666; color: white; border: none; border-radius: 3px; cursor: pointer;",c.textContent="‚Üë",c.disabled=0===i,r.appendChild(c);const d=document.createElement("button");d.className="ve-wp-move-down",d.setAttribute("data-index",String(i)),d.style.cssText="padding: 2px 6px; font-size: 11px; background: #666; color: white; border: none; border-radius: 3px; cursor: pointer;",d.textContent="‚Üì",d.disabled=i===o.length-1,r.appendChild(d);const p=document.createElement("button");p.className="ve-wp-delete",p.setAttribute("data-index",String(i)),p.style.cssText="padding: 2px 6px; font-size: 11px; background: #e74c3c; color: white; border: none; border-radius: 3px; cursor: pointer;",p.textContent="üóëÔ∏è",r.appendChild(p),e.appendChild(r)}),e.querySelectorAll(".ve-wp-delete").forEach(e=>{e.addEventListener("click",t=>{t.stopPropagation();const o=parseInt(e.getAttribute("data-index")||"0",10);this._deleteWaypoint(o)})}),e.querySelectorAll(".ve-wp-move-up").forEach(e=>{e.addEventListener("click",t=>{t.stopPropagation();const o=parseInt(e.getAttribute("data-index")||"0",10);if(o>0){const e=this.options.waypoints.features;[e[o-1],e[o]]=[e[o],e[o-1]],this._updateWaypointsUI(),this._createWaypointMarkers(),this._saveWaypoints(),console.log(`[Waypoints] Moved waypoint from ${o} to ${o-1}`)}})}),e.querySelectorAll(".ve-wp-move-down").forEach(e=>{e.addEventListener("click",t=>{t.stopPropagation();const o=parseInt(e.getAttribute("data-index")||"0",10),i=this.options.waypoints.features;o<i.length-1&&([i[o],i[o+1]]=[i[o+1],i[o]],this._updateWaypointsUI(),this._createWaypointMarkers(),this._saveWaypoints(),console.log(`[Waypoints] Moved waypoint from ${o} to ${o+1}`))})}),e.querySelectorAll(".ve-wp-name").forEach(e=>{e.addEventListener("click",t=>{t.stopPropagation();const o=parseInt(e.getAttribute("data-index")||"0",10),i=this.options.waypoints.features[o];if(!i||!this._map)return;const n=i.geometry.coordinates;this._panel&&"none"!==this._panel.style.display&&(this._panel.style.display="none"),this._map.flyTo({center:n,zoom:Math.max(this._map.getZoom(),14),duration:1e3,essential:!0}),this._map.once("moveend",()=>{if(this._waypointMarkers&&this._waypointMarkers[o]){this._waypointMarkers[o].togglePopup()}}),console.log(`[Waypoints] Centered on waypoint ${o}`)})}),this._updateWaypointsLayer()}_editWaypoint(e){if(!this._panel)return;const t=this._panel.querySelector("#ve-waypoint-editor"),o=this.options.waypoints.features;if(!t||!o||!o[e])return;const i=o[e],n=i.properties,r=i.geometry.coordinates;t.style.display="block";const a=void 0!==n.zoom||void 0!==n.bearing||void 0!==n.pitch,s=this._panel.querySelector("#ve-wp-index"),l=this._panel.querySelector("#ve-wp-icon"),c=this._panel.querySelector("#ve-wp-name"),d=this._panel.querySelector("#ve-wp-lng"),p=this._panel.querySelector("#ve-wp-lat"),h=this._panel.querySelector("#ve-wp-duration");s&&(s.value=e),l&&(l.value=n.icon||"waypoint-default"),c&&(c.value=n.name||""),d&&(d.value=r[0]),p&&(p.value=r[1]),h&&(h.value=n.duration||"");const u=this._panel.querySelector("#ve-wp-camera-toggle"),m=this._panel.querySelector("#ve-wp-zoom"),g=this._panel.querySelector("#ve-wp-bearing"),f=this._panel.querySelector("#ve-wp-pitch");a?(u&&(u.checked=!0),m&&(m.disabled=!1),g&&(g.disabled=!1),f&&(f.disabled=!1),m&&(m.value=void 0!==n.zoom?n.zoom:""),g&&(g.value=void 0!==n.bearing?n.bearing:""),f&&(f.value=void 0!==n.pitch?n.pitch:"")):(u&&(u.checked=!1),m&&(m.disabled=!0),g&&(g.disabled=!0),f&&(f.disabled=!0),m&&(m.value=""),g&&(g.value=""),f&&(f.value="")),this._updateIconPreview()}_saveWaypoint(){if(!this._panel)return;const e=this._panel.querySelector("#ve-waypoint-editor"),t=parseInt(this._panel.querySelector("#ve-wp-index")?.value||"0",10),o=this.options.waypoints.features;if(!o||!o[t])return;const i=this._panel.querySelector("#ve-wp-icon")?.value||"",n=this._panel.querySelector("#ve-wp-name")?.value,r=parseFloat(this._panel.querySelector("#ve-wp-lng")?.value||"0"),a=parseFloat(this._panel.querySelector("#ve-wp-lat")?.value||"0"),s=this._panel.querySelector("#ve-wp-zoom")?.value,l=this._panel.querySelector("#ve-wp-bearing")?.value,c=this._panel.querySelector("#ve-wp-pitch")?.value,d=this._panel.querySelector("#ve-wp-duration")?.value;if(!this._validateWaypointCoordinates(r,a)){const[[e,o],[i,s]]=this.options.maxBounds;if(!confirm(`‚ö†Ô∏è Warning: These coordinates are OUTSIDE the defined geographic bounds!\n\nWaypoint: ${n||`Waypoint ${t+1}`}\nCoordinates: [${r.toFixed(4)}, ${a.toFixed(4)}]\nBounds: [${e.toFixed(2)}, ${o.toFixed(2)}] to [${i.toFixed(2)}, ${s.toFixed(2)}]\n\nAnimations may not visit this waypoint if strict bounds are enabled.\n\nSave anyway?`))return void console.log("Waypoint save cancelled - coordinates out of bounds")}o[t]={type:"Feature",geometry:{type:"Point",coordinates:[r,a]},properties:{icon:i,name:n||`Waypoint ${t+1}`,...""!==s&&{zoom:parseFloat(s||"0")},...""!==l&&{bearing:parseFloat(l||"0")},...""!==c&&{pitch:parseFloat(c||"0")},...""!==d&&{duration:parseInt(d||"0",10)}}},e&&(e.style.display="none"),this._updateWaypointsUI(),this._createWaypointMarkers(),console.log("Waypoint saved:",o[t])}_cancelWaypointEdit(){if(!this._panel)return;const e=this._panel.querySelector("#ve-waypoint-editor");e&&(e.style.display="none")}_deleteWaypoint(e){if(!this._panel)return;const t=this.options.waypoints.features;if(!t)return;const o=t[e].properties.name||`Waypoint ${e+1}`;if(confirm(`Delete waypoint "${o}"?`)){t.splice(e,1),this._updateWaypointsUI(),this._saveWaypoints();const o=this._panel.querySelector("#ve-waypoint-editor");parseInt(this._panel.querySelector("#ve-wp-index")?.value||"-1",10)===e&&o&&(o.style.display="none"),console.log("Waypoint deleted, remaining:",t.length)}}_importWaypoints(){const e=document.createElement("input");e.type="file",e.accept=".json,.geojson",e.onchange=e=>{const t=e.target?.files?.[0];if(!t)return;const o=5242880;if(t.size>o)return void alert(`File too large: ${(t.size/1024/1024).toFixed(2)} MB\n\nMaximum allowed: 5 MB\n\nPlease use a smaller waypoints file.`);if(!["application/json","application/geo+json","text/plain",""].includes(t.type))return void alert(`Invalid file type: ${t.type||"unknown"}\n\nPlease upload a .json or .geojson file.`);const i=new FileReader;i.onerror=()=>{console.error("FileReader error:",i.error),alert(`Error reading file: ${i.error?.message||"Unknown error"}\n\nPlease try again or use a different file.`)},i.onload=e=>{try{if(!e.target)return;const t=JSON.parse(e.target.result);if("FeatureCollection"!==t.type)throw new Error("Invalid format: expected GeoJSON FeatureCollection");if(!Array.isArray(t.features))throw new Error("Invalid format: features must be an array");const o=[];if(t.features.forEach((e,t)=>{if("Feature"!==e.type)throw new Error(`Feature ${t}: invalid type`);if("Point"!==e.geometry.type)throw new Error(`Feature ${t}: only Point geometry supported`);if(!Array.isArray(e.geometry.coordinates)||2!==e.geometry.coordinates.length)throw new Error(`Feature ${t}: invalid coordinates`);const[i,n]=e.geometry.coordinates;this._validateWaypointCoordinates(i,n)||o.push({idx:t,name:e.properties?.name||`Waypoint ${t+1}`,coords:[i.toFixed(4),n.toFixed(4)]})}),o.length>0&&this.options.maxBounds){const[[e,t],[i,n]]=this.options.maxBounds,r=o.map(e=>`  ‚Ä¢ ${e.name}: [${e.coords[0]}, ${e.coords[1]}]`).join("\n");if(!confirm(`‚ö†Ô∏è Warning: ${o.length} waypoint(s) are OUTSIDE the defined geographic bounds!\n\n${r}\n\nBounds: [${e.toFixed(2)}, ${t.toFixed(2)}] to [${i.toFixed(2)}, ${n.toFixed(2)}]\n\nAnimations may not visit these waypoints if strict bounds are enabled.\n\nImport anyway?`))return void console.log("Import cancelled - waypoints out of bounds")}this.options.waypoints=t,this._updateWaypointsUI(),this._createWaypointMarkers(),this._saveWaypoints(),console.log(`Imported ${t.features.length} waypoints`),alert(`Successfully imported ${t.features.length} waypoints!`)}catch(e){console.error("Import error:",e),alert(`Error importing waypoints: ${e.message}`)}},i.readAsText(t)},e.click()}_exportWaypoints(){if(!this.options.waypoints||0===this.options.waypoints.features.length)return void alert("No waypoints to export");const e=JSON.stringify(this.options.waypoints,null,2),t=new Blob([e],{type:"application/geo+json"}),o=URL.createObjectURL(t),i=document.createElement("a");i.href=o,i.download=`waypoints-${Date.now()}.geojson`,i.click(),URL.revokeObjectURL(o),console.log(`Exported ${this.options.waypoints.features.length} waypoints as GeoJSON`)}_togglePanel(){if(!this._panel||!this._overlay)return;"true"===this._panel.getAttribute("data-visible")?(this._panel.setAttribute("data-visible","false"),this._overlay.setAttribute("data-visible","false"),setTimeout(()=>{this._panel&&this._overlay&&(this._panel.style.display="none",this._overlay.style.display="none")},250)):(this._overlay.style.display="block",this._panel.style.display="block",requestAnimationFrame(()=>{this._panel&&this._overlay&&(this._panel.setAttribute("data-visible","true"),this._overlay.setAttribute("data-visible","true"))}))}_hidePanel(){this._panel&&this._overlay&&(this._panel.setAttribute("data-visible","false"),this._overlay.setAttribute("data-visible","false"),setTimeout(()=>{this._panel&&this._overlay&&(this._panel.style.display="none",this._overlay.style.display="none")},250))}_adjustPanelPosition(){if(!this._panel||!this._map)return;const e=this._map.getContainer().querySelector(".maplibregl-ctrl-attrib"),t=window.innerHeight;let o=0;if(e){o+=e.offsetHeight+10}const i=Math.max(400,t-20-o-40);this._panel.style.maxHeight=`${i}px`,console.log(`[VideoExport] Panel adjusted - available space: ${i}px, bottom offset: ${o}px`)}_updateStatus(e,t=""){if(!this._panel)return;const o=this._panel.querySelector("#ve-status");o&&(o.textContent=e,o.className="status "+t)}_estimateFileSize(e,t,o){const i=e*(t/1e3)/8/1024,n=this._recordingParams?.width||this.options.width||1920,r=this._recordingParams?.height||this.options.height||1080,a=this._recordingParams?.fps||this.options.fps||30,s=(n>=2560||r>=1440)&&a>=60;if("webm-vp9"===o){return i*(s?1.1:.75)}if("webm-vp8"===o||"webm"===o){return i*(s?1.15:.8)}return i}_formatSize(e){return e<1?`${(1024*e).toFixed(0)} KB`:e<100?`${e.toFixed(1)} MB`:`${e.toFixed(0)} MB`}_updateProgress(e,t,o,i,n="Recording"){const r=this._progressWidget?.querySelector("#ve-progress-status"),a=this._progressWidget?.querySelector("#ve-progress-percent"),s=this._progressWidget?.querySelector("#ve-progress-frames"),l=this._progressWidget?.querySelector("#ve-progress-size"),c=this._progressWidget?.querySelector("#ve-progress-time");if(t>0&&this._progressWidget){this._progressWidget.style.display="",0!==e&&this._recordingStartTime||(this._recordingStartTime=Date.now()),r&&(r.textContent=n);const d=Math.round(e/t*100);a&&(a.textContent=`${d}% complete`),s&&(s.textContent=`Frame ${e.toLocaleString()} of ${t.toLocaleString()}`);const p=this._estimateFileSize(o,i,this.options.format);if(l&&(l.textContent=`Size: ~${this._formatSize(p)}`),e>0&&c){const o=(Date.now()-this._recordingStartTime)/e*(t-e),i=Math.ceil(o/1e3);if(i<60)c.textContent=`${i} second${1!==i?"s":""} left`;else if(i<3600){const e=Math.floor(i/60),t=i%60;c.textContent=0===t?`${e} minute${1!==e?"s":""} left`:`${e}m ${t}s left`}else{const e=Math.floor(i/3600),t=Math.floor(i%3600/60);c.textContent=`${e}h ${t}m left`}}else c&&(c.textContent="calculating time...")}}_hideProgress(){this._progressWidget&&(this._progressWidget.style.display="none"),this._recordingStartTime=null}_showFinalStats(e){if(!this._progressWidget)return;const t=this._progressWidget.querySelector(".progress-status")?.parentElement,o=this._progressWidget.querySelector(".progress-percent")?.parentElement,i=this._progressWidget.querySelector(".progress-secondary")?.parentElement;t&&(t.style.display="none"),o&&(o.style.display="none"),i&&(i.style.display="none");const n=this._progressWidget.querySelector("#ve-progress-summary");if(n){n.style.display="block";const t=this._progressWidget.querySelector("#ve-summary-video"),o=this._progressWidget.querySelector("#ve-summary-realtime"),i=this._progressWidget.querySelector("#ve-summary-speed"),r=this._progressWidget.querySelector("#ve-summary-size");if(t&&(t.textContent=`${e.videoDuration}s (${e.frameCount} frames @ ${e.fps} fps)`),o&&(o.textContent=`${e.realTime}s`),i){const t=parseFloat(e.speedRatio)>1;i.textContent=`${e.speedRatio}x (${t?"faster":"slower"} than realtime)`,i.style.color=t?"#4CAF50":"#FF9800"}r&&(r.textContent=`${e.sizeMB} MB`)}this._progressWidget.style.display="block",console.log("[UI] Final stats displayed in widget")}_collapseInterface(){if(!this._panel)return;const e=`compact-${this.options.compactPosition}`;if(this._panel.classList.add(e),this._progressWidget){const e=this._progressWidget.querySelector(".progress-status"),t=this._progressWidget.querySelector(".progress-percent"),o=this._progressWidget.querySelector(".progress-secondary"),i=e?e.parentElement:null,n=t?t.parentElement:null,r=o?o.parentElement:null;i&&(i.style.display=""),n&&(n.style.display=""),r&&(r.style.display="");const a=this._progressWidget.querySelector("#ve-progress-summary");a&&(a.style.display="none"),this._progressWidget.style.display="block"}this._panel.querySelectorAll(".form-group").forEach(e=>{e.style.display="none"});this._panel.querySelectorAll("h3, hr").forEach(e=>{e.style.display="none"});const t=this._panel.querySelector("#ve-constraints-group"),o=this._panel.querySelector("#ve-waypoints-group");t&&(t.style.display="none"),o&&(o.style.display="none");this._panel.querySelectorAll("[data-section-content]").forEach(e=>{e.style.display="none"});const i=this._panel.querySelector("#ve-reset-message");i&&(i.style.display="none");const n=this._panel.querySelector("#ve-exploration-limit");if(n){const e=n.closest(".form-group");e&&(e.style.display="none")}const r=this._panel.querySelector(".recording-time-display");r&&(r.style.display="none"),console.log(`[UI] Interface collapsed and moved to ${this.options.compactPosition} corner`)}_expandInterface(){if(!this._panel)return;const e=`compact-${this.options.compactPosition}`;this._panel.classList.remove(e),this._progressWidget&&(this._progressWidget.style.display="none");this._panel.querySelectorAll(".form-group").forEach(e=>{const t=e;if(!t)return;"ve-resolution-custom-group"===t.id||"ve-speed-custom-group"===t.id||"ve-bitrate-custom-group"===t.id||(t.style.display="")});this._panel.querySelectorAll("h3, hr").forEach(e=>{e.style.display=""});const t=this._panel.querySelector("#ve-constraints-group"),o=this._panel.querySelector("#ve-waypoints-group");t&&(t.style.display=""),o&&(o.style.display="");const i=this._panel.querySelector("#ve-format-advanced-toggle"),n=this._panel.querySelector("#ve-format-advanced-group");if(i&&n&&(n.style.display=i.checked?"":"none",i.checked)){const e=this._panel.querySelector("#ve-mp4-advanced"),t=this._panel.querySelector("#ve-webm-vp8-advanced"),o=this._panel.querySelector("#ve-webm-vp9-advanced");e&&t&&o&&(e.style.display="none",t.style.display="none",o.style.display="none","mp4"===this.options.format?e.style.display="":"webm-vp8"===this.options.format?t.style.display="":"webm-vp9"===this.options.format&&(o.style.display=""))}const r=this._panel.querySelector("#ve-resolution"),a=this._panel.querySelector("#ve-resolution-custom-group");r&&a&&(a.style.display="custom"===r.value?"":"none");const s=this._panel.querySelector("#ve-speed"),l=this._panel.querySelector("#ve-speed-custom-group");s&&l&&(l.style.display="custom"===s.value?"":"none");const c=this._panel.querySelector("#ve-bitrate"),d=this._panel.querySelector("#ve-bitrate-custom-group");c&&d&&(d.style.display="custom"===c.value?"":"none");this._panel.querySelectorAll("[data-section-toggle]").forEach(e=>{const t=e;if(!t)return;const o=t.getAttribute("data-section-toggle");if(!o)return;const i=this._panel.querySelector(`[data-section-content="${o}"]`);if(i){const e="true"===t.getAttribute("data-collapsed");i.style.display=e?"none":""}});const p=this._panel.querySelector(".recording-time-display");p&&(p.style.display=""),this._savedWaypointsVisibility=void 0,console.log("[UI] Interface expanded after recording")}async _preloadEncoder(){if(!this._encoderLoaded)try{const e=await this._detectEncoderSources(),{encoderUrl:t,simdUrl:o}=e.mp4;console.log("Loading MP4 encoder from:",t);const i=await import(t);this._loadEncoder=i.default;const n=await import(o);this._simd=n.simd,this._encoderLoaded=!0,console.log("‚úÖ Video encoder loaded from",t.includes("unpkg")?"CDN":"local files")}catch(e){console.warn("Failed to preload encoder:",e)}}async _loadEncoderForFormat(e,t,o,i){console.log(`üîß Loading encoder for format: ${this.options.format}`);const n=await this._detectEncoderSources();let r=this.options.format;if("webm"===r&&(r="webm-vp8",console.log("üìù Format normalized: webm ‚Üí webm-vp8 (backward compatibility)")),"mp4"===r)return console.log("üì¶ Using MP4 encoder"),this._loadMp4Encoder(n.mp4,e,t,o,i);if("webm-vp8"===r)return console.log("üì¶ Using WebM VP8 encoder (webm-wasm realtime)"),this._loadWebmEncoder(n.webm,e,t,o,i);if("webm-vp9"===r)return console.log("üì¶ Using WebM VP9 encoder (WebCodecs)"),this._loadWebCodecsVP9Encoder(e,t,o,i);throw new Error(`Unknown format: ${r} (expected: 'webm-vp8', 'webm-vp9', or 'mp4')`)}async _loadMp4Encoder(e,t,o,i,n){const{encoderUrl:r,simdUrl:a}=e;if(console.log(`[MP4 Encoder] Loading from: ${r}`),!this._loadEncoder){const e=await import(r);this._loadEncoder=e.default}if(!this._simd){const e=await import(a);this._simd=e.simd}const s=await this._simd();if(console.log(`[MP4 Encoder] SIMD support: ${s}`),!this._panel)return null;const l=this._panel.querySelector("#ve-mp4-speed"),c=this._panel.querySelector("#ve-mp4-qp"),d=this._panel.querySelector("#ve-mp4-gop");let p=10,h=10,u=42,m=30;if(l&&(p=parseInt(l.value,10)),c){const[e,t]=c.value.split(",").map(e=>parseInt(e,10));h=e,u=t}d&&(m=parseInt(d.value,10)),console.log(`[MP4 Encoder] Advanced params - Speed: ${p}, QP: ${h}-${u}, GOP: ${m}`),console.log("[MP4 Encoder] Creating new MP4 encoder");const g=(await this._loadEncoder({simd:s})).create({width:t,height:o,fps:i,speed:p,kbps:n,rgbFlipY:!0,quantizationParameter:u,groupOfPictures:m});return console.log(`[MP4 Encoder] Got encoder (${t}x${o}, ${i}fps, ${n}kbps)`),g}async _loadWebmEncoder(e,t,o,i,n){if(e.error)throw new Error(e.error);const{workerUrl:r,wasmUrl:a}=e;if(!r||!a)throw new Error("WebM encoder files not found. Please deploy the vendor/webm/ directory alongside the plugin. See vendor/README.md for deployment instructions.");if(console.log(`[WebM Encoder] Loading from: ${r}`),!this._panel)return null;const s=this._panel.querySelector("#ve-vp8-bitrate-custom"),l=s&&s.value?parseInt(s.value,10):null,c=l||n;console.log(`[WebM Encoder] Bitrate: ${c} kbps ${l?"(custom)":"(auto)"}`);console.log("[WebM Encoder] Creating new WebM encoder");const d=new S;return await d.create({width:t,height:o,fps:i,bitrate:c,wasmUrl:a,workerUrl:r,realtime:!0}),console.log(`[WebM Encoder] Got encoder (${t}x${o}, ${i}fps, ${c}kbps)`),d}async _loadWebCodecsVP9Encoder(e,t,o,i){if(!this._WebCodecsVP9Encoder){const e=await Promise.resolve().then(function(){return ut});this._WebCodecsVP9Encoder=e.WebCodecsVP9Encoder}if(!this._WebCodecsVP9Encoder.isSupported())throw new Error("WebCodecs API not supported in this browser. Use a modern browser or select WebM (VP8) format.");if(!this._panel)return null;const n=this._panel.querySelector("#ve-vp9-quality"),r=this._panel.querySelector("#ve-vp9-latency"),a=this._panel.querySelector("#ve-vp9-bitrate-mode"),s=this._panel.querySelector("#ve-vp9-keyframe"),l=this._panel.querySelector("#ve-vp9-content-hint"),c=n?n.value:"high",d=r?r.value:"quality",p=a?a.value:"variable",h=s?parseInt(s.value,10):120,u=l?l.value:"";console.log("[WebCodecs VP9] Advanced params:",{quality:c,latencyMode:d,bitrateMode:p,keyFrameInterval:h,contentHint:u||"auto"});const m=new this._WebCodecsVP9Encoder;return await m.create({width:e,height:t,fps:o,bitrate:i,quality:c,latencyMode:d,bitrateMode:p,keyFrameInterval:h,contentHint:u}),console.log(`[WebCodecs VP9] Got encoder (${e}x${t}, ${o}fps, ${i}kbps, ${c} quality)`),m}async _detectEncoderSources(){const t=[],o=[],i=(()=>{try{const t=new URL(e&&"SCRIPT"===e.tagName.toUpperCase()&&e.src||new URL("maplibre-gl-video-export.min.js",document.baseURI).href).pathname;return t.substring(0,t.lastIndexOf("/")+1)}catch(e){return null}})();if(i&&(t.push({name:"plugin vendor",encoderUrl:i+"vendor/mp4/mp4-encoder.js",simdUrl:i+"vendor/mp4/index.js"}),o.push({name:"plugin vendor",workerUrl:i+"vendor/webm/webm-worker.js",wasmUrl:i+"vendor/webm/webm-wasm.wasm"})),this.options.encoderPath){const e=this.options.encoderPath.endsWith("/")?this.options.encoderPath:this.options.encoderPath+"/";t.push({name:"custom path",encoderUrl:e+"mp4-encoder.js",simdUrl:e+"index.js"}),o.push({name:"custom path",workerUrl:e+"webm-worker.js",wasmUrl:e+"webm-wasm.wasm"})}let n=null;for(const e of t)try{if((await fetch(e.encoderUrl,{method:"HEAD"})).ok){console.log(`‚úÖ Found MP4 encoder at ${e.name}: ${e.encoderUrl}`),n=e;break}}catch(e){}n||(console.log("‚ÑπÔ∏è Using CDN for MP4 encoder (no local files found)"),n={name:"CDN",encoderUrl:this.options.encoderCdn+"mp4-encoder.js",simdUrl:"https://unpkg.com/wasm-feature-detect?module"});let r=null;for(const e of o)try{if((await fetch(e.workerUrl,{method:"HEAD"})).ok){console.log(`‚úÖ Found WebM encoder at ${e.name}: ${e.workerUrl}`),r=e;break}}catch(e){}return r||(console.error("‚ùå WebM encoder files not found!"),r={name:"NOT_FOUND",workerUrl:null,wasmUrl:null,error:"WebM encoding requires local files. Please deploy the vendor/webm/ directory alongside the plugin."}),{mp4:n,webm:r}}_readOptionsFromUI(){if(!this._panel)return;const e=this._panel.querySelector("#ve-animation");e&&(this.options.animation=e.value);const t=this._panel.querySelector("#ve-duration");if(t)if("custom"===t.value){const e=this._panel.querySelector("#ve-duration-custom");this.options.duration=e?1e3*parseFloat(e.value):3e4}else this.options.duration=1e3*parseFloat(t.value);const o=this._panel.querySelector("#ve-speed");if(o)if("custom"===o.value){const e=this._panel.querySelector("#ve-speed-custom");this.options.speedMultiplier=e?parseFloat(e.value):1}else this.options.speedMultiplier=parseFloat(o.value);const i=this._panel.querySelector("#ve-fps");i&&(this.options.fps=parseFloat(i.value));const n=this._panel.querySelector("#ve-resolution");if(n)if("custom"===n.value){const e=this._panel.querySelector("#ve-resolution-width-custom"),t=this._panel.querySelector("#ve-resolution-height-custom");this.options.resolution={width:e?parseInt(e.value,10):1920,height:t?parseInt(t.value,10):1080}}else this.options.resolution=n.value;const r=this._panel.querySelector("#ve-cinematic-bars");r&&(this.options.cinematicBars=r.value);const a=this._panel.querySelector("#ve-format");a&&(this.options.format=a.value);const s=this._panel.querySelector("#ve-bitrate");if(s)if("custom"===s.value){const e=this._panel.querySelector("#ve-bitrate-custom");this.options.bitrate=e?parseInt(e.value,10):"auto"}else this.options.bitrate="auto"===s.value?"auto":parseInt(s.value,10);const l=this._panel.querySelector("#ve-wait-tiles");l&&(this.options.waitForTiles=l.checked);const c=this._panel.querySelector("#ve-loop");c&&(this.options.loop="false"!==c.value&&c.value);const d=this._panel.querySelector("#ve-bounds-west"),p=this._panel.querySelector("#ve-bounds-east"),h=this._panel.querySelector("#ve-bounds-south"),u=this._panel.querySelector("#ve-bounds-north");if(d&&p&&h&&u){const e=d.value,t=p.value,o=h.value,i=u.value;this.options.maxBounds=e&&t&&o&&i?[[parseFloat(e),parseFloat(o)],[parseFloat(t),parseFloat(i)]]:null}const m=this._panel.querySelector("#ve-zoom-min"),g=this._panel.querySelector("#ve-zoom-max");m&&(this.options.minZoom=m.value?parseFloat(m.value):null),g&&(this.options.maxZoom=g.value?parseFloat(g.value):null);const f=this._panel.querySelector("#ve-strict-bounds");f&&(this.options.strictBounds=f.checked);const y=this._panel.querySelector("#ve-show-bounds");y&&(this.options.showBoundsOverlay=y.checked);const b=this._panel.querySelector("#ve-exploration-limit");b&&(this.options.explorationLimitEnabled=b.checked)}async _getAnimation(){let e;if("function"==typeof this.options.animation)e=this.options.animation;else if("object"==typeof this.options.animation&&null!==this.options.animation){const t=this.options.animation;t.func&&(e=t.func)}else if("string"==typeof this.options.animation){const t=C[this.options.animation];if(t){const o=new b(this._map);e=(e,i)=>t.func(e,i,this.options,o)}else{console.warn(`Animation "${this.options.animation}" not found, falling back to "smart"`);const t=new b(this._map);e=(e,o)=>t.createAdaptiveAnimation(o,this.options)}}else{console.warn('Unknown animation type, falling back to "smart"');const t=new b(this._map);e=(e,o)=>t.createAdaptiveAnimation(o,this.options)}let t=null,o=null;const i=e(this._map,this);if("object"==typeof i&&null!==i&&"animation"in i?(t=i.setup||null,o=i.animation,t&&console.log("üé¨ Animation with setup phase")):(console.log("‚ö†Ô∏è Legacy animation format detected, wrapping"),t=null,o=async()=>i),this.options.loop&&(o=this._addLoopToAnimation(o)),this.options.maxBounds||null!==this.options.minZoom||null!==this.options.maxZoom){o=new m({maxBounds:this.options.maxBounds,minZoom:this.options.minZoom,maxZoom:this.options.maxZoom,strictBounds:this.options.strictBounds}).wrapAnimation(o),console.log("üîí Animation constraints applied:",{maxBounds:this.options.maxBounds,minZoom:this.options.minZoom,maxZoom:this.options.maxZoom,strictBounds:this.options.strictBounds})}return{setup:t,animation:o}}_addLoopToAnimation(e){return async(t,o)=>{const i={center:t.getCenter(),zoom:t.getZoom(),pitch:t.getPitch(),bearing:t.getBearing()};console.log("üìç Initial position captured:",i.center.lng.toFixed(6),i.center.lat.toFixed(6)),console.log("‚ñ∂Ô∏è Starting original animation..."),await e(t,o),console.log("‚úÖ Original animation complete");const n={center:t.getCenter(),zoom:t.getZoom(),pitch:t.getPitch(),bearing:t.getBearing()};if(console.log("üìç Final position:",n.center.lng.toFixed(6),n.center.lat.toFixed(6)),console.log("üîÑ Loop enabled, adding return step"),"smooth"===this.options.loop){const e=Math.min(2e3,.2*this.options.duration);console.log("Smooth return, duration:",e),o.updateStatus&&o.updateStatus("üîÑ Returning to start..."),t.easeTo({center:i.center,zoom:i.zoom,pitch:i.pitch,bearing:i.bearing,duration:e,essential:!0}),await t.once("moveend"),console.log("Return complete")}else t.jumpTo({center:i.center,zoom:i.zoom,pitch:i.pitch,bearing:i.bearing})}}_updateExplorationUI(){if(!this._panel)return;let e=!1;if("string"==typeof this.options.animation){const t=C[this.options.animation];e=!!t&&t.supportsExploration}else if("object"==typeof this.options.animation&&null!==this.options.animation){const t=this.options.animation;void 0!==t.supportsExploration&&(e=t.supportsExploration)}const t=this._panel.querySelector("#ve-explore");t&&(t.style.display=e?"inline-block":"none");const o=this._panel.querySelector("#ve-exploration-limit-container");o&&(o.style.display=e?"block":"none"),console.log(`[UI] Animation ${e?"supports":"does not support"} exploration`)}_updateAnimationDescription(){if(!this._panel)return;const e=this._panel.querySelector("#ve-animation-description"),t=e?.querySelector("span");if(!e||!t)return;const o="string"==typeof this.options.animation?this.options.animation:null;if(o&&C[o]){const i=C[o];i.description?(t.textContent=i.description,e.style.display="block"):e.style.display="none"}else e.style.display="none"}_analyzeCapabilities(){const e=new b(this._map).capabilities,t={required:{},optional:{}},o=[];Object.entries(C).forEach(([o,i])=>{i.requires&&0!==i.requires.length&&i.requires.forEach(n=>{const r=n.startsWith("?"),a=r?n.slice(1):n;if(!e[a]){const e=r?"optional":"required";t[e][a]||(t[e][a]=[]),t[e][a].push({key:o,label:i.label})}})});const i={hasTerrain:"Terrain 3D",hasHillshade:"Hillshade",has3DBuildings:"Buildings 3D",hasRoads:"Roads",hasRailways:"Railways",hasWaterways:"Waterways",hasWater:"Water bodies",hasPlaces:"Places/Cities",hasGlyphs:"Fonts/Glyphs",hasSprites:"Sprites/Icons"};return Object.entries(e).forEach(([e,t])=>{t&&i[e]&&o.push(i[e])}),{missing:t,available:o,capabilityLabels:i}}_checkMapCapabilities(){if(!this._panel)return;const e=void 0!==this._map.getSource("openmaptiles"),t=this._panel.querySelector("#ve-road-animations-group");t&&(e?(t.style.display="",console.log("[UI] OpenMapTiles detected - road animations available")):(t.style.display="none",console.log("[UI] OpenMapTiles not found - road animations hidden"))),this._updateCapabilityFeedback()}_updateCapabilityFeedback(){if(!this._panel)return;const e=this._panel.querySelector("#ve-capability-feedback");if(!e)return;const t=this._analyzeCapabilities(),{missing:o}=t,i=Object.keys(o.required).length>0,n=Object.keys(o.optional).length>0;if(!i&&!n)return e.innerHTML='\n                <div style="padding: 8px; background: #d4edda; border: 1px solid #c3e6cb; border-radius: 4px; color: #155724; font-size: 12px;">\n                    ‚úÖ <strong>Optimal map</strong> - All animations available\n                </div>\n            ',void(e.style.display="block");let r='<div style="padding: 8px; background: #fff3cd; border: 1px solid #ffc107; border-radius: 4px; font-size: 11px;">';i&&(r+='<div style="color: #856404; margin-bottom: 6px;">',r+="<strong>‚ö†Ô∏è Missing required features:</strong><br>",Object.entries(o.required).forEach(([e,o])=>{const i=t.capabilityLabels[e]||e;r+=`<span style="color: #d63384;">‚Ä¢ ${i}</span> `,r+=`<span style="color: #6c757d; font-size: 10px;">(${o.length} animation${o.length>1?"s":""} disabled)</span><br>`}),r+="</div>"),n&&(r+='<div style="color: #856404; font-size: 10px;">',r+="<strong>üí° Optional enhancements missing:</strong><br>",Object.entries(o.optional).forEach(([e,o])=>{const i=t.capabilityLabels[e]||e;r+=`<span>‚Ä¢ ${i}</span> `,r+=`<span style="color: #6c757d;">(${o.length} animation${o.length>1?"s":""} affected)</span><br>`}),r+="</div>"),r+="</div>",e.innerHTML=r,e.style.display="block"}async _testAnimation(){if(!this._panel)return;const e=this._panel.querySelector("#ve-test"),t=this._panel.querySelector("#ve-record");if(!e||!t)return;this._saveSettings();const o=this._panel.querySelector("#ve-reset-message");if(o&&(o.style.display="none"),this._animationController.running)return this._animationController.cancel(this._map),this._testProgressTimer&&(clearInterval(this._testProgressTimer),this._testProgressTimer=null),e.innerHTML="‚ñ∂Ô∏è Test",e.disabled=!1,t.disabled=!1,this._updateStatus("Cancelled","error"),void this._expandInterface();e.innerHTML="‚èπÔ∏è Cancel",t.disabled=!0,this._collapseInterface();try{this._updateStatus("Testing animation...","recording"),this._readOptionsFromUI();const{setup:e,animation:t}=await this._getAnimation();e&&(console.log("üé¨ Executing animation setup phase (for test)..."),this._updateStatus("Preparing animation...","recording"),await e(this._map,this,{checkAbort:()=>{if(this._animationController.aborted)throw new Error("Test cancelled")},updateStatus:e=>{e&&this._updateStatus(e,"recording")}}),console.log("‚úì Setup phase complete"));const o=performance.now(),i=this.options.duration;this._progressWidget&&(this._progressWidget.style.display="block"),this._testProgressTimer=setInterval(()=>{const e=performance.now()-o,t=(e/1e3).toFixed(1),n=(i/1e3).toFixed(1),r=Math.min(100,e/i*100).toFixed(0),a=this._progressWidget?.querySelector("#ve-progress-status"),s=this._progressWidget?.querySelector("#ve-progress-percent"),l=this._progressWidget?.querySelector("#ve-progress-time");a&&(a.textContent="‚ñ∂Ô∏è Testing"),s&&(s.textContent=`${r}% complete`),l&&(l.textContent=`${t}s / ${n}s`)},100);const n=await this._animationController.run(this._map,t,{updateStatus:e=>{e&&this._updateStatus(e,"recording")}});n.cancelled?this._updateStatus("Cancelled","error"):n.success&&this._updateStatus("Test complete","success")}catch(e){this._updateStatus("Test failed: "+e.message,"error"),this.options.onError(e)}finally{this._testProgressTimer&&(clearInterval(this._testProgressTimer),this._testProgressTimer=null),e.innerHTML="‚ñ∂Ô∏è Test",e.disabled=!1,t.disabled=!1,this._expandInterface()}}async _startExploration(){if(!this._panel)return;const e=this._panel.querySelector("#ve-explore"),t=this._panel.querySelector("#ve-test"),o=this._panel.querySelector("#ve-record");if(!e||!t||!o)return;this._saveSettings();const i=this._panel.querySelector("#ve-reset-message");if(i&&(i.style.display="none"),this._animationController.running)return this._animationController.cancel(this._map),this._exploreProgressTimer&&(clearInterval(this._exploreProgressTimer),this._exploreProgressTimer=null),e.innerHTML="üó∫Ô∏è Explore",t.disabled=!1,o.innerHTML="üî¥ Record",o.disabled=!1,this._updateStatus("Exploration stopped","error"),this._expandInterface(),void(this._isExploring=!1);this._isExploring=!0,e.innerHTML="‚èπÔ∏è Stop",t.disabled=!0,o.innerHTML="üìç Record from here",o.disabled=!1,this._collapseInterface();try{this._updateStatus("üó∫Ô∏è Exploring roads...","recording"),console.log("[Exploration] Starting infinite road exploration"),this._readOptionsFromUI();const{setup:e,animation:t}=await this._getAnimation();e&&(console.log("üé¨ Executing animation setup phase (for exploration)..."),this._updateStatus("Preparing exploration...","recording"),await e(this._map,this,{checkAbort:()=>{if(this._animationController.aborted)throw new Error("Exploration cancelled")},updateStatus:e=>{e&&this._updateStatus(e,"recording")}}),console.log("‚úì Setup complete - starting infinite exploration"));const o=this._panel.querySelector("#ve-exploration-limit"),i=o?.checked||!1,n=this.options.duration;i?(this.options.duration=this.options.explorationMaxDuration,console.log(`üó∫Ô∏è Exploration limited to ${(this.options.explorationMaxDuration/1e3).toFixed(0)}s`)):(this.options.duration=999999999,console.log("üó∫Ô∏è Infinite exploration (no duration limit)")),this._progressWidget&&(this._progressWidget.style.display="block");const r=performance.now(),a=i?this.options.explorationMaxDuration:null;this._exploreProgressTimer=setInterval(()=>{const e=performance.now()-r,t=(e/1e3).toFixed(1),o=this._progressWidget?.querySelector("#ve-progress-status"),n=this._progressWidget?.querySelector("#ve-progress-percent"),s=this._progressWidget?.querySelector("#ve-progress-time");if(o&&(o.textContent="üó∫Ô∏è Exploring"),i&&a){const o=Math.min(100,e/a*100).toFixed(0),i=Math.max(0,(a-e)/1e3).toFixed(1);n&&(n.textContent=`${o}% complete`),s&&(s.textContent=`${t}s / ${(a/1e3).toFixed(0)}s (${i}s left)`)}else n&&(n.textContent="Infinite exploration"),s&&(s.textContent=`${t}s elapsed`)},100);const s=await this._animationController.run(this._map,t,{updateStatus:e=>{e&&this._updateStatus(e,"recording")}});this.options.duration=n,s.cancelled?this._updateStatus("Exploration stopped","error"):this._updateStatus("Exploration complete","success")}catch(e){this._updateStatus("Exploration failed: "+e.message,"error"),this.options.onError(e)}finally{this._exploreProgressTimer&&(clearInterval(this._exploreProgressTimer),this._exploreProgressTimer=null),e.innerHTML="üó∫Ô∏è Explore",t.disabled=!1,o.innerHTML="üî¥ Record",o.disabled=!1,this._expandInterface(),this._isExploring=!1}}async _startRecording(){if(!this._panel)return;const e=this._panel.querySelector("#ve-test"),t=this._panel.querySelector("#ve-explore"),o=this._panel.querySelector("#ve-record");if(!e||!t||!o)return;this._saveSettings();const i=this._panel.querySelector("#ve-reset-message");if(i&&(i.style.display="none"),this._isExploring&&this._animationController.running&&(console.log("[Recording] üìç Starting recording from current exploration position"),this._animationController.cancel(this._map),this._isExploring=!1,t&&(t.innerHTML="üó∫Ô∏è Explore"),e&&(e.disabled=!0),o&&(o.innerHTML="‚èπÔ∏è Cancel"),this._updateStatus("Recording from current position...","recording"),await new Promise(e=>setTimeout(e,500))),this._animationController.running)return this._animationController.cancel(this._map),e.disabled=!1,o.innerHTML="üî¥ Record",o.disabled=!1,this._updateStatus("Cancelled","error"),this._hideProgress(),this._expandInterface(),this._isRecording=!1,console.log("[Recording] üîì Recording flag CLEARED on cancel"),void(maplibregl.restoreNow&&maplibregl.restoreNow());if(this._isRecording)return console.warn("[Recording] ‚ö†Ô∏è Cannot start new recording - previous recording still cleaning up"),void this._updateStatus("Please wait...","error");if(!window.maplibregl||"function"!=typeof maplibregl.setNow)return this._updateStatus("Time control not available","error"),void alert("MapLibre time control (setNow/restoreNow) is required for video export.\n\nPlease use MapLibre GL JS v5.10.0 or later.");e.disabled=!0,o.innerHTML="‚èπÔ∏è Cancel",this._collapseInterface();try{this._readOptionsFromUI(),console.log("[Recording] üî¥ Starting recording..."),await this._doRecording()}catch(e){"AbortError"===e.name||"Recording cancelled"===e.message?this._updateStatus("Cancelled","error"):(console.error("Recording error:",e),this._updateStatus("Recording failed","error"),this.options.onError(e)),this._hideProgress()}finally{e.disabled=!1,o.innerHTML="üî¥ Record",this._expandInterface(),maplibregl.restoreNow&&maplibregl.restoreNow()}}async _ensureCameraWithinConstraints(){if(!this.options.maxBounds&&null===this.options.minZoom&&null===this.options.maxZoom)return void console.log("[Constraints] No constraints configured, skipping camera check");console.log("[Constraints] Checking camera position against constraints...");const e=this._map.getCenter(),t=this._map.getZoom();let o=!1,i=e,n=t;if(this.options.maxBounds){const[[t,n],[r,a]]=this.options.maxBounds,s=e.lng,l=e.lat;if(s<t||s>r||l<n||l>a){o=!0;const e=Math.max(t,Math.min(r,s)),c=Math.max(n,Math.min(a,l));i={lng:e,lat:c},console.log(`[Constraints] Camera outside bounds: [${s.toFixed(4)}, ${l.toFixed(4)}] ‚Üí [${e.toFixed(4)}, ${c.toFixed(4)}]`)}}if(null!==this.options.minZoom&&t<this.options.minZoom?(o=!0,n=this.options.minZoom,console.log(`[Constraints] Zoom below minimum: ${t.toFixed(2)} ‚Üí ${n.toFixed(2)}`)):null!==this.options.maxZoom&&t>this.options.maxZoom&&(o=!0,n=this.options.maxZoom,console.log(`[Constraints] Zoom above maximum: ${t.toFixed(2)} ‚Üí ${n.toFixed(2)}`)),o)return console.log("[Constraints] ‚ö†Ô∏è Camera outside constraints - correcting position..."),new Promise(e=>{this._map.easeTo({center:i,zoom:n,duration:1e3,easing:e=>e}),this._map.once("moveend",()=>{console.log("[Constraints] ‚úì Camera position corrected"),e()})});console.log("[Constraints] ‚úì Camera already within constraints")}_applyCinematicBars(e,t,o,i){if("none"===i)return;const n=parseFloat(i),r=Math.floor(t/n);if(r>=o)return void console.warn(`üé¨ Cinematic bars skipped: aspect ratio ${i}:1 requires height >= ${r}px (current: ${o}px)`);const a=o-r,s=Math.floor(a/2),l=a-s;if(s<0||l<0)return void console.warn(`üé¨ Cinematic bars skipped: invalid bar heights (top: ${s}px, bottom: ${l}px)`);console.log(`üé¨ Applying cinematic bars: ${i}:1 (visible: ${r}px, bars: ${s}px + ${l}px)`);const c=4*t;for(let o=0;o<s;o++){const i=o*c;for(let o=0;o<t;o++){const t=i+4*o;e[t]=0,e[t+1]=0,e[t+2]=0,e[t+3]=255}}for(let i=o-l;i<o;i++){const o=i*c;for(let i=0;i<t;i++){const t=o+4*i;e[t]=0,e[t+1]=0,e[t+2]=0,e[t+3]=255}}}async _doRecording(){if(!this._panel)return;const e=performance.now();console.log("üé¨ Starting recording with format:",this.options.format),await this._ensureCameraWithinConstraints(),this._updateStatus(`Loading ${this.options.format.toUpperCase()} encoder...`,"recording"),this._isRecording=!0,console.log("[Recording] üîí Recording flag SET - layer updates blocked");const t=this._getResolution(),{width:o,height:i}=t,n=this._panel.querySelector("#ve-cinematic-bars"),r=n?n.value:"none";console.log("üé¨ Cinematic bars:",r);let a=this.options.bitrate;if("auto"===a){const e=o*i;"webm-vp8"===this.options.format||"webm"===this.options.format?(a=e<=921600?8e3:e<=2073600?12e3:e<=3686400?16e3:25e3,console.log(`Auto bitrate (VP8 realtime): ${a} kbps for ${o}√ó${i}`)):(a=e<=921600?5e3:e<=2073600?8e3:e<=3686400?12e3:2e4,console.log(`Auto bitrate (${this.options.format}): ${a} kbps for ${o}√ó${i}`))}this._updateStatus(`Initializing ${o}√ó${i}...`,"recording");const s=this._map.getContainer(),l={width:s.style.width,height:s.style.height},c={center:this._map.getCenter(),zoom:this._map.getZoom(),pitch:this._map.getPitch(),bearing:this._map.getBearing()};"auto"!==this.options.resolution&&(s.style.width=o+"px",s.style.height=i+"px",this._map.resize(),this._map.jumpTo({center:c.center,zoom:c.zoom,pitch:c.pitch,bearing:c.bearing}),await new Promise(e=>setTimeout(e,500))),this._hideWaypointMarkers(),await this._createWaypointsWebGLLayer(),this._recordingParams={width:o,height:i,fps:this.options.fps,bitrate:a};let d=null;try{d=await this._loadEncoderForFormat(o,i,this.options.fps,a),this._encoder=d;const t=this._map.painter.context.gl;let n=null;"mp4"===this.options.format&&(n=d.getRGBPointer());let p=0,h=0;const u=1e3/this.options.fps*this.options.speedMultiplier;console.log(`Time advance: ${u.toFixed(2)}ms per frame (${this.options.speedMultiplier}x speed at ${this.options.fps} fps)`),console.log("‚è≥ Wait for tiles: "+(this.options.waitForTiles?"enabled (slower, better quality)":"disabled (faster)"));const{setup:m,animation:g}=await this._getAnimation();m&&(console.log("üé¨ Executing animation setup phase (before time freeze)..."),this._updateStatus("Preparing animation...","recording"),await m(this._map,this,{checkAbort:()=>{if(this._animationController.aborted)throw new Error("Recording cancelled")},updateStatus:e=>{e&&this._updateStatus(e,"recording")}}),console.log("‚úì Setup phase complete")),maplibregl.setNow(h);const f=async()=>{if(this._map.areTilesLoaded())return;for(let e=0;e<5;e++)if(this._map.triggerRepaint(),await new Promise(e=>setTimeout(e,20)),this._map.areTilesLoaded())return};let y=this.options.duration/this.options.speedMultiplier;{if(this.options.loop){const e=Math.min(2e3,.2*this.options.duration);y+=e/this.options.speedMultiplier,console.log("Loop enabled, adding",e,"ms for return. Total duration:",y)}const e=Math.floor(y/1e3*this.options.fps);this._updateProgress(0,e,a,y),this._updateStatus("Recording animation...","recording");let c=!1;this._animationController.run(this._map,g,{updateStatus:e=>{e&&this._updateStatus(e,"recording")}}).then(()=>{c=!0,console.log("üé¨ Animation wrapper complete (including return)")}).catch(e=>{"AbortError"!==e.name&&console.error("Animation error:",e),c=!0}),await new Promise(e=>setTimeout(e,100));try{for(;!c&&p<e;){if(h+=u,maplibregl.setNow(h),this._map.triggerRepaint(),this.options.waitForTiles&&await f(),await new Promise(e=>this._map.once("render",e)),"mp4"===this.options.format){const e=d.memory().subarray(n);t.readPixels(0,0,o,i,t.RGBA,t.UNSIGNED_BYTE,e),this._applyCinematicBars(e,o,i,r),d.encodeRGBPointer()}else{const e=new ArrayBuffer(o*i*4),n=new Uint8Array(e);t.readPixels(0,0,o,i,t.RGBA,t.UNSIGNED_BYTE,n);const a=new Uint8Array(o*i*4),s=4*o;for(let e=0;e<i;e++){const t=e*s,o=(i-1-e)*s;a.set(n.subarray(t,t+s),o)}this._applyCinematicBars(a,o,i,r),1===p&&console.log("[WebM] First frame captured and flipped:",{width:o,height:i,bufferSize:a.byteLength,firstPixels:Array.from(a.slice(0,16))}),await d.addFrame(a)}if(p++,this._updateProgress(p,e,a,y),p%this.options.fps===0){const e=Math.floor(p/this.options.fps);this._updateStatus(`Recording... ${e}s`,"recording"),this.options.onProgress(p,h)}}c?console.log("‚úÖ Animation complete, captured",p,"frames"):console.log("‚ö†Ô∏è Reached target frames (",p,"), stopping capture")}catch(e){throw maplibregl.restoreNow(),"auto"!==this.options.resolution&&(s.style.width=l.width,s.style.height=l.height,this._map.resize()),e}}maplibregl.restoreNow(),this._updateStatus("Encoding video...","recording");const b=this._progressWidget?.querySelector("#ve-progress-status");b&&(b.textContent="Encoding");const v=await d.end(),w="mp4"===this.options.format?"video/mp4":"video/webm",x=new Blob([v],{type:w});"auto"!==this.options.resolution&&(s.style.width=l.width,s.style.height=l.height,this._map.resize(),this._map.jumpTo({center:c.center,zoom:c.zoom,pitch:c.pitch,bearing:c.bearing}));const _=document.createElement("a");_.href=URL.createObjectURL(x);const S="mp4"===this.options.format?"mp4":"webm";_.download=`maplibre-video-${(new Date).toISOString().slice(0,19).replace(/:/g,"-")}.${S}`,_.click();const k=(x.size/1024/1024).toFixed(2),C=((performance.now()-e)/1e3).toFixed(1),E=(y/1e3).toFixed(1),T=(y/(performance.now()-e)).toFixed(2);console.log("‚úÖ Export complete!"),console.log(`   üìπ Video: ${E}s (${p} frames @ ${this.options.fps} fps)`),console.log(`   ‚è±Ô∏è  Real time: ${C}s`),console.log(`   ‚ö° Speed: ${T}x realtime (${parseFloat(T)>1?"faster":"slower"} than realtime)`),console.log(`   üíæ Size: ${k} MB`),this._showFinalStats({videoDuration:E,frameCount:p,fps:this.options.fps,realTime:C,speedRatio:T,sizeMB:k}),this._updateStatus(`‚úÖ Complete! ${k} MB`,"success"),this.options.onComplete(x,p)}finally{d&&(d.destroy?(d.destroy(),console.log("WebM encoder destroyed")):d.delete&&(d.delete(),console.log("MP4 encoder deleted"))),this._encoder=null,this._recordingParams=null,this._isRecording=!1,console.log("[Recording] üîì Recording flag CLEARED - marker updates enabled"),this._removeWaypointsWebGLLayer(),this._showWaypointMarkers()}}_getResolution(){const e={auto:null,hd:{width:1280,height:720},fullhd:{width:1920,height:1080},"4k":{width:3840,height:2160},"8k":{width:7680,height:4320}};if("auto"===this.options.resolution){const e=this._map.getContainer();return{width:16*Math.floor(e.offsetWidth/16),height:16*Math.floor(e.offsetHeight/16)}}if("object"==typeof this.options.resolution&&this.options.resolution.width)return{width:16*Math.floor(this.options.resolution.width/16),height:16*Math.floor(this.options.resolution.height/16)};const t=e[this.options.resolution]||e.fullhd;return{width:16*Math.floor(t.width/16),height:16*Math.floor(t.height/16)}}}
/*!
   * Copyright (c) 2025-present, Vanilagy and contributors
   *
   * This Source Code Form is subject to the terms of the Mozilla Public
   * License, v. 2.0. If a copy of the MPL was not distributed with this
   * file, You can obtain one at https://mozilla.org/MPL/2.0/.
   */
function M(e){if(!e)throw new Error("Assertion failed.")}T.version="0.1.0","undefined"!=typeof window&&window.maplibregl&&(window.maplibregl.VideoExportControl=T);const P=e=>e&&e[e.length-1];class F{constructor(e){this.bytes=e,this.pos=0}seekToByte(e){this.pos=8*e}readBit(){const e=Math.floor(this.pos/8),t=this.bytes[e]??0,o=7-(7&this.pos),i=(t&1<<o)>>o;return this.pos++,i}readBits(e){if(1===e)return this.readBit();let t=0;for(let o=0;o<e;o++)t<<=1,t|=this.readBit();return t}writeBits(e,t){const o=this.pos+e;for(let e=this.pos;e<o;e++){const i=Math.floor(e/8);let n=this.bytes[i];const r=7-(7&e);n&=~(1<<r),n|=(t&1<<o-e-1)>>o-e-1<<r,this.bytes[i]=n}this.pos=o}readAlignedByte(){if(this.pos%8!=0)throw new Error("Bitstream is not byte-aligned.");const e=this.pos/8,t=this.bytes[e]??0;return this.pos+=8,t}skipBits(e){this.pos+=e}getBitsLeft(){return 8*this.bytes.length-this.pos}clone(){const e=new F(this.bytes);return e.pos=this.pos,e}}const I=e=>e.constructor===Uint8Array?e:e instanceof ArrayBuffer?new Uint8Array(e):new Uint8Array(e.buffer,e.byteOffset,e.byteLength);new TextDecoder;const $=new TextEncoder,W=e=>Object.fromEntries(Object.entries(e).map(([e,t])=>[t,e])),A={bt709:1,bt470bg:5,smpte170m:6,bt2020:9,smpte432:12};W(A);const L={bt709:1,smpte170m:6,linear:8,"iec61966-2-1":13,pq:16,hlg:18};W(L);const z={rgb:0,bt709:1,bt470bg:5,smpte170m:6,"bt2020-ncl":9};W(z);const B=e=>!!(e&&e.primaries&&e.transfer&&e.matrix&&void 0!==e.fullRange),R=e=>e instanceof ArrayBuffer||"undefined"!=typeof SharedArrayBuffer&&e instanceof SharedArrayBuffer||ArrayBuffer.isView(e);class q{constructor(){this.currentPromise=Promise.resolve()}async acquire(){let e;const t=new Promise(t=>{e=t}),o=this.currentPromise;return this.currentPromise=t,await o,e}}const D=e=>{throw new Error(`Unexpected value: ${e}`)},N=(e,t)=>Math.round(e/t)*t,V=/^[a-z]{3}$/,U=1e6*(1+Number.EPSILON);class H{constructor(){this.currentPromise=Promise.resolve()}call(e){return this.currentPromise=this.currentPromise.then(e)}}let O=null;const j=()=>null!==O?O:O="undefined"!=typeof navigator&&navigator.userAgent?.includes("Firefox"),Z=e=>{switch(e.toLowerCase()){case"image/jpeg":case"image/jpg":return".jpg";case"image/png":return".png";case"image/gif":return".gif";case"image/webp":return".webp";case"image/bmp":return".bmp";case"image/svg+xml":return".svg";case"image/tiff":return".tiff";case"image/avif":return".avif";case"image/x-icon":case"image/vnd.microsoft.icon":return".ico";default:return null}},G=(e,t)=>{if(e.length!==t.length)return!1;for(let o=0;o<e.length;o++)if(e[o]!==t[o])return!1;return!0};
/*!
   * Copyright (c) 2025-present, Vanilagy and contributors
   *
   * This Source Code Form is subject to the terms of the Mozilla Public
   * License, v. 2.0. If a copy of the MPL was not distributed with this
   * file, You can obtain one at https://mozilla.org/MPL/2.0/.
   */
class K{constructor(e,t){if(this.data=e,this.mimeType=t,!(e instanceof Uint8Array))throw new TypeError("data must be a Uint8Array.");if("string"!=typeof t)throw new TypeError("mimeType must be a string.")}}class Q{constructor(e,t,o,i){if(this.data=e,this.mimeType=t,this.name=o,this.description=i,!(e instanceof Uint8Array))throw new TypeError("data must be a Uint8Array.");if(void 0!==t&&"string"!=typeof t)throw new TypeError("mimeType, when provided, must be a string.");if(void 0!==o&&"string"!=typeof o)throw new TypeError("name, when provided, must be a string.");if(void 0!==i&&"string"!=typeof i)throw new TypeError("description, when provided, must be a string.")}}const X=["avc","hevc","vp9","av1","vp8"],J=["pcm-s16","pcm-s16be","pcm-s24","pcm-s24be","pcm-s32","pcm-s32be","pcm-f32","pcm-f32be","pcm-f64","pcm-f64be","pcm-u8","pcm-s8","ulaw","alaw"],Y=["aac","opus","mp3","vorbis","flac"],ee=[...Y,...J],te=["webvtt"],oe=[{maxMacroblocks:99,maxBitrate:64e3,level:10},{maxMacroblocks:396,maxBitrate:192e3,level:11},{maxMacroblocks:396,maxBitrate:384e3,level:12},{maxMacroblocks:396,maxBitrate:768e3,level:13},{maxMacroblocks:396,maxBitrate:2e6,level:20},{maxMacroblocks:792,maxBitrate:4e6,level:21},{maxMacroblocks:1620,maxBitrate:4e6,level:22},{maxMacroblocks:1620,maxBitrate:1e7,level:30},{maxMacroblocks:3600,maxBitrate:14e6,level:31},{maxMacroblocks:5120,maxBitrate:2e7,level:32},{maxMacroblocks:8192,maxBitrate:2e7,level:40},{maxMacroblocks:8192,maxBitrate:5e7,level:41},{maxMacroblocks:8704,maxBitrate:5e7,level:42},{maxMacroblocks:22080,maxBitrate:135e6,level:50},{maxMacroblocks:36864,maxBitrate:24e7,level:51},{maxMacroblocks:36864,maxBitrate:24e7,level:52},{maxMacroblocks:139264,maxBitrate:24e7,level:60},{maxMacroblocks:139264,maxBitrate:48e7,level:61},{maxMacroblocks:139264,maxBitrate:8e8,level:62}],ie=[{maxPictureSize:36864,maxBitrate:128e3,tier:"L",level:30},{maxPictureSize:122880,maxBitrate:15e5,tier:"L",level:60},{maxPictureSize:245760,maxBitrate:3e6,tier:"L",level:63},{maxPictureSize:552960,maxBitrate:6e6,tier:"L",level:90},{maxPictureSize:983040,maxBitrate:1e7,tier:"L",level:93},{maxPictureSize:2228224,maxBitrate:12e6,tier:"L",level:120},{maxPictureSize:2228224,maxBitrate:3e7,tier:"H",level:120},{maxPictureSize:2228224,maxBitrate:2e7,tier:"L",level:123},{maxPictureSize:2228224,maxBitrate:5e7,tier:"H",level:123},{maxPictureSize:8912896,maxBitrate:25e6,tier:"L",level:150},{maxPictureSize:8912896,maxBitrate:1e8,tier:"H",level:150},{maxPictureSize:8912896,maxBitrate:4e7,tier:"L",level:153},{maxPictureSize:8912896,maxBitrate:16e7,tier:"H",level:153},{maxPictureSize:8912896,maxBitrate:6e7,tier:"L",level:156},{maxPictureSize:8912896,maxBitrate:24e7,tier:"H",level:156},{maxPictureSize:35651584,maxBitrate:6e7,tier:"L",level:180},{maxPictureSize:35651584,maxBitrate:24e7,tier:"H",level:180},{maxPictureSize:35651584,maxBitrate:12e7,tier:"L",level:183},{maxPictureSize:35651584,maxBitrate:48e7,tier:"H",level:183},{maxPictureSize:35651584,maxBitrate:24e7,tier:"L",level:186},{maxPictureSize:35651584,maxBitrate:8e8,tier:"H",level:186}],ne=[{maxPictureSize:36864,maxBitrate:2e5,level:10},{maxPictureSize:73728,maxBitrate:8e5,level:11},{maxPictureSize:122880,maxBitrate:18e5,level:20},{maxPictureSize:245760,maxBitrate:36e5,level:21},{maxPictureSize:552960,maxBitrate:72e5,level:30},{maxPictureSize:983040,maxBitrate:12e6,level:31},{maxPictureSize:2228224,maxBitrate:18e6,level:40},{maxPictureSize:2228224,maxBitrate:3e7,level:41},{maxPictureSize:8912896,maxBitrate:6e7,level:50},{maxPictureSize:8912896,maxBitrate:12e7,level:51},{maxPictureSize:8912896,maxBitrate:18e7,level:52},{maxPictureSize:35651584,maxBitrate:18e7,level:60},{maxPictureSize:35651584,maxBitrate:24e7,level:61},{maxPictureSize:35651584,maxBitrate:48e7,level:62}],re=[{maxPictureSize:147456,maxBitrate:15e5,tier:"M",level:0},{maxPictureSize:278784,maxBitrate:3e6,tier:"M",level:1},{maxPictureSize:665856,maxBitrate:6e6,tier:"M",level:4},{maxPictureSize:1065024,maxBitrate:1e7,tier:"M",level:5},{maxPictureSize:2359296,maxBitrate:12e6,tier:"M",level:8},{maxPictureSize:2359296,maxBitrate:3e7,tier:"H",level:8},{maxPictureSize:2359296,maxBitrate:2e7,tier:"M",level:9},{maxPictureSize:2359296,maxBitrate:5e7,tier:"H",level:9},{maxPictureSize:8912896,maxBitrate:3e7,tier:"M",level:12},{maxPictureSize:8912896,maxBitrate:1e8,tier:"H",level:12},{maxPictureSize:8912896,maxBitrate:4e7,tier:"M",level:13},{maxPictureSize:8912896,maxBitrate:16e7,tier:"H",level:13},{maxPictureSize:8912896,maxBitrate:6e7,tier:"M",level:14},{maxPictureSize:8912896,maxBitrate:24e7,tier:"H",level:14},{maxPictureSize:35651584,maxBitrate:6e7,tier:"M",level:15},{maxPictureSize:35651584,maxBitrate:24e7,tier:"H",level:15},{maxPictureSize:35651584,maxBitrate:6e7,tier:"M",level:16},{maxPictureSize:35651584,maxBitrate:24e7,tier:"H",level:16},{maxPictureSize:35651584,maxBitrate:1e8,tier:"M",level:17},{maxPictureSize:35651584,maxBitrate:48e7,tier:"H",level:17},{maxPictureSize:35651584,maxBitrate:16e7,tier:"M",level:18},{maxPictureSize:35651584,maxBitrate:8e8,tier:"H",level:18},{maxPictureSize:35651584,maxBitrate:16e7,tier:"M",level:19},{maxPictureSize:35651584,maxBitrate:8e8,tier:"H",level:19}],ae=(e,t,o,i)=>{if("avc"===e){const e=100,n=Math.ceil(t/16)*Math.ceil(o/16),r=oe.find(e=>n<=e.maxMacroblocks&&i<=e.maxBitrate)??P(oe),a=r?r.level:0;return`avc1.${e.toString(16).padStart(2,"0")}${"00"}${a.toString(16).padStart(2,"0")}`}if("hevc"===e){const e="",n=1,r="6",a=t*o,s=ie.find(e=>a<=e.maxPictureSize&&i<=e.maxBitrate)??P(ie),l="B0";return`hev1.${e}${n}.${r}.${s.tier}${s.level}.${l}`}if("vp8"===e)return"vp8";if("vp9"===e){const e=t*o,n="08";return`vp09.${"00"}.${(ne.find(t=>e<=t.maxPictureSize&&i<=t.maxBitrate)??P(ne)).level.toString().padStart(2,"0")}.${n}`}if("av1"===e){const e=0,n=t*o,r=re.find(e=>n<=e.maxPictureSize&&i<=e.maxBitrate)??P(re),a="08";return`av01.${e}.${r.level.toString().padStart(2,"0")}${r.tier}.${a}`}throw new TypeError(`Unhandled codec '${e}'.`)},se=e=>{const t=e.split(".");return[1,1,Number(t[1]),2,1,Number(t[2]),3,1,Number(t[3]),4,1,t[4]?Number(t[4]):1]},le=e=>{const t=e.split("."),o=Number(t[1]),i=t[2];return[129,(o<<5)+Number(i.slice(0,-1)),(("H"===i.slice(-1)?1:0)<<7)+((8===Number(t[3])?0:1)<<6)+0+((t[4]?Number(t[4]):0)<<4)+((t[5]?Number(t[5][0]):1)<<3)+((t[5]?Number(t[5][1]):1)<<2)+(t[5]?Number(t[5][2]):0),0]},ce=/^pcm-([usf])(\d+)+(be)?$/,de=["avc1","avc3","hev1","hvc1","vp8","vp09","av01"],pe=/^(avc1|avc3)\.[0-9a-fA-F]{6}$/,he=/^(hev1|hvc1)\.(?:[ABC]?\d+)\.[0-9a-fA-F]{1,8}\.[LH]\d+(?:\.[0-9a-fA-F]{1,2}){0,6}$/,ue=/^vp09(?:\.\d{2}){3}(?:(?:\.\d{2}){5})?$/,me=/^av01\.\d\.\d{2}[MH]\.\d{2}(?:\.\d\.\d{3}\.\d{2}\.\d{2}\.\d{2}\.\d)?$/,ge=["mp4a","mp3","opus","vorbis","flac","ulaw","alaw","pcm"];
/*!
   * Copyright (c) 2025-present, Vanilagy and contributors
   *
   * This Source Code Form is subject to the terms of the Mozilla Public
   * License, v. 2.0. If a copy of the MPL was not distributed with this
   * file, You can obtain one at https://mozilla.org/MPL/2.0/.
   */
/*!
   * Copyright (c) 2025-present, Vanilagy and contributors
   *
   * This Source Code Form is subject to the terms of the Mozilla Public
   * License, v. 2.0. If a copy of the MPL was not distributed with this
   * file, You can obtain one at https://mozilla.org/MPL/2.0/.
   */
class fe{constructor(e){this.mutex=new q,this.firstMediaStreamTimestamp=null,this.trackTimestampInfo=new WeakMap,this.output=e}onTrackClose(e){}validateAndNormalizeTimestamp(e,t,o){t+=e.source._timestampOffset;let i=this.trackTimestampInfo.get(e);if(!i){if(!o)throw new Error("First frame must be a key frame.");i={maxTimestamp:t,maxTimestampBeforeLastKeyFrame:t},this.trackTimestampInfo.set(e,i)}if(t<0)throw new Error(`Timestamps must be non-negative (got ${t}s).`);if(o&&(i.maxTimestampBeforeLastKeyFrame=i.maxTimestamp),t<i.maxTimestampBeforeLastKeyFrame)throw new Error(`Timestamps cannot be smaller than the highest timestamp of the previous GOP (a GOP begins with a key frame and ends right before the next key frame). Got ${t}s, but highest timestamp is ${i.maxTimestampBeforeLastKeyFrame}s.`);return i.maxTimestamp=Math.max(i.maxTimestamp,t),t}}
/*!
   * Copyright (c) 2025-present, Vanilagy and contributors
   *
   * This Source Code Form is subject to the terms of the Mozilla Public
   * License, v. 2.0. If a copy of the MPL was not distributed with this
   * file, You can obtain one at https://mozilla.org/MPL/2.0/.
   */var ye,be;!function(e){e[e.IDR=5]="IDR",e[e.SPS=7]="SPS",e[e.PPS=8]="PPS",e[e.SPS_EXT=13]="SPS_EXT"}(ye||(ye={})),function(e){e[e.RASL_N=8]="RASL_N",e[e.RASL_R=9]="RASL_R",e[e.BLA_W_LP=16]="BLA_W_LP",e[e.RSV_IRAP_VCL23=23]="RSV_IRAP_VCL23",e[e.VPS_NUT=32]="VPS_NUT",e[e.SPS_NUT=33]="SPS_NUT",e[e.PPS_NUT=34]="PPS_NUT",e[e.PREFIX_SEI_NUT=39]="PREFIX_SEI_NUT",e[e.SUFFIX_SEI_NUT=40]="SUFFIX_SEI_NUT"}(be||(be={}));const ve=e=>{const t=(o=e).constructor===DataView?o:o instanceof ArrayBuffer?new DataView(o):new DataView(o.buffer,o.byteOffset,o.byteLength);var o;const i=t.getUint8(9),n=t.getUint16(10,!0),r=t.getUint32(12,!0),a=t.getInt16(16,!0),s=t.getUint8(18);let l=null;return s&&(l=e.subarray(19,21+i)),{outputChannelCount:i,preSkip:n,inputSampleRate:r,outputGain:a,channelMappingFamily:s,channelMappingTable:l}};var we;!function(e){e[e.STREAMINFO=0]="STREAMINFO",e[e.VORBIS_COMMENT=4]="VORBIS_COMMENT",e[e.PICTURE=6]="PICTURE"}(we||(we={}));
/*!
   * Copyright (c) 2025-present, Vanilagy and contributors
   *
   * This Source Code Form is subject to the terms of the Mozilla Public
   * License, v. 2.0. If a copy of the MPL was not distributed with this
   * file, You can obtain one at https://mozilla.org/MPL/2.0/.
   */
const xe=[],_e=new Uint8Array(0);
/*!
   * Copyright (c) 2025-present, Vanilagy and contributors
   *
   * This Source Code Form is subject to the terms of the Mozilla Public
   * License, v. 2.0. If a copy of the MPL was not distributed with this
   * file, You can obtain one at https://mozilla.org/MPL/2.0/.
   */class Se{constructor(e,t,o,i,n=-1,r,a){if(this.data=e,this.type=t,this.timestamp=o,this.duration=i,this.sequenceNumber=n,e===_e&&void 0===r)throw new Error("Internal error: byteLength must be explicitly provided when constructing metadata-only packets.");if(void 0===r&&(r=e.byteLength),!(e instanceof Uint8Array))throw new TypeError("data must be a Uint8Array.");if("key"!==t&&"delta"!==t)throw new TypeError('type must be either "key" or "delta".');if(!Number.isFinite(o))throw new TypeError("timestamp must be a number.");if(!Number.isFinite(i)||i<0)throw new TypeError("duration must be a non-negative number.");if(!Number.isFinite(n))throw new TypeError("sequenceNumber must be a number.");if(!Number.isInteger(r)||r<0)throw new TypeError("byteLength must be a non-negative integer.");if(void 0!==a&&("object"!=typeof a||!a))throw new TypeError("sideData, when provided, must be an object.");if(void 0!==a?.alpha&&!(a.alpha instanceof Uint8Array))throw new TypeError("sideData.alpha, when provided, must be a Uint8Array.");if(void 0!==a?.alphaByteLength&&(!Number.isInteger(a.alphaByteLength)||a.alphaByteLength<0))throw new TypeError("sideData.alphaByteLength, when provided, must be a non-negative integer.");this.byteLength=r,this.sideData=a??{},this.sideData.alpha&&void 0===this.sideData.alphaByteLength&&(this.sideData.alphaByteLength=this.sideData.alpha.byteLength)}get isMetadataOnly(){return this.data===_e}get microsecondTimestamp(){return Math.trunc(U*this.timestamp)}get microsecondDuration(){return Math.trunc(U*this.duration)}toEncodedVideoChunk(){if(this.isMetadataOnly)throw new TypeError("Metadata-only packets cannot be converted to a video chunk.");if("undefined"==typeof EncodedVideoChunk)throw new Error("Your browser does not support EncodedVideoChunk.");return new EncodedVideoChunk({data:this.data,type:this.type,timestamp:this.microsecondTimestamp,duration:this.microsecondDuration})}alphaToEncodedVideoChunk(e=this.type){if(!this.sideData.alpha)throw new TypeError("This packet does not contain alpha side data.");if(this.isMetadataOnly)throw new TypeError("Metadata-only packets cannot be converted to a video chunk.");if("undefined"==typeof EncodedVideoChunk)throw new Error("Your browser does not support EncodedVideoChunk.");return new EncodedVideoChunk({data:this.sideData.alpha,type:e,timestamp:this.microsecondTimestamp,duration:this.microsecondDuration})}toEncodedAudioChunk(){if(this.isMetadataOnly)throw new TypeError("Metadata-only packets cannot be converted to an audio chunk.");if("undefined"==typeof EncodedAudioChunk)throw new Error("Your browser does not support EncodedAudioChunk.");return new EncodedAudioChunk({data:this.data,type:this.type,timestamp:this.microsecondTimestamp,duration:this.microsecondDuration})}static fromEncodedChunk(e,t){if(!(e instanceof EncodedVideoChunk||e instanceof EncodedAudioChunk))throw new TypeError("chunk must be an EncodedVideoChunk or EncodedAudioChunk.");const o=new Uint8Array(e.byteLength);return e.copyTo(o),new Se(o,e.type,e.timestamp/1e6,(e.duration??0)/1e6,void 0,void 0,t)}clone(e){if(void 0!==e&&("object"!=typeof e||null===e))throw new TypeError("options, when provided, must be an object.");if(void 0!==e?.timestamp&&!Number.isFinite(e.timestamp))throw new TypeError("options.timestamp, when provided, must be a number.");if(void 0!==e?.duration&&!Number.isFinite(e.duration))throw new TypeError("options.duration, when provided, must be a number.");return new Se(this.data,this.type,e?.timestamp??this.timestamp,e?.duration??this.duration,this.sequenceNumber,this.byteLength)}}
/*!
   * Copyright (c) 2025-present, Vanilagy and contributors
   *
   * This Source Code Form is subject to the terms of the Mozilla Public
   * License, v. 2.0. If a copy of the MPL was not distributed with this
   * file, You can obtain one at https://mozilla.org/MPL/2.0/.
   */Symbol.dispose??=Symbol("Symbol.dispose");class ke{get displayWidth(){return this.rotation%180==0?this.codedWidth:this.codedHeight}get displayHeight(){return this.rotation%180==0?this.codedHeight:this.codedWidth}get microsecondTimestamp(){return Math.trunc(U*this.timestamp)}get microsecondDuration(){return Math.trunc(U*this.duration)}get hasAlpha(){return this.format&&this.format.includes("A")}constructor(e,t){if(this._closed=!1,e instanceof ArrayBuffer||ArrayBuffer.isView(e)){if(!t||"object"!=typeof t)throw new TypeError("init must be an object.");if(!("format"in t)||"string"!=typeof t.format)throw new TypeError("init.format must be a string.");if(!Number.isInteger(t.codedWidth)||t.codedWidth<=0)throw new TypeError("init.codedWidth must be a positive integer.");if(!Number.isInteger(t.codedHeight)||t.codedHeight<=0)throw new TypeError("init.codedHeight must be a positive integer.");if(void 0!==t.rotation&&![0,90,180,270].includes(t.rotation))throw new TypeError("init.rotation, when provided, must be 0, 90, 180, or 270.");if(!Number.isFinite(t.timestamp))throw new TypeError("init.timestamp must be a number.");if(void 0!==t.duration&&(!Number.isFinite(t.duration)||t.duration<0))throw new TypeError("init.duration, when provided, must be a non-negative number.");this._data=I(e).slice(),this.format=t.format,this.codedWidth=t.codedWidth,this.codedHeight=t.codedHeight,this.rotation=t.rotation??0,this.timestamp=t.timestamp,this.duration=t.duration??0,this.colorSpace=new VideoColorSpace(t.colorSpace)}else if("undefined"!=typeof VideoFrame&&e instanceof VideoFrame){if(void 0!==t?.rotation&&![0,90,180,270].includes(t.rotation))throw new TypeError("init.rotation, when provided, must be 0, 90, 180, or 270.");if(void 0!==t?.timestamp&&!Number.isFinite(t?.timestamp))throw new TypeError("init.timestamp, when provided, must be a number.");if(void 0!==t?.duration&&(!Number.isFinite(t.duration)||t.duration<0))throw new TypeError("init.duration, when provided, must be a non-negative number.");this._data=e,this.format=e.format,this.codedWidth=e.displayWidth,this.codedHeight=e.displayHeight,this.rotation=t?.rotation??0,this.timestamp=t?.timestamp??e.timestamp/1e6,this.duration=t?.duration??(e.duration??0)/1e6,this.colorSpace=e.colorSpace}else{if(!("undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement||"undefined"!=typeof SVGImageElement&&e instanceof SVGImageElement||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap||"undefined"!=typeof HTMLVideoElement&&e instanceof HTMLVideoElement||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof OffscreenCanvas&&e instanceof OffscreenCanvas))throw new TypeError("Invalid data type: Must be a BufferSource or CanvasImageSource.");{if(!t||"object"!=typeof t)throw new TypeError("init must be an object.");if(void 0!==t.rotation&&![0,90,180,270].includes(t.rotation))throw new TypeError("init.rotation, when provided, must be 0, 90, 180, or 270.");if(!Number.isFinite(t.timestamp))throw new TypeError("init.timestamp must be a number.");if(void 0!==t.duration&&(!Number.isFinite(t.duration)||t.duration<0))throw new TypeError("init.duration, when provided, must be a non-negative number.");if("undefined"!=typeof VideoFrame)return new ke(new VideoFrame(e,{timestamp:Math.trunc(t.timestamp*U),duration:Math.trunc((t.duration??0)*U)||void 0}),t);let o=0,i=0;if("naturalWidth"in e?(o=e.naturalWidth,i=e.naturalHeight):"videoWidth"in e?(o=e.videoWidth,i=e.videoHeight):"width"in e&&(o=Number(e.width),i=Number(e.height)),!o||!i)throw new TypeError("Could not determine dimensions.");const n=new OffscreenCanvas(o,i),r=n.getContext("2d",{alpha:j(),willReadFrequently:!0});M(r),r.drawImage(e,0,0),this._data=n,this.format="RGBX",this.codedWidth=o,this.codedHeight=i,this.rotation=t.rotation??0,this.timestamp=t.timestamp,this.duration=t.duration??0,this.colorSpace=new VideoColorSpace({matrix:"rgb",primaries:"bt709",transfer:"iec61966-2-1",fullRange:!0})}}}clone(){if(this._closed)throw new Error("VideoSample is closed.");return M(null!==this._data),Ce(this._data)?new ke(this._data.clone(),{timestamp:this.timestamp,duration:this.duration,rotation:this.rotation}):this._data instanceof Uint8Array?new ke(this._data.slice(),{format:this.format,codedWidth:this.codedWidth,codedHeight:this.codedHeight,timestamp:this.timestamp,duration:this.duration,colorSpace:this.colorSpace,rotation:this.rotation}):new ke(this._data,{format:this.format,codedWidth:this.codedWidth,codedHeight:this.codedHeight,timestamp:this.timestamp,duration:this.duration,colorSpace:this.colorSpace,rotation:this.rotation})}close(){this._closed||(Ce(this._data)?this._data.close():this._data=null,this._closed=!0)}allocationSize(){if(this._closed)throw new Error("VideoSample is closed.");return M(null!==this._data),Ce(this._data)?this._data.allocationSize():this._data instanceof Uint8Array?this._data.byteLength:this.codedWidth*this.codedHeight*4}async copyTo(e){if(!R(e))throw new TypeError("destination must be an ArrayBuffer or an ArrayBuffer view.");if(this._closed)throw new Error("VideoSample is closed.");if(M(null!==this._data),Ce(this._data))await this._data.copyTo(e);else if(this._data instanceof Uint8Array){I(e).set(this._data)}else{const t=this._data.getContext("2d");M(t);const o=t.getImageData(0,0,this.codedWidth,this.codedHeight);I(e).set(o.data)}}toVideoFrame(){if(this._closed)throw new Error("VideoSample is closed.");return M(null!==this._data),Ce(this._data)?new VideoFrame(this._data,{timestamp:this.microsecondTimestamp,duration:this.microsecondDuration||void 0}):this._data instanceof Uint8Array?new VideoFrame(this._data,{format:this.format,codedWidth:this.codedWidth,codedHeight:this.codedHeight,timestamp:this.microsecondTimestamp,duration:this.microsecondDuration||void 0,colorSpace:this.colorSpace}):new VideoFrame(this._data,{timestamp:this.microsecondTimestamp,duration:this.microsecondDuration||void 0})}draw(e,t,o,i,n,r,a,s,l){let c=0,d=0,p=this.displayWidth,h=this.displayHeight,u=0,m=0,g=this.displayWidth,f=this.displayHeight;if(void 0!==r?(c=t,d=o,p=i,h=n,u=r,m=a,void 0!==s?(g=s,f=l):(g=p,f=h)):(u=t,m=o,void 0!==i&&(g=i,f=n)),!("undefined"!=typeof CanvasRenderingContext2D&&e instanceof CanvasRenderingContext2D||"undefined"!=typeof OffscreenCanvasRenderingContext2D&&e instanceof OffscreenCanvasRenderingContext2D))throw new TypeError("context must be a CanvasRenderingContext2D or OffscreenCanvasRenderingContext2D.");if(!Number.isFinite(c))throw new TypeError("sx must be a number.");if(!Number.isFinite(d))throw new TypeError("sy must be a number.");if(!Number.isFinite(p)||p<0)throw new TypeError("sWidth must be a non-negative number.");if(!Number.isFinite(h)||h<0)throw new TypeError("sHeight must be a non-negative number.");if(!Number.isFinite(u))throw new TypeError("dx must be a number.");if(!Number.isFinite(m))throw new TypeError("dy must be a number.");if(!Number.isFinite(g)||g<0)throw new TypeError("dWidth must be a non-negative number.");if(!Number.isFinite(f)||f<0)throw new TypeError("dHeight must be a non-negative number.");if(this._closed)throw new Error("VideoSample is closed.");({sx:c,sy:d,sWidth:p,sHeight:h}=this._rotateSourceRegion(c,d,p,h,this.rotation));const y=this.toCanvasImageSource();e.save();const b=u+g/2,v=m+f/2;e.translate(b,v),e.rotate(this.rotation*Math.PI/180);const w=this.rotation%180==0?1:g/f;e.scale(1/w,w),e.drawImage(y,c,d,p,h,-g/2,-f/2,g,f),e.restore()}drawWithFit(e,t){if(!("undefined"!=typeof CanvasRenderingContext2D&&e instanceof CanvasRenderingContext2D||"undefined"!=typeof OffscreenCanvasRenderingContext2D&&e instanceof OffscreenCanvasRenderingContext2D))throw new TypeError("context must be a CanvasRenderingContext2D or OffscreenCanvasRenderingContext2D.");if(!t||"object"!=typeof t)throw new TypeError("options must be an object.");if(!["fill","contain","cover"].includes(t.fit))throw new TypeError("options.fit must be 'fill', 'contain', or 'cover'.");if(void 0!==t.rotation&&![0,90,180,270].includes(t.rotation))throw new TypeError("options.rotation, when provided, must be 0, 90, 180, or 270.");void 0!==t.crop&&Te(t.crop,"options.");const o=e.canvas.width,i=e.canvas.height,n=t.rotation??this.rotation,[r,a]=n%180==0?[this.codedWidth,this.codedHeight]:[this.codedHeight,this.codedWidth];let s,l,c,d;t.crop&&Ee(t.crop,r,a);const{sx:p,sy:h,sWidth:u,sHeight:m}=this._rotateSourceRegion(t.crop?.left??0,t.crop?.top??0,t.crop?.width??r,t.crop?.height??a,n);if("fill"===t.fit)s=0,l=0,c=o,d=i;else{const[e,n]=t.crop?[t.crop.width,t.crop.height]:[r,a],p="contain"===t.fit?Math.min(o/e,i/n):Math.max(o/e,i/n);c=e*p,d=n*p,s=(o-c)/2,l=(i-d)/2}const g=n%180==0?1:c/d;e.translate(o/2,i/2),e.rotate(n*Math.PI/180),e.scale(1/g,g),e.translate(-o/2,-i/2),e.drawImage(this.toCanvasImageSource(),p,h,u,m,s,l,c,d)}_rotateSourceRegion(e,t,o,i,n){return 90===n?[e,t,o,i]=[t,this.codedHeight-e-o,i,o]:180===n?[e,t]=[this.codedWidth-e-o,this.codedHeight-t-i]:270===n&&([e,t,o,i]=[this.codedWidth-t-i,e,i,o]),{sx:e,sy:t,sWidth:o,sHeight:i}}toCanvasImageSource(){if(this._closed)throw new Error("VideoSample is closed.");if(M(null!==this._data),this._data instanceof Uint8Array){const e=this.toVideoFrame();return queueMicrotask(()=>e.close()),e}return this._data}setRotation(e){if(![0,90,180,270].includes(e))throw new TypeError("newRotation must be 0, 90, 180, or 270.");this.rotation=e}setTimestamp(e){if(!Number.isFinite(e))throw new TypeError("newTimestamp must be a number.");this.timestamp=e}setDuration(e){if(!Number.isFinite(e)||e<0)throw new TypeError("newDuration must be a non-negative number.");this.duration=e}[Symbol.dispose](){this.close()}}const Ce=e=>"undefined"!=typeof VideoFrame&&e instanceof VideoFrame,Ee=(e,t,o)=>{e.left=Math.min(e.left,t),e.top=Math.min(e.top,o),e.width=Math.min(e.width,t-e.left),e.height=Math.min(e.height,o-e.top),M(e.width>=0),M(e.height>=0)},Te=(e,t)=>{if(!e||"object"!=typeof e)throw new TypeError(t+"crop, when provided, must be an object.");if(!Number.isInteger(e.left)||e.left<0)throw new TypeError(t+"crop.left must be a non-negative integer.");if(!Number.isInteger(e.top)||e.top<0)throw new TypeError(t+"crop.top must be a non-negative integer.");if(!Number.isInteger(e.width)||e.width<0)throw new TypeError(t+"crop.width must be a non-negative integer.");if(!Number.isInteger(e.height)||e.height<0)throw new TypeError(t+"crop.height must be a non-negative integer.")};
/*!
   * Copyright (c) 2025-present, Vanilagy and contributors
   *
   * This Source Code Form is subject to the terms of the Mozilla Public
   * License, v. 2.0. If a copy of the MPL was not distributed with this
   * file, You can obtain one at https://mozilla.org/MPL/2.0/.
   */
class Me{constructor(e){this.value=e}}class Pe{constructor(e){this.value=e}}class Fe{constructor(e){this.value=e}}class Ie{constructor(e){this.value=e}}var $e;!function(e){e[e.EBML=440786851]="EBML",e[e.EBMLVersion=17030]="EBMLVersion",e[e.EBMLReadVersion=17143]="EBMLReadVersion",e[e.EBMLMaxIDLength=17138]="EBMLMaxIDLength",e[e.EBMLMaxSizeLength=17139]="EBMLMaxSizeLength",e[e.DocType=17026]="DocType",e[e.DocTypeVersion=17031]="DocTypeVersion",e[e.DocTypeReadVersion=17029]="DocTypeReadVersion",e[e.Void=236]="Void",e[e.Segment=408125543]="Segment",e[e.SeekHead=290298740]="SeekHead",e[e.Seek=19899]="Seek",e[e.SeekID=21419]="SeekID",e[e.SeekPosition=21420]="SeekPosition",e[e.Duration=17545]="Duration",e[e.Info=357149030]="Info",e[e.TimestampScale=2807729]="TimestampScale",e[e.MuxingApp=19840]="MuxingApp",e[e.WritingApp=22337]="WritingApp",e[e.Tracks=374648427]="Tracks",e[e.TrackEntry=174]="TrackEntry",e[e.TrackNumber=215]="TrackNumber",e[e.TrackUID=29637]="TrackUID",e[e.TrackType=131]="TrackType",e[e.FlagEnabled=185]="FlagEnabled",e[e.FlagDefault=136]="FlagDefault",e[e.FlagForced=21930]="FlagForced",e[e.FlagLacing=156]="FlagLacing",e[e.Name=21358]="Name",e[e.Language=2274716]="Language",e[e.LanguageBCP47=2274717]="LanguageBCP47",e[e.CodecID=134]="CodecID",e[e.CodecPrivate=25506]="CodecPrivate",e[e.CodecDelay=22186]="CodecDelay",e[e.SeekPreRoll=22203]="SeekPreRoll",e[e.DefaultDuration=2352003]="DefaultDuration",e[e.Video=224]="Video",e[e.PixelWidth=176]="PixelWidth",e[e.PixelHeight=186]="PixelHeight",e[e.AlphaMode=21440]="AlphaMode",e[e.Audio=225]="Audio",e[e.SamplingFrequency=181]="SamplingFrequency",e[e.Channels=159]="Channels",e[e.BitDepth=25188]="BitDepth",e[e.SimpleBlock=163]="SimpleBlock",e[e.BlockGroup=160]="BlockGroup",e[e.Block=161]="Block",e[e.BlockAdditions=30113]="BlockAdditions",e[e.BlockMore=166]="BlockMore",e[e.BlockAdditional=165]="BlockAdditional",e[e.BlockAddID=238]="BlockAddID",e[e.BlockDuration=155]="BlockDuration",e[e.ReferenceBlock=251]="ReferenceBlock",e[e.Cluster=524531317]="Cluster",e[e.Timestamp=231]="Timestamp",e[e.Cues=475249515]="Cues",e[e.CuePoint=187]="CuePoint",e[e.CueTime=179]="CueTime",e[e.CueTrackPositions=183]="CueTrackPositions",e[e.CueTrack=247]="CueTrack",e[e.CueClusterPosition=241]="CueClusterPosition",e[e.Colour=21936]="Colour",e[e.MatrixCoefficients=21937]="MatrixCoefficients",e[e.TransferCharacteristics=21946]="TransferCharacteristics",e[e.Primaries=21947]="Primaries",e[e.Range=21945]="Range",e[e.Projection=30320]="Projection",e[e.ProjectionType=30321]="ProjectionType",e[e.ProjectionPoseRoll=30325]="ProjectionPoseRoll",e[e.Attachments=423732329]="Attachments",e[e.AttachedFile=24999]="AttachedFile",e[e.FileDescription=18046]="FileDescription",e[e.FileName=18030]="FileName",e[e.FileMediaType=18016]="FileMediaType",e[e.FileData=18012]="FileData",e[e.FileUID=18094]="FileUID",e[e.Chapters=272869232]="Chapters",e[e.Tags=307544935]="Tags",e[e.Tag=29555]="Tag",e[e.Targets=25536]="Targets",e[e.TargetTypeValue=26826]="TargetTypeValue",e[e.TargetType=25546]="TargetType",e[e.TagTrackUID=25541]="TagTrackUID",e[e.TagEditionUID=25545]="TagEditionUID",e[e.TagChapterUID=25540]="TagChapterUID",e[e.TagAttachmentUID=25542]="TagAttachmentUID",e[e.SimpleTag=26568]="SimpleTag",e[e.TagName=17827]="TagName",e[e.TagLanguage=17530]="TagLanguage",e[e.TagString=17543]="TagString",e[e.TagBinary=17541]="TagBinary",e[e.ContentEncodings=28032]="ContentEncodings",e[e.ContentEncoding=25152]="ContentEncoding",e[e.ContentEncodingOrder=20529]="ContentEncodingOrder",e[e.ContentEncodingScope=20530]="ContentEncodingScope",e[e.ContentCompression=20532]="ContentCompression",e[e.ContentCompAlgo=16980]="ContentCompAlgo",e[e.ContentCompSettings=16981]="ContentCompSettings",e[e.ContentEncryption=20533]="ContentEncryption"}($e||($e={})),$e.EBML,$e.Segment,$e.SeekHead,$e.Info,$e.Cluster,$e.Tracks,$e.Cues,$e.Attachments,$e.Chapters,$e.Tags;const We=e=>e<256?1:e<65536?2:e<1<<24?3:e<2**32?4:e<2**40?5:6,Ae=e=>e<256n?1:e<65536n?2:e<1n<<24n?3:e<1n<<32n?4:e<1n<<40n?5:e<1n<<48n?6:e<1n<<56n?7:8,Le=e=>e>=-64&&e<64?1:e>=-8192&&e<8192?2:e>=-1048576&&e<1<<20?3:e>=-134217728&&e<1<<27?4:e>=-17179869184&&e<2**34?5:6;class ze{constructor(e){this.writer=e,this.helper=new Uint8Array(8),this.helperView=new DataView(this.helper.buffer),this.offsets=new WeakMap,this.dataOffsets=new WeakMap}writeByte(e){this.helperView.setUint8(0,e),this.writer.write(this.helper.subarray(0,1))}writeFloat32(e){this.helperView.setFloat32(0,e,!1),this.writer.write(this.helper.subarray(0,4))}writeFloat64(e){this.helperView.setFloat64(0,e,!1),this.writer.write(this.helper)}writeUnsignedInt(e,t=We(e)){let o=0;switch(t){case 6:this.helperView.setUint8(o++,e/2**40|0);case 5:this.helperView.setUint8(o++,e/2**32|0);case 4:this.helperView.setUint8(o++,e>>24);case 3:this.helperView.setUint8(o++,e>>16);case 2:this.helperView.setUint8(o++,e>>8);case 1:this.helperView.setUint8(o++,e);break;default:throw new Error("Bad unsigned int size "+t)}this.writer.write(this.helper.subarray(0,o))}writeUnsignedBigInt(e,t=Ae(e)){let o=0;for(let i=t-1;i>=0;i--)this.helperView.setUint8(o++,Number(e>>BigInt(8*i)&0xffn));this.writer.write(this.helper.subarray(0,o))}writeSignedInt(e,t=Le(e)){e<0&&(e+=2**(8*t)),this.writeUnsignedInt(e,t)}writeVarInt(e,t=(e=>{if(e<127)return 1;if(e<16383)return 2;if(e<2097151)return 3;if(e<268435455)return 4;if(e<2**35-1)return 5;if(e<2**42-1)return 6;throw new Error("EBML varint size not supported "+e)})(e)){let o=0;switch(t){case 1:this.helperView.setUint8(o++,128|e);break;case 2:this.helperView.setUint8(o++,64|e>>8),this.helperView.setUint8(o++,e);break;case 3:this.helperView.setUint8(o++,32|e>>16),this.helperView.setUint8(o++,e>>8),this.helperView.setUint8(o++,e);break;case 4:this.helperView.setUint8(o++,16|e>>24),this.helperView.setUint8(o++,e>>16),this.helperView.setUint8(o++,e>>8),this.helperView.setUint8(o++,e);break;case 5:this.helperView.setUint8(o++,8|e/2**32&7),this.helperView.setUint8(o++,e>>24),this.helperView.setUint8(o++,e>>16),this.helperView.setUint8(o++,e>>8),this.helperView.setUint8(o++,e);break;case 6:this.helperView.setUint8(o++,4|e/2**40&3),this.helperView.setUint8(o++,e/2**32|0),this.helperView.setUint8(o++,e>>24),this.helperView.setUint8(o++,e>>16),this.helperView.setUint8(o++,e>>8),this.helperView.setUint8(o++,e);break;default:throw new Error("Bad EBML varint size "+t)}this.writer.write(this.helper.subarray(0,o))}writeAsciiString(e){this.writer.write(new Uint8Array(e.split("").map(e=>e.charCodeAt(0))))}writeEBML(e){if(null!==e)if(e instanceof Uint8Array)this.writer.write(e);else if(Array.isArray(e))for(const t of e)this.writeEBML(t);else if(this.offsets.set(e,this.writer.getPos()),this.writeUnsignedInt(e.id),Array.isArray(e.data)){const t=this.writer.getPos(),o=-1===e.size?1:e.size??4;-1===e.size?this.writeByte(255):this.writer.seek(this.writer.getPos()+o);const i=this.writer.getPos();if(this.dataOffsets.set(e,i),this.writeEBML(e.data),-1!==e.size){const e=this.writer.getPos()-i,n=this.writer.getPos();this.writer.seek(t),this.writeVarInt(e,o),this.writer.seek(n)}}else if("number"==typeof e.data){const t=e.size??We(e.data);this.writeVarInt(t),this.writeUnsignedInt(e.data,t)}else if("bigint"==typeof e.data){const t=e.size??Ae(e.data);this.writeVarInt(t),this.writeUnsignedBigInt(e.data,t)}else if("string"==typeof e.data)this.writeVarInt(e.data.length),this.writeAsciiString(e.data);else if(e.data instanceof Uint8Array)this.writeVarInt(e.data.byteLength,e.size),this.writer.write(e.data);else if(e.data instanceof Me)this.writeVarInt(4),this.writeFloat32(e.data.value);else if(e.data instanceof Pe)this.writeVarInt(8),this.writeFloat64(e.data.value);else if(e.data instanceof Fe){const t=e.size??Le(e.data.value);this.writeVarInt(t),this.writeSignedInt(e.data.value,t)}else if(e.data instanceof Ie){const t=$.encode(e.data.value);this.writeVarInt(t.length),this.writer.write(t)}else D(e.data)}}const Be={avc:"V_MPEG4/ISO/AVC",hevc:"V_MPEGH/ISO/HEVC",vp8:"V_VP8",vp9:"V_VP9",av1:"V_AV1",aac:"A_AAC",mp3:"A_MPEG/L3",opus:"A_OPUS",vorbis:"A_VORBIS",flac:"A_FLAC","pcm-u8":"A_PCM/INT/LIT","pcm-s16":"A_PCM/INT/LIT","pcm-s16be":"A_PCM/INT/BIG","pcm-s24":"A_PCM/INT/LIT","pcm-s24be":"A_PCM/INT/BIG","pcm-s32":"A_PCM/INT/LIT","pcm-s32be":"A_PCM/INT/BIG","pcm-f32":"A_PCM/FLOAT/IEEE","pcm-f64":"A_PCM/FLOAT/IEEE",webvtt:"S_TEXT/WEBVTT"},Re=/<(?:(\d{2}):)?(\d{2}):(\d{2}).(\d{3})>/g,qe=/(?:(\d{2}):)?(\d{2}):(\d{2}).(\d{3})/;
/*!
   * Copyright (c) 2025-present, Vanilagy and contributors
   *
   * This Source Code Form is subject to the terms of the Mozilla Public
   * License, v. 2.0. If a copy of the MPL was not distributed with this
   * file, You can obtain one at https://mozilla.org/MPL/2.0/.
   */
/*!
   * Copyright (c) 2025-present, Vanilagy and contributors
   *
   * This Source Code Form is subject to the terms of the Mozilla Public
   * License, v. 2.0. If a copy of the MPL was not distributed with this
   * file, You can obtain one at https://mozilla.org/MPL/2.0/.
   */
class De{constructor(){this.ensureMonotonicity=!1,this.trackedWrites=null,this.trackedStart=-1,this.trackedEnd=-1}start(){}maybeTrackWrites(e){if(!this.trackedWrites)return;let t=this.getPos();if(t<this.trackedStart){if(t+e.byteLength<=this.trackedStart)return;e=e.subarray(this.trackedStart-t),t=0}const o=t+e.byteLength-this.trackedStart;let i=this.trackedWrites.byteLength;for(;i<o;)i*=2;if(i!==this.trackedWrites.byteLength){const e=new Uint8Array(i);e.set(this.trackedWrites,0),this.trackedWrites=e}this.trackedWrites.set(e,t-this.trackedStart),this.trackedEnd=Math.max(this.trackedEnd,t+e.byteLength)}startTrackingWrites(){this.trackedWrites=new Uint8Array(1024),this.trackedStart=this.getPos(),this.trackedEnd=this.trackedStart}stopTrackingWrites(){if(!this.trackedWrites)throw new Error("Internal error: Can't get tracked writes since nothing was tracked.");const e={data:this.trackedWrites.subarray(0,this.trackedEnd-this.trackedStart),start:this.trackedStart,end:this.trackedEnd};return this.trackedWrites=null,e}}const Ne=65536,Ve=2**32;class Ue extends De{constructor(e){if(super(),this.pos=0,this.maxPos=0,this.target=e,this.supportsResize="resize"in new ArrayBuffer(0),this.supportsResize)try{this.buffer=new ArrayBuffer(Ne,{maxByteLength:Ve})}catch{this.buffer=new ArrayBuffer(Ne),this.supportsResize=!1}else this.buffer=new ArrayBuffer(Ne);this.bytes=new Uint8Array(this.buffer)}ensureSize(e){let t=this.buffer.byteLength;for(;t<e;)t*=2;if(t!==this.buffer.byteLength){if(t>Ve)throw new Error("ArrayBuffer exceeded maximum size of 4294967296 bytes. Please consider using another target.");if(this.supportsResize)this.buffer.resize(t);else{const e=new ArrayBuffer(t),o=new Uint8Array(e);o.set(this.bytes,0),this.buffer=e,this.bytes=o}}}write(e){this.maybeTrackWrites(e),this.ensureSize(this.pos+e.byteLength),this.bytes.set(e,this.pos),this.target.onwrite?.(this.pos,this.pos+e.byteLength),this.pos+=e.byteLength,this.maxPos=Math.max(this.maxPos,this.pos)}seek(e){this.pos=e}getPos(){return this.pos}async flush(){}async finalize(){this.ensureSize(this.pos),this.target.buffer=this.buffer.slice(0,Math.max(this.maxPos,this.pos))}async close(){}getSlice(e,t){return this.bytes.slice(e,t)}}
/*!
   * Copyright (c) 2025-present, Vanilagy and contributors
   *
   * This Source Code Form is subject to the terms of the Mozilla Public
   * License, v. 2.0. If a copy of the MPL was not distributed with this
   * file, You can obtain one at https://mozilla.org/MPL/2.0/.
   */class He{constructor(){this._output=null,this.onwrite=null}}class Oe extends He{constructor(){super(...arguments),this.buffer=null}_createWriter(){return new Ue(this)}}
/*!
   * Copyright (c) 2025-present, Vanilagy and contributors
   *
   * This Source Code Form is subject to the terms of the Mozilla Public
   * License, v. 2.0. If a copy of the MPL was not distributed with this
   * file, You can obtain one at https://mozilla.org/MPL/2.0/.
   */const je="Mediabunny",Ze={video:1,audio:2,subtitle:17};class Ge extends fe{constructor(e,t){super(e),this.trackDatas=[],this.allTracksKnown=(()=>{let e,t;return{promise:new Promise((o,i)=>{e=o,t=i}),resolve:e,reject:t}})(),this.segment=null,this.segmentInfo=null,this.seekHead=null,this.tracksElement=null,this.tagsElement=null,this.attachmentsElement=null,this.segmentDuration=null,this.cues=null,this.currentCluster=null,this.currentClusterStartMsTimestamp=null,this.currentClusterMaxMsTimestamp=null,this.trackDatasInCurrentCluster=new Map,this.duration=0,this.writer=e._writer,this.format=t,this.ebmlWriter=new ze(this.writer),this.format._options.appendOnly&&(this.writer.ensureMonotonicity=!0)}async start(){const e=await this.mutex.acquire();this.writeEBMLHeader(),this.createSegmentInfo(),this.createCues(),await this.writer.flush(),e()}writeEBMLHeader(){this.format._options.onEbmlHeader&&this.writer.startTrackingWrites();const e={id:$e.EBML,data:[{id:$e.EBMLVersion,data:1},{id:$e.EBMLReadVersion,data:1},{id:$e.EBMLMaxIDLength,data:4},{id:$e.EBMLMaxSizeLength,data:8},{id:$e.DocType,data:this.format instanceof Xe?"webm":"matroska"},{id:$e.DocTypeVersion,data:2},{id:$e.DocTypeReadVersion,data:2}]};if(this.ebmlWriter.writeEBML(e),this.format._options.onEbmlHeader){const{data:e,start:t}=this.writer.stopTrackingWrites();this.format._options.onEbmlHeader(e,t)}}maybeCreateSeekHead(e){if(this.format._options.appendOnly)return;const t=new Uint8Array([28,83,187,107]),o=new Uint8Array([21,73,169,102]),i=new Uint8Array([22,84,174,107]),n=new Uint8Array([25,65,164,105]),r=new Uint8Array([18,84,195,103]),a={id:$e.SeekHead,data:[{id:$e.Seek,data:[{id:$e.SeekID,data:t},{id:$e.SeekPosition,size:5,data:e?this.ebmlWriter.offsets.get(this.cues)-this.segmentDataOffset:0}]},{id:$e.Seek,data:[{id:$e.SeekID,data:o},{id:$e.SeekPosition,size:5,data:e?this.ebmlWriter.offsets.get(this.segmentInfo)-this.segmentDataOffset:0}]},{id:$e.Seek,data:[{id:$e.SeekID,data:i},{id:$e.SeekPosition,size:5,data:e?this.ebmlWriter.offsets.get(this.tracksElement)-this.segmentDataOffset:0}]},this.attachmentsElement?{id:$e.Seek,data:[{id:$e.SeekID,data:n},{id:$e.SeekPosition,size:5,data:e?this.ebmlWriter.offsets.get(this.attachmentsElement)-this.segmentDataOffset:0}]}:null,this.tagsElement?{id:$e.Seek,data:[{id:$e.SeekID,data:r},{id:$e.SeekPosition,size:5,data:e?this.ebmlWriter.offsets.get(this.tagsElement)-this.segmentDataOffset:0}]}:null]};this.seekHead=a}createSegmentInfo(){const e={id:$e.Duration,data:new Pe(0)};this.segmentDuration=e;const t={id:$e.Info,data:[{id:$e.TimestampScale,data:1e6},{id:$e.MuxingApp,data:je},{id:$e.WritingApp,data:je},this.format._options.appendOnly?null:e]};this.segmentInfo=t}createTracks(){const e={id:$e.Tracks,data:[]};this.tracksElement=e;for(const t of this.trackDatas){const o=Be[t.track.source._codec];M(o);let i=0;if("audio"===t.type&&"opus"===t.track.source._codec){i=8e7;const e=t.info.decoderConfig.description;if(e){const t=I(e),o=ve(t);i=Math.round(o.preSkip/48e3*1e9)}}e.data.push({id:$e.TrackEntry,data:[{id:$e.TrackNumber,data:t.track.id},{id:$e.TrackUID,data:t.track.id},{id:$e.TrackType,data:Ze[t.type]},{id:$e.FlagLacing,data:0},{id:$e.Language,data:t.track.metadata.languageCode??"und"},{id:$e.CodecID,data:o},{id:$e.CodecDelay,data:0},{id:$e.SeekPreRoll,data:i},void 0!==t.track.metadata.name?{id:$e.Name,data:new Ie(t.track.metadata.name)}:null,"video"===t.type?this.videoSpecificTrackInfo(t):null,"audio"===t.type?this.audioSpecificTrackInfo(t):null,"subtitle"===t.type?this.subtitleSpecificTrackInfo(t):null]})}}videoSpecificTrackInfo(e){const{frameRate:t,rotation:o}=e.track.metadata,i=[e.info.decoderConfig.description?{id:$e.CodecPrivate,data:I(e.info.decoderConfig.description)}:null,t?{id:$e.DefaultDuration,data:1e9/t}:null],n=o?(e=>{const t=(e%360+360)%360;if(0===t||90===t||180===t||270===t)return t;throw new Error(`Invalid rotation ${e}.`)})(-o):0,r=e.info.decoderConfig.colorSpace,a={id:$e.Video,data:[{id:$e.PixelWidth,data:e.info.width},{id:$e.PixelHeight,data:e.info.height},e.info.alphaMode?{id:$e.AlphaMode,data:1}:null,B(r)?{id:$e.Colour,data:[{id:$e.MatrixCoefficients,data:z[r.matrix]},{id:$e.TransferCharacteristics,data:L[r.transfer]},{id:$e.Primaries,data:A[r.primaries]},{id:$e.Range,data:r.fullRange?2:1}]}:null,n?{id:$e.Projection,data:[{id:$e.ProjectionType,data:0},{id:$e.ProjectionPoseRoll,data:new Me((n+180)%360-180)}]}:null]};return i.push(a),i}audioSpecificTrackInfo(e){const t=J.includes(e.track.source._codec)?(e=>{if(M(J.includes(e)),"ulaw"===e)return{dataType:"ulaw",sampleSize:1,littleEndian:!0,silentValue:255};if("alaw"===e)return{dataType:"alaw",sampleSize:1,littleEndian:!0,silentValue:213};const t=ce.exec(e);let o;return M(t),o="u"===t[1]?"unsigned":"s"===t[1]?"signed":"float",{dataType:o,sampleSize:Number(t[2])/8,littleEndian:"be"!==t[3],silentValue:"pcm-u8"===e?128:0}})(e.track.source._codec):null;return[e.info.decoderConfig.description?{id:$e.CodecPrivate,data:I(e.info.decoderConfig.description)}:null,{id:$e.Audio,data:[{id:$e.SamplingFrequency,data:new Me(e.info.sampleRate)},{id:$e.Channels,data:e.info.numberOfChannels},t?{id:$e.BitDepth,data:8*t.sampleSize}:null]}]}subtitleSpecificTrackInfo(e){return[{id:$e.CodecPrivate,data:$.encode(e.info.config.description)}]}maybeCreateTags(){const e=[],t=(t,o)=>{e.push({id:$e.SimpleTag,data:[{id:$e.TagName,data:new Ie(t)},"string"==typeof o?{id:$e.TagString,data:new Ie(o)}:{id:$e.TagBinary,data:o}]})},o=this.output._metadataTags,i=new Set;for(const{key:e,value:n}of function*(e){for(const t in e){const o=e[t];void 0!==o&&(yield{key:t,value:o})}}(o))switch(e){case"title":t("TITLE",n),i.add("TITLE");break;case"description":t("DESCRIPTION",n),i.add("DESCRIPTION");break;case"artist":t("ARTIST",n),i.add("ARTIST");break;case"album":t("ALBUM",n),i.add("ALBUM");break;case"albumArtist":t("ALBUM_ARTIST",n),i.add("ALBUM_ARTIST");break;case"genre":t("GENRE",n),i.add("GENRE");break;case"comment":t("COMMENT",n),i.add("COMMENT");break;case"lyrics":t("LYRICS",n),i.add("LYRICS");break;case"date":t("DATE",n.toISOString().slice(0,10)),i.add("DATE");break;case"trackNumber":t("PART_NUMBER",void 0!==o.tracksTotal?`${n}/${o.tracksTotal}`:n.toString()),i.add("PART_NUMBER");break;case"discNumber":t("DISC",void 0!==o.discsTotal?`${n}/${o.discsTotal}`:n.toString()),i.add("DISC");break;case"tracksTotal":case"discsTotal":case"images":case"raw":break;default:D(e)}if(o.raw)for(const e in o.raw){const n=o.raw[e];null==n||i.has(e)||("string"==typeof n||n instanceof Uint8Array)&&t(e,n)}0!==e.length&&(this.tagsElement={id:$e.Tags,data:[{id:$e.Tag,data:[{id:$e.Targets,data:[{id:$e.TargetTypeValue,data:50},{id:$e.TargetType,data:"MOVIE"}]},...e]}]})}maybeCreateAttachments(){const e=this.output._metadataTags,t=[],o=new Set,i=e.images??[];for(const e of i){let i,n=e.name;if(void 0===n){n=("coverFront"===e.kind?"cover":"coverBack"===e.kind?"back":"image")+(Z(e.mimeType)??"")}for(;;){i=0n;for(let e=0;e<8;e++)i<<=8n,i|=BigInt(Math.floor(256*Math.random()));if(0n!==i&&!o.has(i))break}o.add(i),t.push({id:$e.AttachedFile,data:[void 0!==e.description?{id:$e.FileDescription,data:new Ie(e.description)}:null,{id:$e.FileName,data:new Ie(n)},{id:$e.FileMediaType,data:e.mimeType},{id:$e.FileData,data:e.data},{id:$e.FileUID,data:i}]})}for(const[o,n]of Object.entries(e.raw??{})){if(!(n instanceof Q))continue;/^\d+$/.test(o)&&(i.find(e=>e.mimeType===n.mimeType&&G(e.data,n.data))||t.push({id:$e.AttachedFile,data:[void 0!==n.description?{id:$e.FileDescription,data:new Ie(n.description)}:null,{id:$e.FileName,data:new Ie(n.name??"")},{id:$e.FileMediaType,data:n.mimeType??""},{id:$e.FileData,data:n.data},{id:$e.FileUID,data:BigInt(o)}]}))}0!==t.length&&(this.attachmentsElement={id:$e.Attachments,data:t})}createSegment(){this.createTracks(),this.maybeCreateTags(),this.maybeCreateAttachments(),this.maybeCreateSeekHead(!1);const e={id:$e.Segment,size:this.format._options.appendOnly?-1:6,data:[this.seekHead,this.segmentInfo,this.tracksElement,this.attachmentsElement,this.tagsElement]};if(this.segment=e,this.format._options.onSegmentHeader&&this.writer.startTrackingWrites(),this.ebmlWriter.writeEBML(e),this.format._options.onSegmentHeader){const{data:e,start:t}=this.writer.stopTrackingWrites();this.format._options.onSegmentHeader(e,t)}}createCues(){this.cues={id:$e.Cues,data:[]}}get segmentDataOffset(){return M(this.segment),this.ebmlWriter.dataOffsets.get(this.segment)}allTracksAreKnown(){for(const e of this.output._tracks)if(!e.source._closed&&!this.trackDatas.some(t=>t.track===e))return!1;return!0}async getMimeType(){await this.allTracksKnown.promise;const e=this.trackDatas.map(e=>{if("video"===e.type)return e.info.decoderConfig.codec;if("audio"===e.type)return e.info.decoderConfig.codec;return{webvtt:"wvtt"}[e.track.source._codec]});return(e=>{let t=(e.hasVideo?"video/":e.hasAudio?"audio/":"application/")+(e.isWebM?"webm":"x-matroska");e.codecStrings.length>0&&(t+=`; codecs="${[...new Set(e.codecStrings.filter(Boolean))].join(", ")}"`);return t})({isWebM:this.format instanceof Xe,hasVideo:this.trackDatas.some(e=>"video"===e.type),hasAudio:this.trackDatas.some(e=>"audio"===e.type),codecStrings:e})}getVideoTrackData(e,t,o){const i=this.trackDatas.find(t=>t.track===e);if(i)return i;(e=>{if(!e)throw new TypeError("Video chunk metadata must be provided.");if("object"!=typeof e)throw new TypeError("Video chunk metadata must be an object.");if(!e.decoderConfig)throw new TypeError("Video chunk metadata must include a decoder configuration.");if("object"!=typeof e.decoderConfig)throw new TypeError("Video chunk metadata decoder configuration must be an object.");if("string"!=typeof e.decoderConfig.codec)throw new TypeError("Video chunk metadata decoder configuration must specify a codec string.");if(!de.some(t=>e.decoderConfig.codec.startsWith(t)))throw new TypeError("Video chunk metadata decoder configuration codec string must be a valid video codec string as specified in the WebCodecs Codec Registry.");if(!Number.isInteger(e.decoderConfig.codedWidth)||e.decoderConfig.codedWidth<=0)throw new TypeError("Video chunk metadata decoder configuration must specify a valid codedWidth (positive integer).");if(!Number.isInteger(e.decoderConfig.codedHeight)||e.decoderConfig.codedHeight<=0)throw new TypeError("Video chunk metadata decoder configuration must specify a valid codedHeight (positive integer).");if(void 0!==e.decoderConfig.description&&!R(e.decoderConfig.description))throw new TypeError("Video chunk metadata decoder configuration description, when defined, must be an ArrayBuffer or an ArrayBuffer view.");if(void 0!==e.decoderConfig.colorSpace){const{colorSpace:t}=e.decoderConfig;if("object"!=typeof t)throw new TypeError("Video chunk metadata decoder configuration colorSpace, when provided, must be an object.");const o=Object.keys(A);if(null!=t.primaries&&!o.includes(t.primaries))throw new TypeError(`Video chunk metadata decoder configuration colorSpace primaries, when defined, must be one of ${o.join(", ")}.`);const i=Object.keys(L);if(null!=t.transfer&&!i.includes(t.transfer))throw new TypeError(`Video chunk metadata decoder configuration colorSpace transfer, when defined, must be one of ${i.join(", ")}.`);const n=Object.keys(z);if(null!=t.matrix&&!n.includes(t.matrix))throw new TypeError(`Video chunk metadata decoder configuration colorSpace matrix, when defined, must be one of ${n.join(", ")}.`);if(null!=t.fullRange&&"boolean"!=typeof t.fullRange)throw new TypeError("Video chunk metadata decoder configuration colorSpace fullRange, when defined, must be a boolean.")}if(e.decoderConfig.codec.startsWith("avc1")||e.decoderConfig.codec.startsWith("avc3")){if(!pe.test(e.decoderConfig.codec))throw new TypeError("Video chunk metadata decoder configuration codec string for AVC must be a valid AVC codec string as specified in Section 3.4 of RFC 6381.")}else if(e.decoderConfig.codec.startsWith("hev1")||e.decoderConfig.codec.startsWith("hvc1")){if(!he.test(e.decoderConfig.codec))throw new TypeError("Video chunk metadata decoder configuration codec string for HEVC must be a valid HEVC codec string as specified in Section E.3 of ISO 14496-15.")}else if(e.decoderConfig.codec.startsWith("vp8")){if("vp8"!==e.decoderConfig.codec)throw new TypeError('Video chunk metadata decoder configuration codec string for VP8 must be "vp8".')}else if(e.decoderConfig.codec.startsWith("vp09")){if(!ue.test(e.decoderConfig.codec))throw new TypeError('Video chunk metadata decoder configuration codec string for VP9 must be a valid VP9 codec string as specified in Section "Codecs Parameter String" of https://www.webmproject.org/vp9/mp4/.')}else if(e.decoderConfig.codec.startsWith("av01")&&!me.test(e.decoderConfig.codec))throw new TypeError('Video chunk metadata decoder configuration codec string for AV1 must be a valid AV1 codec string as specified in Section "Codecs Parameter String" of https://aomediacodec.github.io/av1-isobmff/.')})(o),M(o),M(o.decoderConfig),M(void 0!==o.decoderConfig.codedWidth),M(void 0!==o.decoderConfig.codedHeight);const n={track:e,type:"video",info:{width:o.decoderConfig.codedWidth,height:o.decoderConfig.codedHeight,decoderConfig:o.decoderConfig,alphaMode:!!t.sideData.alpha},chunkQueue:[],lastWrittenMsTimestamp:null};return"vp9"===e.source._codec?n.info.decoderConfig={...n.info.decoderConfig,description:new Uint8Array(se(n.info.decoderConfig.codec))}:"av1"===e.source._codec&&(n.info.decoderConfig={...n.info.decoderConfig,description:new Uint8Array(le(n.info.decoderConfig.codec))}),this.trackDatas.push(n),this.trackDatas.sort((e,t)=>e.track.id-t.track.id),this.allTracksAreKnown()&&this.allTracksKnown.resolve(),n}getAudioTrackData(e,t){const o=this.trackDatas.find(t=>t.track===e);if(o)return o;(e=>{if(!e)throw new TypeError("Audio chunk metadata must be provided.");if("object"!=typeof e)throw new TypeError("Audio chunk metadata must be an object.");if(!e.decoderConfig)throw new TypeError("Audio chunk metadata must include a decoder configuration.");if("object"!=typeof e.decoderConfig)throw new TypeError("Audio chunk metadata decoder configuration must be an object.");if("string"!=typeof e.decoderConfig.codec)throw new TypeError("Audio chunk metadata decoder configuration must specify a codec string.");if(!ge.some(t=>e.decoderConfig.codec.startsWith(t)))throw new TypeError("Audio chunk metadata decoder configuration codec string must be a valid audio codec string as specified in the WebCodecs Codec Registry.");if(!Number.isInteger(e.decoderConfig.sampleRate)||e.decoderConfig.sampleRate<=0)throw new TypeError("Audio chunk metadata decoder configuration must specify a valid sampleRate (positive integer).");if(!Number.isInteger(e.decoderConfig.numberOfChannels)||e.decoderConfig.numberOfChannels<=0)throw new TypeError("Audio chunk metadata decoder configuration must specify a valid numberOfChannels (positive integer).");if(void 0!==e.decoderConfig.description&&!R(e.decoderConfig.description))throw new TypeError("Audio chunk metadata decoder configuration description, when defined, must be an ArrayBuffer or an ArrayBuffer view.");if(e.decoderConfig.codec.startsWith("mp4a")&&"mp4a.69"!==e.decoderConfig.codec&&"mp4a.6B"!==e.decoderConfig.codec&&"mp4a.6b"!==e.decoderConfig.codec){if(!["mp4a.40.2","mp4a.40.02","mp4a.40.5","mp4a.40.05","mp4a.40.29","mp4a.67"].includes(e.decoderConfig.codec))throw new TypeError("Audio chunk metadata decoder configuration codec string for AAC must be a valid AAC codec string as specified in https://www.w3.org/TR/webcodecs-aac-codec-registration/.");if(!e.decoderConfig.description)throw new TypeError("Audio chunk metadata decoder configuration for AAC must include a description, which is expected to be an AudioSpecificConfig as specified in ISO 14496-3.")}else if(e.decoderConfig.codec.startsWith("mp3")||e.decoderConfig.codec.startsWith("mp4a")){if("mp3"!==e.decoderConfig.codec&&"mp4a.69"!==e.decoderConfig.codec&&"mp4a.6B"!==e.decoderConfig.codec&&"mp4a.6b"!==e.decoderConfig.codec)throw new TypeError('Audio chunk metadata decoder configuration codec string for MP3 must be "mp3", "mp4a.69" or "mp4a.6B".')}else if(e.decoderConfig.codec.startsWith("opus")){if("opus"!==e.decoderConfig.codec)throw new TypeError('Audio chunk metadata decoder configuration codec string for Opus must be "opus".');if(e.decoderConfig.description&&e.decoderConfig.description.byteLength<18)throw new TypeError("Audio chunk metadata decoder configuration description, when specified, is expected to be an Identification Header as specified in Section 5.1 of RFC 7845.")}else if(e.decoderConfig.codec.startsWith("vorbis")){if("vorbis"!==e.decoderConfig.codec)throw new TypeError('Audio chunk metadata decoder configuration codec string for Vorbis must be "vorbis".');if(!e.decoderConfig.description)throw new TypeError("Audio chunk metadata decoder configuration for Vorbis must include a description, which is expected to adhere to the format described in https://www.w3.org/TR/webcodecs-vorbis-codec-registration/.")}else if(e.decoderConfig.codec.startsWith("flac")){if("flac"!==e.decoderConfig.codec)throw new TypeError('Audio chunk metadata decoder configuration codec string for FLAC must be "flac".');const t=42;if(!e.decoderConfig.description||e.decoderConfig.description.byteLength<t)throw new TypeError("Audio chunk metadata decoder configuration for FLAC must include a description, which is expected to adhere to the format described in https://www.w3.org/TR/webcodecs-flac-codec-registration/.")}else if((e.decoderConfig.codec.startsWith("pcm")||e.decoderConfig.codec.startsWith("ulaw")||e.decoderConfig.codec.startsWith("alaw"))&&!J.includes(e.decoderConfig.codec))throw new TypeError(`Audio chunk metadata decoder configuration codec string for PCM must be one of the supported PCM codecs (${J.join(", ")}).`)})(t),M(t),M(t.decoderConfig);const i={track:e,type:"audio",info:{numberOfChannels:t.decoderConfig.numberOfChannels,sampleRate:t.decoderConfig.sampleRate,decoderConfig:t.decoderConfig},chunkQueue:[],lastWrittenMsTimestamp:null};return this.trackDatas.push(i),this.trackDatas.sort((e,t)=>e.track.id-t.track.id),this.allTracksAreKnown()&&this.allTracksKnown.resolve(),i}getSubtitleTrackData(e,t){const o=this.trackDatas.find(t=>t.track===e);if(o)return o;(e=>{if(!e)throw new TypeError("Subtitle metadata must be provided.");if("object"!=typeof e)throw new TypeError("Subtitle metadata must be an object.");if(!e.config)throw new TypeError("Subtitle metadata must include a config object.");if("object"!=typeof e.config)throw new TypeError("Subtitle metadata config must be an object.");if("string"!=typeof e.config.description)throw new TypeError("Subtitle metadata config description must be a string.")})(t),M(t),M(t.config);const i={track:e,type:"subtitle",info:{config:t.config},chunkQueue:[],lastWrittenMsTimestamp:null};return this.trackDatas.push(i),this.trackDatas.sort((e,t)=>e.track.id-t.track.id),this.allTracksAreKnown()&&this.allTracksKnown.resolve(),i}async addEncodedVideoPacket(e,t,o){const i=await this.mutex.acquire();try{const i=this.getVideoTrackData(e,t,o),n="key"===t.type;let r=this.validateAndNormalizeTimestamp(i.track,t.timestamp,n),a=t.duration;void 0!==e.metadata.frameRate&&(r=N(r,1/e.metadata.frameRate),a=N(a,1/e.metadata.frameRate));const s=i.info.alphaMode?t.sideData.alpha??null:null,l=this.createInternalChunk(t.data,r,a,t.type,s);"vp9"===e.source._codec&&this.fixVP9ColorSpace(i,l),i.chunkQueue.push(l),await this.interleaveChunks()}finally{i()}}async addEncodedAudioPacket(e,t,o){const i=await this.mutex.acquire();try{const i=this.getAudioTrackData(e,o),n="key"===t.type,r=this.validateAndNormalizeTimestamp(i.track,t.timestamp,n),a=this.createInternalChunk(t.data,r,t.duration,t.type);i.chunkQueue.push(a),await this.interleaveChunks()}finally{i()}}async addSubtitleCue(e,t,o){const i=await this.mutex.acquire();try{const i=this.getSubtitleTrackData(e,o),n=this.validateAndNormalizeTimestamp(i.track,t.timestamp,!0);let r=t.text;const a=Math.round(1e3*n);Re.lastIndex=0,r=r.replace(Re,e=>`<${(e=>{const t=Math.floor(e/36e5),o=Math.floor(e%36e5/6e4),i=Math.floor(e%6e4/1e3),n=e%1e3;return t.toString().padStart(2,"0")+":"+o.toString().padStart(2,"0")+":"+i.toString().padStart(2,"0")+"."+n.toString().padStart(3,"0")})((e=>{const t=qe.exec(e);if(!t)throw new Error("Expected match.");return 36e5*Number(t[1]||"0")+6e4*Number(t[2])+1e3*Number(t[3])+Number(t[4])})(e.slice(1,-1))-a)}>`);const s=$.encode(r),l=`${t.settings??""}\n${t.identifier??""}\n${t.notes??""}`,c=this.createInternalChunk(s,n,t.duration,"key",l.trim()?$.encode(l):null);i.chunkQueue.push(c),await this.interleaveChunks()}finally{i()}}async interleaveChunks(e=!1){if(e||this.allTracksAreKnown()){e:for(;;){let t=null,o=1/0;for(const i of this.trackDatas){if(!e&&0===i.chunkQueue.length&&!i.track.source._closed)break e;i.chunkQueue.length>0&&i.chunkQueue[0].timestamp<o&&(t=i,o=i.chunkQueue[0].timestamp)}if(!t)break;const i=t.chunkQueue.shift();this.writeBlock(t,i)}e||await this.writer.flush()}}fixVP9ColorSpace(e,t){if("key"!==t.type)return;if(!e.info.decoderConfig.colorSpace||!e.info.decoderConfig.colorSpace.matrix)return;const o=new F(t.data);o.skipBits(2);const i=o.readBits(1),n=(o.readBits(1)<<1)+i;3===n&&o.skipBits(1);if(o.readBits(1))return;if(0!==o.readBits(1))return;o.skipBits(2);if(4817730!==o.readBits(24))return;n>=2&&o.skipBits(1);const r={rgb:7,bt709:2,bt470bg:1,smpte170m:3}[e.info.decoderConfig.colorSpace.matrix];((e,t,o,i)=>{for(let n=t;n<o;n++){const t=Math.floor(n/8);let r=e[t];const a=7-(7&n);r&=~(1<<a),r|=(i&1<<o-n-1)>>o-n-1<<a,e[t]=r}})(t.data,o.pos,o.pos+3,r)}createInternalChunk(e,t,o,i,n=null){return{data:e,type:i,timestamp:t,duration:o,additions:n}}writeBlock(e,t){this.segment||this.createSegment();const o=Math.round(1e3*t.timestamp),i=this.trackDatas.every(o=>{if(e===o)return"key"===t.type;const i=o.chunkQueue[0];return i?"key"===i.type:o.track.source._closed});let n=!1;if(this.currentCluster){M(null!==this.currentClusterStartMsTimestamp),M(null!==this.currentClusterMaxMsTimestamp);const e=o-this.currentClusterStartMsTimestamp;n=i&&o>this.currentClusterMaxMsTimestamp&&e>=1e3*(this.format._options.minimumClusterDuration??1)||e>32767}else n=!0;n&&this.createNewCluster(o);const r=o-this.currentClusterStartMsTimestamp;if(r<-32768)return;const a=new Uint8Array(4),s=new DataView(a.buffer);s.setUint8(0,128|e.track.id),s.setInt16(1,r,!1);const l=Math.round(1e3*t.duration);if(t.additions){const i={id:$e.BlockGroup,data:[{id:$e.Block,data:[a,t.data]},"delta"===t.type?{id:$e.ReferenceBlock,data:new Fe(e.lastWrittenMsTimestamp-o)}:null,t.additions?{id:$e.BlockAdditions,data:[{id:$e.BlockMore,data:[{id:$e.BlockAddID,data:1},{id:$e.BlockAdditional,data:t.additions}]}]}:null,l>0?{id:$e.BlockDuration,data:l}:null]};this.ebmlWriter.writeEBML(i)}else{s.setUint8(3,Number("key"===t.type)<<7);const e={id:$e.SimpleBlock,data:[a,t.data]};this.ebmlWriter.writeEBML(e)}this.duration=Math.max(this.duration,o+l),e.lastWrittenMsTimestamp=o,this.trackDatasInCurrentCluster.has(e)||this.trackDatasInCurrentCluster.set(e,{firstMsTimestamp:o}),this.currentClusterMaxMsTimestamp=Math.max(this.currentClusterMaxMsTimestamp,o)}createNewCluster(e){this.currentCluster&&this.finalizeCurrentCluster(),this.format._options.onCluster&&this.writer.startTrackingWrites(),this.currentCluster={id:$e.Cluster,size:this.format._options.appendOnly?-1:5,data:[{id:$e.Timestamp,data:e}]},this.ebmlWriter.writeEBML(this.currentCluster),this.currentClusterStartMsTimestamp=e,this.currentClusterMaxMsTimestamp=e,this.trackDatasInCurrentCluster.clear()}finalizeCurrentCluster(){if(M(this.currentCluster),!this.format._options.appendOnly){const e=this.writer.getPos()-this.ebmlWriter.dataOffsets.get(this.currentCluster),t=this.writer.getPos();this.writer.seek(this.ebmlWriter.offsets.get(this.currentCluster)+4),this.ebmlWriter.writeVarInt(e,5),this.writer.seek(t)}if(this.format._options.onCluster){M(null!==this.currentClusterStartMsTimestamp);const{data:e,start:t}=this.writer.stopTrackingWrites();this.format._options.onCluster(e,t,this.currentClusterStartMsTimestamp/1e3)}const e=this.ebmlWriter.offsets.get(this.currentCluster)-this.segmentDataOffset,t=new Map;for(const[e,{firstMsTimestamp:o}]of this.trackDatasInCurrentCluster)t.has(o)||t.set(o,[]),t.get(o).push(e);const o=[...t.entries()].sort((e,t)=>e[0]-t[0]);for(const[t,i]of o)M(this.cues),this.cues.data.push({id:$e.CuePoint,data:[{id:$e.CueTime,data:t},...i.map(t=>({id:$e.CueTrackPositions,data:[{id:$e.CueTrack,data:t.track.id},{id:$e.CueClusterPosition,data:e}]}))]})}async onTrackClose(){const e=await this.mutex.acquire();this.allTracksAreKnown()&&this.allTracksKnown.resolve(),await this.interleaveChunks(),e()}async finalize(){const e=await this.mutex.acquire();if(this.allTracksKnown.resolve(),this.segment||this.createSegment(),await this.interleaveChunks(!0),this.currentCluster&&this.finalizeCurrentCluster(),M(this.cues),this.ebmlWriter.writeEBML(this.cues),!this.format._options.appendOnly){const e=this.writer.getPos(),t=this.writer.getPos()-this.segmentDataOffset;this.writer.seek(this.ebmlWriter.offsets.get(this.segment)+4),this.ebmlWriter.writeVarInt(t,6),this.segmentDuration.data=new Pe(this.duration),this.writer.seek(this.ebmlWriter.offsets.get(this.segmentDuration)),this.ebmlWriter.writeEBML(this.segmentDuration),M(this.seekHead),this.writer.seek(this.ebmlWriter.offsets.get(this.seekHead)),this.maybeCreateSeekHead(!0),this.ebmlWriter.writeEBML(this.seekHead),this.writer.seek(e)}e()}}
/*!
   * Copyright (c) 2025-present, Vanilagy and contributors
   *
   * This Source Code Form is subject to the terms of the Mozilla Public
   * License, v. 2.0. If a copy of the MPL was not distributed with this
   * file, You can obtain one at https://mozilla.org/MPL/2.0/.
   */class Ke{getSupportedVideoCodecs(){return this.getSupportedCodecs().filter(e=>X.includes(e))}getSupportedAudioCodecs(){return this.getSupportedCodecs().filter(e=>ee.includes(e))}getSupportedSubtitleCodecs(){return this.getSupportedCodecs().filter(e=>te.includes(e))}_codecUnsupportedHint(e){return""}}class Qe extends Ke{constructor(e={}){if(!e||"object"!=typeof e)throw new TypeError("options must be an object.");if(void 0!==e.appendOnly&&"boolean"!=typeof e.appendOnly)throw new TypeError("options.appendOnly, when provided, must be a boolean.");if(void 0!==e.minimumClusterDuration&&(!Number.isFinite(e.minimumClusterDuration)||e.minimumClusterDuration<0))throw new TypeError("options.minimumClusterDuration, when provided, must be a non-negative number.");if(void 0!==e.onEbmlHeader&&"function"!=typeof e.onEbmlHeader)throw new TypeError("options.onEbmlHeader, when provided, must be a function.");if(void 0!==e.onSegmentHeader&&"function"!=typeof e.onSegmentHeader)throw new TypeError("options.onHeader, when provided, must be a function.");if(void 0!==e.onCluster&&"function"!=typeof e.onCluster)throw new TypeError("options.onCluster, when provided, must be a function.");super(),this._options=e}_createMuxer(e){return new Ge(e,this)}get _name(){return"Matroska"}getSupportedTrackCounts(){return{video:{min:0,max:1/0},audio:{min:0,max:1/0},subtitle:{min:0,max:1/0},total:{min:1,max:127}}}get fileExtension(){return".mkv"}get mimeType(){return"video/x-matroska"}getSupportedCodecs(){return[...X,...Y,...J.filter(e=>!["pcm-s8","pcm-f32be","pcm-f64be","ulaw","alaw"].includes(e)),...te]}get supportsVideoRotationMetadata(){return!1}}class Xe extends Qe{constructor(e){super(e)}getSupportedCodecs(){return[...X.filter(e=>["vp8","vp9","av1"].includes(e)),...ee.filter(e=>["opus","vorbis"].includes(e)),...te]}get _name(){return"WebM"}get fileExtension(){return".webm"}get mimeType(){return"video/webm"}_codecUnsupportedHint(e){return(new Qe).getSupportedCodecs().includes(e)?" Switching to MKV will grant support for this codec.":""}}
/*!
   * Copyright (c) 2025-present, Vanilagy and contributors
   *
   * This Source Code Form is subject to the terms of the Mozilla Public
   * License, v. 2.0. If a copy of the MPL was not distributed with this
   * file, You can obtain one at https://mozilla.org/MPL/2.0/.
   */const Je=(e,t)=>{if(!t||"object"!=typeof t)throw new TypeError("Encoding options must be an object.");if(void 0!==t.alpha&&!["discard","keep"].includes(t.alpha))throw new TypeError("options.alpha, when provided, must be 'discard' or 'keep'.");if(void 0!==t.bitrateMode&&!["constant","variable"].includes(t.bitrateMode))throw new TypeError("bitrateMode, when provided, must be 'constant' or 'variable'.");if(void 0!==t.latencyMode&&!["quality","realtime"].includes(t.latencyMode))throw new TypeError("latencyMode, when provided, must be 'quality' or 'realtime'.");if(void 0!==t.fullCodecString&&"string"!=typeof t.fullCodecString)throw new TypeError("fullCodecString, when provided, must be a string.");if(void 0!==t.fullCodecString&&((o=t.fullCodecString).startsWith("avc1")||o.startsWith("avc3")?"avc":o.startsWith("hev1")||o.startsWith("hvc1")?"hevc":"vp8"===o?"vp8":o.startsWith("vp09")?"vp9":o.startsWith("av01")?"av1":o.startsWith("mp4a.40")||"mp4a.67"===o?"aac":"mp3"===o||"mp4a.69"===o||"mp4a.6B"===o||"mp4a.6b"===o?"mp3":"opus"===o?"opus":"vorbis"===o?"vorbis":"flac"===o?"flac":"ulaw"===o?"ulaw":"alaw"===o?"alaw":ce.test(o)?o:"webvtt"===o?"webvtt":null)!==e)throw new TypeError(`fullCodecString, when provided, must be a string that matches the specified codec (${e}).`);var o;if(void 0!==t.hardwareAcceleration&&!["no-preference","prefer-hardware","prefer-software"].includes(t.hardwareAcceleration))throw new TypeError("hardwareAcceleration, when provided, must be 'no-preference', 'prefer-hardware' or 'prefer-software'.");if(void 0!==t.scalabilityMode&&"string"!=typeof t.scalabilityMode)throw new TypeError("scalabilityMode, when provided, must be a string.");if(void 0!==t.contentHint&&"string"!=typeof t.contentHint)throw new TypeError("contentHint, when provided, must be a string.")};class Ye{constructor(e){this._factor=e}_toVideoBitrate(e,t,o){const i=t*o,n=3e6*Math.pow(i/2073600,.95)*{avc:1,hevc:.6,vp9:.6,av1:.4,vp8:1.2}[e]*this._factor;return 1e3*Math.ceil(n/1e3)}_toAudioBitrate(e){if(J.includes(e)||"flac"===e)return;const t={aac:128e3,opus:64e3,mp3:16e4,vorbis:64e3}[e];if(!t)throw new Error(`Unhandled codec: ${e}`);let o=t*this._factor;if("aac"===e){o=[96e3,128e3,16e4,192e3].reduce((e,t)=>Math.abs(t-o)<Math.abs(e-o)?t:e)}else if("opus"===e||"vorbis"===e)o=Math.max(6e3,o);else if("mp3"===e){o=[8e3,16e3,24e3,32e3,4e4,48e3,64e3,8e4,96e3,112e3,128e3,16e4,192e3,224e3,256e3,32e4].reduce((e,t)=>Math.abs(t-o)<Math.abs(e-o)?t:e)}return 1e3*Math.round(o/1e3)}}const et=new Ye(2),tt=new Ye(4);
/*!
   * Copyright (c) 2025-present, Vanilagy and contributors
   *
   * This Source Code Form is subject to the terms of the Mozilla Public
   * License, v. 2.0. If a copy of the MPL was not distributed with this
   * file, You can obtain one at https://mozilla.org/MPL/2.0/.
   */
class ot{constructor(){this._connectedTrack=null,this._closingPromise=null,this._closed=!1,this._timestampOffset=0}_ensureValidAdd(){if(!this._connectedTrack)throw new Error("Source is not connected to an output track.");if("canceled"===this._connectedTrack.output.state)throw new Error("Output has been canceled.");if("finalizing"===this._connectedTrack.output.state||"finalized"===this._connectedTrack.output.state)throw new Error("Output has been finalized.");if("pending"===this._connectedTrack.output.state)throw new Error("Output has not started.");if(this._closed)throw new Error("Source is closed.")}async _start(){}async _flushAndClose(e){}close(){if(this._closingPromise)return;const e=this._connectedTrack;if(!e)throw new Error("Cannot call close without connecting the source to an output track.");if("pending"===e.output.state)throw new Error("Cannot call close before output has been started.");this._closingPromise=(async()=>{await this._flushAndClose(!1),this._closed=!0,"finalizing"!==e.output.state&&"finalized"!==e.output.state&&e.output._muxer.onTrackClose(e)})()}async _flushOrWaitForOngoingClose(e){return this._closingPromise?this._closingPromise:this._flushAndClose(e)}}class it extends ot{constructor(e){if(super(),this._connectedTrack=null,!X.includes(e))throw new TypeError(`Invalid video codec '${e}'. Must be one of: ${X.join(", ")}.`);this._codec=e}}class nt{constructor(e,t){this.source=e,this.encodingConfig=t,this.ensureEncoderPromise=null,this.encoderInitialized=!1,this.encoder=null,this.muxer=null,this.lastMultipleOfKeyFrameInterval=-1,this.codedWidth=null,this.codedHeight=null,this.resizeCanvas=null,this.customEncoder=null,this.customEncoderCallSerializer=new H,this.customEncoderQueueSize=0,this.alphaEncoder=null,this.splitter=null,this.splitterCreationFailed=!1,this.alphaFrameQueue=[],this.error=null,this.errorNeedsNewStack=!0}async add(e,t,o){try{if(this.checkForEncoderError(),this.source._ensureValidAdd(),null!==this.codedWidth&&null!==this.codedHeight){if(e.codedWidth!==this.codedWidth||e.codedHeight!==this.codedHeight){const o=this.encodingConfig.sizeChangeBehavior??"deny";if("passThrough"===o);else{if("deny"===o)throw new Error(`Video sample size must remain constant. Expected ${this.codedWidth}x${this.codedHeight}, got ${e.codedWidth}x${e.codedHeight}. To allow the sample size to change over time, set \`sizeChangeBehavior\` to a value other than 'strict' in the encoding options.`);{let i=!1;this.resizeCanvas||("undefined"!=typeof document?(this.resizeCanvas=document.createElement("canvas"),this.resizeCanvas.width=this.codedWidth,this.resizeCanvas.height=this.codedHeight):this.resizeCanvas=new OffscreenCanvas(this.codedWidth,this.codedHeight),i=!0);const n=this.resizeCanvas.getContext("2d",{alpha:j()});M(n),i||(j()?(n.fillStyle="black",n.fillRect(0,0,this.codedWidth,this.codedHeight)):n.clearRect(0,0,this.codedWidth,this.codedHeight)),e.drawWithFit(n,{fit:o}),t&&e.close(),e=new ke(this.resizeCanvas,{timestamp:e.timestamp,duration:e.duration,rotation:e.rotation}),t=!0}}}}else this.codedWidth=e.codedWidth,this.codedHeight=e.codedHeight;this.encoderInitialized||(this.ensureEncoderPromise||this.ensureEncoder(e),this.encoderInitialized||await this.ensureEncoderPromise),M(this.encoderInitialized);const i=this.encodingConfig.keyFrameInterval??5,n=Math.floor(e.timestamp/i),r={...o,keyFrame:o?.keyFrame||0===i||n!==this.lastMultipleOfKeyFrameInterval};if(this.lastMultipleOfKeyFrameInterval=n,this.customEncoder){this.customEncoderQueueSize++;const t=e.clone(),o=this.customEncoderCallSerializer.call(()=>this.customEncoder.encode(t,r)).then(()=>this.customEncoderQueueSize--).catch(e=>this.error??=e).finally(()=>{t.close()});this.customEncoderQueueSize>=4&&await o}else{M(this.encoder);const o=e.toVideoFrame();if(this.alphaEncoder){if(!!o.format&&!o.format.includes("A")||this.splitterCreationFailed)this.alphaFrameQueue.push(null),this.encoder.encode(o,r),o.close();else{const e=o.displayWidth,t=o.displayHeight;if(!this.splitter)try{this.splitter=new rt(e,t)}catch(e){console.error("Due to an error, only color data will be encoded.",e),this.splitterCreationFailed=!0,this.alphaFrameQueue.push(null),this.encoder.encode(o,r),o.close()}if(this.splitter){const e=this.splitter.extractColor(o),t=this.splitter.extractAlpha(o);this.alphaFrameQueue.push(t),this.encoder.encode(e,r),e.close(),o.close()}}}else this.encoder.encode(o,r),o.close();t&&e.close(),this.encoder.encodeQueueSize>=4&&await new Promise(e=>this.encoder.addEventListener("dequeue",e,{once:!0}))}await this.muxer.mutex.currentPromise}finally{t&&e.close()}}ensureEncoder(e){const t=new Error;this.ensureEncoderPromise=(async()=>{const o=(e=>{const t=e.bitrate instanceof Ye?e.bitrate._toVideoBitrate(e.codec,e.width,e.height):e.bitrate;return{codec:e.fullCodecString??ae(e.codec,e.width,e.height,t),width:e.width,height:e.height,bitrate:t,bitrateMode:e.bitrateMode,alpha:e.alpha??"discard",framerate:e.framerate,latencyMode:e.latencyMode,hardwareAcceleration:e.hardwareAcceleration,scalabilityMode:e.scalabilityMode,contentHint:e.contentHint,...(o=e.codec,"avc"===o?{avc:{format:"avc"}}:"hevc"===o?{hevc:{format:"hevc"}}:{})};var o})({width:e.codedWidth,height:e.codedHeight,...this.encodingConfig,framerate:this.source._connectedTrack?.metadata.frameRate});this.encodingConfig.onEncoderConfig?.(o);const i=xe.find(e=>e.supports(this.encodingConfig.codec,o));if(i)this.customEncoder=new i,this.customEncoder.codec=this.encodingConfig.codec,this.customEncoder.config=o,this.customEncoder.onPacket=(e,t)=>{if(!(e instanceof Se))throw new TypeError("The first argument passed to onPacket must be an EncodedPacket.");if(void 0!==t&&(!t||"object"!=typeof t))throw new TypeError("The second argument passed to onPacket must be an object or undefined.");this.encodingConfig.onEncodedPacket?.(e,t),this.muxer.addEncodedVideoPacket(this.source._connectedTrack,e,t).catch(e=>{this.error??=e,this.errorNeedsNewStack=!1})},await this.customEncoder.init();else{if("undefined"==typeof VideoEncoder)throw new Error("VideoEncoder is not supported by this browser.");o.alpha="discard","keep"===this.encodingConfig.alpha&&(o.latencyMode="quality");if((o.width%2==1||o.height%2==1)&&("avc"===this.encodingConfig.codec||"hevc"===this.encodingConfig.codec))throw new Error(`The dimensions ${o.width}x${o.height} are not supported for codec '${this.encodingConfig.codec}'; both width and height must be even numbers. Make sure to round your dimensions to the nearest even number.`);if(!(await VideoEncoder.isConfigSupported(o)).supported)throw new Error(`This specific encoder configuration (${o.codec}, ${o.bitrate} bps, ${o.width}x${o.height}, hardware acceleration: ${o.hardwareAcceleration??"no-preference"}) is not supported by this browser. Consider using another codec or changing your video parameters.`);const e=[],i=[];let n=0,r=0;const a=(e,t,o)=>{const i={};if(t){const e=new Uint8Array(t.byteLength);t.copyTo(e),i.alpha=e}const n=Se.fromEncodedChunk(e,i);this.encodingConfig.onEncodedPacket?.(n,o),this.muxer.addEncodedVideoPacket(this.source._connectedTrack,n,o).catch(e=>{this.error??=e,this.errorNeedsNewStack=!1})};this.encoder=new VideoEncoder({output:(t,o)=>{if(!this.alphaEncoder)return void a(t,null,o);const s=this.alphaFrameQueue.shift();M(void 0!==s),s?(this.alphaEncoder.encode(s,{keyFrame:"key"===t.type}),r++,s.close(),e.push({chunk:t,meta:o})):0===r?a(t,null,o):(i.push(n+r),e.push({chunk:t,meta:o}))},error:e=>{e.stack=t.stack,this.error??=e}}),this.encoder.configure(o),"keep"===this.encodingConfig.alpha&&(this.alphaEncoder=new VideoEncoder({output:(t,o)=>{r--;const s=e.shift();for(M(void 0!==s),a(s.chunk,t,s.meta),n++;i.length>0&&i[0]===n;){i.shift();const t=e.shift();M(void 0!==t),a(t.chunk,null,t.meta)}},error:e=>{e.stack=t.stack,this.error??=e}}),this.alphaEncoder.configure(o))}M(this.source._connectedTrack),this.muxer=this.source._connectedTrack.output._muxer,this.encoderInitialized=!0})()}async flushAndClose(e){e||this.checkForEncoderError(),this.customEncoder?(e||this.customEncoderCallSerializer.call(()=>this.customEncoder.flush()),await this.customEncoderCallSerializer.call(()=>this.customEncoder.close())):this.encoder&&(e||(await this.encoder.flush(),await(this.alphaEncoder?.flush())),"closed"!==this.encoder.state&&this.encoder.close(),this.alphaEncoder&&"closed"!==this.alphaEncoder.state&&this.alphaEncoder.close(),this.alphaFrameQueue.forEach(e=>e?.close()),this.splitter?.close()),e||this.checkForEncoderError()}getQueueSize(){return this.customEncoder?this.customEncoderQueueSize:this.encoder?.encodeQueueSize??0}checkForEncoderError(){if(this.error)throw this.errorNeedsNewStack&&(this.error.stack=(new Error).stack),this.error}}class rt{constructor(e,t){this.lastFrame=null,"undefined"!=typeof OffscreenCanvas?this.canvas=new OffscreenCanvas(e,t):(this.canvas=document.createElement("canvas"),this.canvas.width=e,this.canvas.height=t);const o=this.canvas.getContext("webgl2",{alpha:!0});if(!o)throw new Error("Couldn't acquire WebGL 2 context.");this.gl=o,this.colorProgram=this.createColorProgram(),this.alphaProgram=this.createAlphaProgram(),this.vao=this.createVAO(),this.sourceTexture=this.createTexture(),this.alphaResolutionLocation=this.gl.getUniformLocation(this.alphaProgram,"u_resolution"),this.gl.useProgram(this.colorProgram),this.gl.uniform1i(this.gl.getUniformLocation(this.colorProgram,"u_sourceTexture"),0),this.gl.useProgram(this.alphaProgram),this.gl.uniform1i(this.gl.getUniformLocation(this.alphaProgram,"u_sourceTexture"),0)}createVertexShader(){return this.createShader(this.gl.VERTEX_SHADER,"#version 300 es\n\t\t\tin vec2 a_position;\n\t\t\tin vec2 a_texCoord;\n\t\t\tout vec2 v_texCoord;\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t\tgl_Position = vec4(a_position, 0.0, 1.0);\n\t\t\t\tv_texCoord = a_texCoord;\n\t\t\t}\n\t\t")}createColorProgram(){const e=this.createVertexShader(),t=this.createShader(this.gl.FRAGMENT_SHADER,"#version 300 es\n\t\t\tprecision highp float;\n\t\t\t\n\t\t\tuniform sampler2D u_sourceTexture;\n\t\t\tin vec2 v_texCoord;\n\t\t\tout vec4 fragColor;\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t\tvec4 source = texture(u_sourceTexture, v_texCoord);\n\t\t\t\tfragColor = vec4(source.rgb, 1.0);\n\t\t\t}\n\t\t"),o=this.gl.createProgram();return this.gl.attachShader(o,e),this.gl.attachShader(o,t),this.gl.linkProgram(o),o}createAlphaProgram(){const e=this.createVertexShader(),t=this.createShader(this.gl.FRAGMENT_SHADER,"#version 300 es\n\t\t\tprecision highp float;\n\t\t\t\n\t\t\tuniform sampler2D u_sourceTexture;\n\t\t\tuniform vec2 u_resolution; // The width and height of the canvas\n\t\t\tin vec2 v_texCoord;\n\t\t\tout vec4 fragColor;\n\n\t\t\t// This function determines the value for a single byte in the YUV stream\n\t\t\tfloat getByteValue(float byteOffset) {\n\t\t\t\tfloat width = u_resolution.x;\n\t\t\t\tfloat height = u_resolution.y;\n\n\t\t\t\tfloat yPlaneSize = width * height;\n\n\t\t\t\tif (byteOffset < yPlaneSize) {\n\t\t\t\t\t// This byte is in the luma plane. Find the corresponding pixel coordinates to sample from\n\t\t\t\t\tfloat y = floor(byteOffset / width);\n\t\t\t\t\tfloat x = mod(byteOffset, width);\n\t\t\t\t\t\n\t\t\t\t\t// Add 0.5 to sample the center of the texel\n\t\t\t\t\tvec2 sampleCoord = (vec2(x, y) + 0.5) / u_resolution;\n\t\t\t\t\t\n\t\t\t\t\t// The luma value is the alpha from the source texture\n\t\t\t\t\treturn texture(u_sourceTexture, sampleCoord).a;\n\t\t\t\t} else {\n\t\t\t\t\t// Write a fixed value for chroma and beyond\n\t\t\t\t\treturn 128.0 / 255.0;\n\t\t\t\t}\n\t\t\t}\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t\t// Each fragment writes 4 bytes (R, G, B, A)\n\t\t\t\tfloat pixelIndex = floor(gl_FragCoord.y) * u_resolution.x + floor(gl_FragCoord.x);\n\t\t\t\tfloat baseByteOffset = pixelIndex * 4.0;\n\n\t\t\t\tvec4 result;\n\t\t\t\tfor (int i = 0; i < 4; i++) {\n\t\t\t\t\tfloat currentByteOffset = baseByteOffset + float(i);\n\t\t\t\t\tresult[i] = getByteValue(currentByteOffset);\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\tfragColor = result;\n\t\t\t}\n\t\t"),o=this.gl.createProgram();return this.gl.attachShader(o,e),this.gl.attachShader(o,t),this.gl.linkProgram(o),o}createShader(e,t){const o=this.gl.createShader(e);return this.gl.shaderSource(o,t),this.gl.compileShader(o),this.gl.getShaderParameter(o,this.gl.COMPILE_STATUS)||console.error("Shader compile error:",this.gl.getShaderInfoLog(o)),o}createVAO(){const e=this.gl.createVertexArray();this.gl.bindVertexArray(e);const t=new Float32Array([-1,-1,0,1,1,-1,1,1,-1,1,0,0,1,1,1,0]),o=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,o),this.gl.bufferData(this.gl.ARRAY_BUFFER,t,this.gl.STATIC_DRAW);const i=this.gl.getAttribLocation(this.colorProgram,"a_position"),n=this.gl.getAttribLocation(this.colorProgram,"a_texCoord");return this.gl.enableVertexAttribArray(i),this.gl.vertexAttribPointer(i,2,this.gl.FLOAT,!1,16,0),this.gl.enableVertexAttribArray(n),this.gl.vertexAttribPointer(n,2,this.gl.FLOAT,!1,16,8),e}createTexture(){const e=this.gl.createTexture();return this.gl.bindTexture(this.gl.TEXTURE_2D,e),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR),e}updateTexture(e){this.lastFrame!==e&&(e.displayWidth===this.canvas.width&&e.displayHeight===this.canvas.height||(this.canvas.width=e.displayWidth,this.canvas.height=e.displayHeight),this.gl.activeTexture(this.gl.TEXTURE0),this.gl.bindTexture(this.gl.TEXTURE_2D,this.sourceTexture),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,e),this.lastFrame=e)}extractColor(e){return this.updateTexture(e),this.gl.useProgram(this.colorProgram),this.gl.viewport(0,0,this.canvas.width,this.canvas.height),this.gl.clear(this.gl.COLOR_BUFFER_BIT),this.gl.bindVertexArray(this.vao),this.gl.drawArrays(this.gl.TRIANGLE_STRIP,0,4),new VideoFrame(this.canvas,{timestamp:e.timestamp,duration:e.duration??void 0,alpha:"discard"})}extractAlpha(e){this.updateTexture(e),this.gl.useProgram(this.alphaProgram),this.gl.uniform2f(this.alphaResolutionLocation,this.canvas.width,this.canvas.height),this.gl.viewport(0,0,this.canvas.width,this.canvas.height),this.gl.clear(this.gl.COLOR_BUFFER_BIT),this.gl.bindVertexArray(this.vao),this.gl.drawArrays(this.gl.TRIANGLE_STRIP,0,4);const{width:t,height:o}=this.canvas,i=t*o+2*(Math.ceil(t/2)*Math.ceil(o/2)),n=Math.ceil(i/(4*t));let r=new Uint8Array(4*t*n);this.gl.readPixels(0,0,t,n,this.gl.RGBA,this.gl.UNSIGNED_BYTE,r),r=r.subarray(0,i),M(128===r[t*o]),M(128===r[r.length-1]);const a={format:"I420",codedWidth:t,codedHeight:o,timestamp:e.timestamp,duration:e.duration??void 0,transfer:[r.buffer]};return new VideoFrame(r,a)}close(){this.gl.getExtension("WEBGL_lose_context")?.loseContext(),this.gl=null}}class at extends it{constructor(e,t){if(!("undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof OffscreenCanvas&&e instanceof OffscreenCanvas))throw new TypeError("canvas must be an HTMLCanvasElement or OffscreenCanvas.");(e=>{if(!e||"object"!=typeof e)throw new TypeError("Encoding config must be an object.");if(!X.includes(e.codec))throw new TypeError(`Invalid video codec '${e.codec}'. Must be one of: ${X.join(", ")}.`);if(!(e.bitrate instanceof Ye)&&(!Number.isInteger(e.bitrate)||e.bitrate<=0))throw new TypeError("config.bitrate must be a positive integer or a quality.");if(void 0!==e.keyFrameInterval&&(!Number.isFinite(e.keyFrameInterval)||e.keyFrameInterval<0))throw new TypeError("config.keyFrameInterval, when provided, must be a non-negative number.");if(void 0!==e.sizeChangeBehavior&&!["deny","passThrough","fill","contain","cover"].includes(e.sizeChangeBehavior))throw new TypeError("config.sizeChangeBehavior, when provided, must be 'deny', 'passThrough', 'fill', 'contain' or 'cover'.");if(void 0!==e.onEncodedPacket&&"function"!=typeof e.onEncodedPacket)throw new TypeError("config.onEncodedChunk, when provided, must be a function.");if(void 0!==e.onEncoderConfig&&"function"!=typeof e.onEncoderConfig)throw new TypeError("config.onEncoderConfig, when provided, must be a function.");Je(e.codec,e)})(t),super(t.codec),this._encoder=new nt(this,t),this._canvas=e}add(e,t=0,o){if(!Number.isFinite(e)||e<0)throw new TypeError("timestamp must be a non-negative number.");if(!Number.isFinite(t)||t<0)throw new TypeError("duration must be a non-negative number.");const i=new ke(this._canvas,{timestamp:e,duration:t});return this._encoder.add(i,!0,o)}_flushAndClose(e){return this._encoder.flushAndClose(e)}}class st extends ot{constructor(e){if(super(),this._connectedTrack=null,!ee.includes(e))throw new TypeError(`Invalid audio codec '${e}'. Must be one of: ${ee.join(", ")}.`);this._codec=e}}class lt extends ot{constructor(e){if(super(),this._connectedTrack=null,!te.includes(e))throw new TypeError(`Invalid subtitle codec '${e}'. Must be one of: ${te.join(", ")}.`);this._codec=e}}
/*!
   * Copyright (c) 2025-present, Vanilagy and contributors
   *
   * This Source Code Form is subject to the terms of the Mozilla Public
   * License, v. 2.0. If a copy of the MPL was not distributed with this
   * file, You can obtain one at https://mozilla.org/MPL/2.0/.
   */const ct=["video","audio","subtitle"],dt=e=>{if(!e||"object"!=typeof e)throw new TypeError("metadata must be an object.");if(void 0!==e.languageCode&&(t=e.languageCode,!V.test(t)))throw new TypeError("metadata.languageCode, when provided, must be a three-letter, ISO 639-2/T language code.");var t;if(void 0!==e.name&&"string"!=typeof e.name)throw new TypeError("metadata.name, when provided, must be a string.");if(void 0!==e.maximumPacketCount&&(!Number.isInteger(e.maximumPacketCount)||e.maximumPacketCount<0))throw new TypeError("metadata.maximumPacketCount, when provided, must be a non-negative integer.")};class pt{constructor(e){if(this.state="pending",this._tracks=[],this._startPromise=null,this._cancelPromise=null,this._finalizePromise=null,this._mutex=new q,this._metadataTags={},!e||"object"!=typeof e)throw new TypeError("options must be an object.");if(!(e.format instanceof Ke))throw new TypeError("options.format must be an OutputFormat.");if(!(e.target instanceof He))throw new TypeError("options.target must be a Target.");if(e.target._output)throw new Error("Target is already used for another output.");e.target._output=this,this.format=e.format,this.target=e.target,this._writer=e.target._createWriter(),this._muxer=e.format._createMuxer(this)}addVideoTrack(e,t={}){if(!(e instanceof it))throw new TypeError("source must be a VideoSource.");if(dt(t),void 0!==t.rotation&&![0,90,180,270].includes(t.rotation))throw new TypeError(`Invalid video rotation: ${t.rotation}. Has to be 0, 90, 180 or 270.`);if(!this.format.supportsVideoRotationMetadata&&t.rotation)throw new Error(`${this.format._name} does not support video rotation metadata.`);if(void 0!==t.frameRate&&(!Number.isFinite(t.frameRate)||t.frameRate<=0))throw new TypeError(`Invalid video frame rate: ${t.frameRate}. Must be a positive number.`);this._addTrack("video",e,t)}addAudioTrack(e,t={}){if(!(e instanceof st))throw new TypeError("source must be an AudioSource.");dt(t),this._addTrack("audio",e,t)}addSubtitleTrack(e,t={}){if(!(e instanceof lt))throw new TypeError("source must be a SubtitleSource.");dt(t),this._addTrack("subtitle",e,t)}setMetadataTags(e){if((e=>{if(!e||"object"!=typeof e)throw new TypeError("tags must be an object.");if(void 0!==e.title&&"string"!=typeof e.title)throw new TypeError("tags.title, when provided, must be a string.");if(void 0!==e.description&&"string"!=typeof e.description)throw new TypeError("tags.description, when provided, must be a string.");if(void 0!==e.artist&&"string"!=typeof e.artist)throw new TypeError("tags.artist, when provided, must be a string.");if(void 0!==e.album&&"string"!=typeof e.album)throw new TypeError("tags.album, when provided, must be a string.");if(void 0!==e.albumArtist&&"string"!=typeof e.albumArtist)throw new TypeError("tags.albumArtist, when provided, must be a string.");if(void 0!==e.trackNumber&&(!Number.isInteger(e.trackNumber)||e.trackNumber<=0))throw new TypeError("tags.trackNumber, when provided, must be a positive integer.");if(void 0!==e.tracksTotal&&(!Number.isInteger(e.tracksTotal)||e.tracksTotal<=0))throw new TypeError("tags.tracksTotal, when provided, must be a positive integer.");if(void 0!==e.discNumber&&(!Number.isInteger(e.discNumber)||e.discNumber<=0))throw new TypeError("tags.discNumber, when provided, must be a positive integer.");if(void 0!==e.discsTotal&&(!Number.isInteger(e.discsTotal)||e.discsTotal<=0))throw new TypeError("tags.discsTotal, when provided, must be a positive integer.");if(void 0!==e.genre&&"string"!=typeof e.genre)throw new TypeError("tags.genre, when provided, must be a string.");if(void 0!==e.date&&(!(e.date instanceof Date)||Number.isNaN(e.date.getTime())))throw new TypeError("tags.date, when provided, must be a valid Date.");if(void 0!==e.lyrics&&"string"!=typeof e.lyrics)throw new TypeError("tags.lyrics, when provided, must be a string.");if(void 0!==e.images){if(!Array.isArray(e.images))throw new TypeError("tags.images, when provided, must be an array.");for(const t of e.images){if(!t||"object"!=typeof t)throw new TypeError("Each image in tags.images must be an object.");if(!(t.data instanceof Uint8Array))throw new TypeError("Each image.data must be a Uint8Array.");if("string"!=typeof t.mimeType)throw new TypeError("Each image.mimeType must be a string.");if(!["coverFront","coverBack","unknown"].includes(t.kind))throw new TypeError("Each image.kind must be 'coverFront', 'coverBack', or 'unknown'.")}}if(void 0!==e.comment&&"string"!=typeof e.comment)throw new TypeError("tags.comment, when provided, must be a string.");if(void 0!==e.raw){if(!e.raw||"object"!=typeof e.raw)throw new TypeError("tags.raw, when provided, must be an object.");for(const t of Object.values(e.raw))if(!(null===t||"string"==typeof t||t instanceof Uint8Array||t instanceof K||t instanceof Q))throw new TypeError("Each value in tags.raw must be a string, Uint8Array, RichImageData, AttachedFile, or null.")}})(e),"pending"!==this.state)throw new Error("Cannot set metadata tags after output has been started or canceled.");this._metadataTags=e}_addTrack(e,t,o){if("pending"!==this.state)throw new Error("Cannot add track after output has been started or canceled.");if(t._connectedTrack)throw new Error("Source is already used for a track.");const i=this.format.getSupportedTrackCounts(),n=this._tracks.reduce((t,o)=>t+(o.type===e?1:0),0),r=i[e].max;if(n===r)throw new Error(0===r?`${this.format._name} does not support ${e} tracks.`:`${this.format._name} does not support more than ${r} ${e} track`+(1===r?"":"s")+".");const a=i.total.max;if(this._tracks.length===a)throw new Error(`${this.format._name} does not support more than ${a} tracks`+(1===a?"":"s")+" in total.");const s={id:this._tracks.length+1,output:this,type:e,source:t,metadata:o};if("video"===s.type){const e=this.format.getSupportedVideoCodecs();if(0===e.length)throw new Error(`${this.format._name} does not support video tracks.`+this.format._codecUnsupportedHint(s.source._codec));if(!e.includes(s.source._codec))throw new Error(`Codec '${s.source._codec}' cannot be contained within ${this.format._name}. Supported video codecs are: ${e.map(e=>`'${e}'`).join(", ")}.`+this.format._codecUnsupportedHint(s.source._codec))}else if("audio"===s.type){const e=this.format.getSupportedAudioCodecs();if(0===e.length)throw new Error(`${this.format._name} does not support audio tracks.`+this.format._codecUnsupportedHint(s.source._codec));if(!e.includes(s.source._codec))throw new Error(`Codec '${s.source._codec}' cannot be contained within ${this.format._name}. Supported audio codecs are: ${e.map(e=>`'${e}'`).join(", ")}.`+this.format._codecUnsupportedHint(s.source._codec))}else if("subtitle"===s.type){const e=this.format.getSupportedSubtitleCodecs();if(0===e.length)throw new Error(`${this.format._name} does not support subtitle tracks.`+this.format._codecUnsupportedHint(s.source._codec));if(!e.includes(s.source._codec))throw new Error(`Codec '${s.source._codec}' cannot be contained within ${this.format._name}. Supported subtitle codecs are: ${e.map(e=>`'${e}'`).join(", ")}.`+this.format._codecUnsupportedHint(s.source._codec))}this._tracks.push(s),t._connectedTrack=s}async start(){const e=this.format.getSupportedTrackCounts();for(const t of ct){const o=this._tracks.reduce((e,o)=>e+(o.type===t?1:0),0),i=e[t].min;if(o<i)throw new Error(i===e[t].max?`${this.format._name} requires exactly ${i} ${t} track${1===i?"":"s"}.`:`${this.format._name} requires at least ${i} ${t} track${1===i?"":"s"}.`)}const t=e.total.min;if(this._tracks.length<t)throw new Error(t===e.total.max?`${this.format._name} requires exactly ${t} track`+(1===t?"":"s")+".":`${this.format._name} requires at least ${t} track`+(1===t?"":"s")+".");if("canceled"===this.state)throw new Error("Output has been canceled.");return this._startPromise?(console.warn("Output has already been started."),this._startPromise):this._startPromise=(async()=>{this.state="started",this._writer.start();const e=await this._mutex.acquire();await this._muxer.start();const t=this._tracks.map(e=>e.source._start());await Promise.all(t),e()})()}getMimeType(){return this._muxer.getMimeType()}async cancel(){return this._cancelPromise?(console.warn("Output has already been canceled."),this._cancelPromise):"finalizing"!==this.state&&"finalized"!==this.state?this._cancelPromise=(async()=>{this.state="canceled";const e=await this._mutex.acquire(),t=this._tracks.map(e=>e.source._flushOrWaitForOngoingClose(!0));await Promise.all(t),await this._writer.close(),e()})():void console.warn("Output has already been finalized.")}async finalize(){if("pending"===this.state)throw new Error("Cannot finalize before starting.");if("canceled"===this.state)throw new Error("Cannot finalize after canceling.");return this._finalizePromise?(console.warn("Output has already been finalized."),this._finalizePromise):this._finalizePromise=(async()=>{this.state="finalizing";const e=await this._mutex.acquire(),t=this._tracks.map(e=>e.source._flushOrWaitForOngoingClose(!1));await Promise.all(t),await this._muxer.finalize(),await this._writer.flush(),await this._writer.finalize(),this.state="finalized",e()})()}}class ht{constructor(){this.output=null,this.canvasSource=null,this.canvas=null,this.ctx=null,this.frameCount=0,this.frameDuration=0,this.currentTimestamp=0,this.isFinalized=!1,this.isStarted=!1}static isSupported(){return"undefined"!=typeof VideoEncoder&&"undefined"!=typeof VideoFrame}async create(e){const{width:t,height:o,fps:i,bitrate:n,quality:r="high",latencyMode:a="quality",bitrateMode:s="variable",keyFrameInterval:l=120,contentHint:c=""}=e;if(!ht.isSupported())throw new Error("WebCodecs API not supported in this browser.");let d;console.log("[WebCodecs VP9] Initializing with:",{width:t,height:o,fps:i,bitrate:`${n} kbps`,quality:r,latencyMode:a,bitrateMode:s,keyFrameInterval:l,contentHint:c||"auto",codec:"VP9",api:"WebCodecs + Mediabunny"}),this.frameDuration=1/i,this.keyFrameInterval=l,this.framesSinceKeyframe=0,this.canvas=document.createElement("canvas"),this.canvas.width=t,this.canvas.height=o,this.ctx=this.canvas.getContext("2d",{willReadFrequently:!1,alpha:!1}),this.output=new pt({format:new Xe,target:new Oe}),"very-high"===r?(d=tt,console.log("[WebCodecs VP9] Quality: VERY_HIGH")):"medium"===r?(d=et,console.log("[WebCodecs VP9] Quality: MEDIUM (using HIGH)")):(d=et,console.log("[WebCodecs VP9] Quality: HIGH"));const p={codec:"vp9",bitrate:d,latencyMode:a,bitrateMode:s,keyFrameInterval:l};return c&&(p.contentHint=c),console.log("[WebCodecs VP9] Canvas config:",p),this.canvasSource=new at(this.canvas,p),this.output.addVideoTrack(this.canvasSource),await this.output.start(),this.isStarted=!0,console.log("[WebCodecs VP9] Initialization complete, ready to receive frames"),this}async addFrame(e){if(this.isFinalized)throw new Error("Cannot add frames after finalization");if(!this.isStarted)throw new Error("Encoder not started - call create() first");if(!this.canvas||!this.ctx)throw new Error("Canvas not initialized - call create() first");this.frameCount++,this.frameCount%30==0&&console.log(`[WebCodecs VP9] Encoding frame ${this.frameCount}`),1===this.frameCount&&console.log(`[WebCodecs VP9] First frame - buffer size: ${e.byteLength} bytes`);const t=new ImageData(new Uint8ClampedArray(e.buffer||e),this.canvas.width,this.canvas.height);this.ctx.putImageData(t,0,0),await this.canvasSource.add(this.currentTimestamp,this.frameDuration),this.currentTimestamp+=this.frameDuration}async end(){if(this.isFinalized)throw new Error("Encoder already finalized");console.log(`[WebCodecs VP9] Finalizing encoding (${this.frameCount} total frames, ${this.currentTimestamp.toFixed(2)}s duration)`),this.isFinalized=!0;try{await this.output.finalize();const e=this.output.target.buffer;if(!e)throw new Error("No video buffer produced");return console.log(`[WebCodecs VP9] Successfully finalized video: ${e.byteLength} bytes`),e}catch(e){throw console.error("[WebCodecs VP9] Finalization error:",e),new Error(`WebCodecs VP9 encoding failed: ${e.message||e}`)}}destroy(){console.log("[WebCodecs VP9] Destroying encoder"),this.canvasSource&&(this.canvasSource=null),this.output&&(this.output=null),this.canvas&&(this.canvas=null),this.ctx=null,this.frameCount=0,this.currentTimestamp=0,this.frameDuration=0,this.isFinalized=!1,this.isStarted=!1}}var ut=Object.freeze({__proto__:null,WebCodecsVP9Encoder:ht});return T}();"undefined"!=typeof window&&window.maplibregl&&(window.maplibregl.VideoExportControl=VideoExportControl);
//# sourceMappingURL=maplibre-gl-video-export.min.js.map
